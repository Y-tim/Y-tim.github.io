<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>消息模型Pulsar</title>
    <url>/2021/12/14/Apach%20Pulsar%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B/</url>
    <content><![CDATA[<h1 id="消息模型Pulsar"><a href="#消息模型Pulsar" class="headerlink" title="消息模型Pulsar"></a>消息模型Pulsar</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>​    当用户选择一个消息系统的时候，消息模型是用户第一个要考虑的事情，不论是一个什么系统，他都需要提前选定一个框架，对我来说就是一个模型，有了模型之后，就能生产产品了，照着它的样子做成自己的东西，其实我们所做的任何东西都是有最初使的模型的。</p>
<p>​    那么对于消息模型，我们就应该考虑消息最重要的内容，就像人必须有内脏一样：</p>
<ul>
<li>消息消费：我们需要确定如何发送和消费消息</li>
<li>消息确认（ack）：如何确认消息</li>
<li>消息保存：消息保存多长时间，以及消息通过什么方式触发某些操作，例如删除。</li>
</ul>
<h2 id="消息消费模型"><a href="#消息消费模型" class="headerlink" title="消息消费模型"></a>消息消费模型</h2><p>​    消息消费分为两种：一个是队列（Queue）、另一个是流</p>
<ul>
<li><p>队列（无需，通常与无状态应用结合、可以创建多个消费者<code>一个队列一个队列的传可以分开</code>）</p>
<ul>
<li>RabbitMQ</li>
<li>RocketMQ</li>
</ul>
</li>
<li><p>流（有序，通常与有状态应用结合，始终只会有一个消费者<code>水流不能切断，如果多个消费者切换，这过程水流可能会丢失</code>）</p>
</li>
</ul>
]]></content>
      <categories>
        <category>BigData</category>
        <category>消息模型Pulsar</category>
      </categories>
      <tags>
        <tag>Pulsar</tag>
        <tag>BigData</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL杂记</title>
    <url>/2021/12/23/MySQL%E6%9D%82%E8%AE%B0/</url>
    <content><![CDATA[<h1 id="MySQL杂记"><a href="#MySQL杂记" class="headerlink" title="MySQL杂记"></a>MySQL杂记</h1><p>1、MySQL中的update不能出现在子查询语句中</p>
<p>2、更新binlog日志</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">update table_name set version = version+1 where ....;</span><br></pre></td></tr></table></figure>

<p>3、hive中收集函数为：collect_set()、collect_list()</p>
<p>​            - mysql中的收集元素的函数为：group_concat(column_name)</p>
<p>4、拼接函数：concat_ws(‘分隔符’,元素)，concat(元素，‘分隔符’，元素)</p>
]]></content>
      <categories>
        <category>BigData</category>
        <category>MySQL杂记</category>
      </categories>
      <tags>
        <tag>MySql</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2021/12/11/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
      <categories>
        <category>父目录</category>
        <category>子目录一</category>
        <category>子目录二</category>
      </categories>
      <tags>
        <tag>标签一</tag>
        <tag>标签二</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo+github博客搭建</title>
    <url>/2021/12/11/hexo+github%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<h1 id="hexo-github个人博客搭建"><a href="#hexo-github个人博客搭建" class="headerlink" title="hexo+github个人博客搭建"></a>hexo+github个人博客搭建</h1><h2 id="一、需要用到的网站"><a href="#一、需要用到的网站" class="headerlink" title="一、需要用到的网站"></a>一、需要用到的网站</h2><p>Git <a href="https://git-scm.com/downloads">官网</a></p>
<p>Hexo <a href="https://hexo.io/zh-cn/">官网</a></p>
<p>Node.js <a href="https://nodejs.org/zh-cn/">官网</a></p>
<p>GIthub <a href="https://github.com/">官网</a></p>
<h2 id="二、环境安装教程"><a href="#二、环境安装教程" class="headerlink" title="二、环境安装教程"></a>二、环境安装教程</h2><h3 id="Git安装"><a href="#Git安装" class="headerlink" title="Git安装"></a>Git安装</h3><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">进入官网选择自己的电脑系统下载，默认安装即可</span><br></pre></td></tr></table></figure>

<p>Git安装完成验证</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1、配置自己的环境变量，将bin目录添加到电脑的path环境中</span><br><span class="line">2、然后win + r 进入cmd</span><br><span class="line">3、输入git version</span><br><span class="line">==</span><br><span class="line">出现git版本号就代表安装成功</span><br></pre></td></tr></table></figure>



<h3 id="Nodes-js安装"><a href="#Nodes-js安装" class="headerlink" title="Nodes.js安装"></a>Nodes.js安装</h3><p><img src="https://s2.loli.net/2021/12/10/EXf81gkwGjUPoty.png" alt="image-20211210093940263"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">1、根据自己的电脑系统及位数选择安装格式</span><br><span class="line">==</span><br><span class="line">	.msi是windows installer开发出来的程序安装文件，也就是把所有相关文件封装在一个包里。</span><br><span class="line">	.zip是一个压缩包，解压即可，无需安装</span><br><span class="line">==</span><br><span class="line">2、我选择的是.msi格式的文件，默认一直下一步，过程中可以自定义安装路径，默认安装位置在c盘的program files下。</span><br><span class="line">3、选择.msi格式安装的话会默认添加环境变量，在cmd中输入node -v查看版本，如果有版本显示说明安装成功，没有的话手动添加环境变量到path。</span><br><span class="line">4、新版的node也会安装npm，在cmd中输入npm -v查看版本。</span><br><span class="line">5、以上过程都能正常显示，说明node.js安装成功</span><br></pre></td></tr></table></figure>

<p>安装完成的目录</p>
<p><img src="https://s2.loli.net/2021/12/10/fZhcpSeUKTBvtVQ.png" alt="image-20211210094622770"></p>
<h2 id="三、博客系统安装"><a href="#三、博客系统安装" class="headerlink" title="三、博客系统安装"></a>三、博客系统安装</h2><p>1、选择一个盘符，我选择的是E盘，然后创建一个文件夹，名字自己定义，我的是E：\blog，然后进入blog文件夹，右键选择Git Bash Here</p>
<p><img src="https://s2.loli.net/2021/12/10/brU3CDsEhWei5jg.png" alt="image-20211210095918382"></p>
<p>2、根据hexo官网首页的命令安装hexo</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-cli -g</span><br></pre></td></tr></table></figure>

<p>3、安装完成之后，输入命令查看版本信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ hexo -v</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2021/12/10/UXHt3KdgPTRkVu6.png" alt="image-20211210100353870"></p>
<p>4、输入hexo init 等待初始化</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ hexo init</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2021/12/10/ZHtwr8EuIxVS4qj.png" alt="image-20211210100514812"></p>
<p><img src="https://s2.loli.net/2021/12/10/1Qs25NfRbMxSkLC.png" alt="image-20211210100536305"></p>
<p>5、然后输入命令hexo generate或者缩写hexo g生成html页面</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ hexo g</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2021/12/10/EigSv1PbHI3nkBG.png" alt="image-20211210100821970"></p>
<ul>
<li>然后就会出现一个新的文件public，里面包含了hexo生成的html，css，json之类的东西</li>
</ul>
<p><img src="https://s2.loli.net/2021/12/10/KNFWsv2EpCeLHSj.png" alt="image-20211210100947245"></p>
<p>6、使用命令hexo server 和缩写成hexo s启动服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ hexo s</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2021/12/10/b1MkjRucWZLGJKa.png" alt="image-20211210101050232"></p>
<p>7、以上就是按照默认的方式生成好了个人博客，根据上面的地址访问</p>
<p><img src="https://s2.loli.net/2021/12/10/fz5nqeok3il98K4.png" alt="image-20211210101210965"></p>
<h2 id="四、安装其他主题"><a href="#四、安装其他主题" class="headerlink" title="四、安装其他主题"></a>四、安装其他主题</h2><ul>
<li>我是根据大佬的安装方式实现主题的切换。在此感谢大佬！！！<a href="https://shen-yu.gitee.io/2019/ayer/">点击这里</a>进入安装说明（<strong>我采用的是第二种方式，直接git clone主题所在的网址即可，这样我更方便管理我的主题内容和更换自己的布局</strong>）</li>
</ul>
<h2 id="五、文章创作测试"><a href="#五、文章创作测试" class="headerlink" title="五、文章创作测试"></a>五、文章创作测试</h2><p><img src="https://s2.loli.net/2021/12/10/pl7HfEyu8S6QgqL.png" alt="image-20211210102705051"></p>
<p>1、以上为侧边栏内容，该内容对应的是个人博客目录的source中的内容，以下是我直接克隆下来的东西，切换主题只需要将blog目录下的_config.yml文件中的Themes下的主题名字修改成我们的目标主题，这里我的主题是ayer，目录对应在下面的source中。</p>
<p><img src="https://s2.loli.net/2021/12/11/mVDnrHXUIKgPd2f.png" alt="image-20211211171115622"></p>
<p><img src="https://s2.loli.net/2021/12/10/WenQZGm9c6ExJX5.png" alt="image-20211210103056519"></p>
<p>2、以上目录中的__posts是安装主题之后就已经存在的，下面的分类，标签，后面可能还有别的，都是在git命令行执行命令产生的，然后在生成的文件夹下面创建index.md文件，按照下图配置，完成之后就不用管了</p>
<p><img src="https://s2.loli.net/2021/12/10/x43yiWYORzhnobP.png" alt="image-20211210103447077"></p>
<p>3、回到source目录中，进入_posts目录中开始创作文章</p>
<ul>
<li>创建XXX.md文件，第一步顶部编辑模板内容==要想在侧边栏查看除了主页和归档的内容外，必须要先配置侧边栏的内容==</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: Hello</span><br><span class="line">categories: &quot;归档测试&quot;</span><br><span class="line">tags: &quot;标签测试&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<ul>
<li>title：侧边栏归档中显示的名称</li>
<li>categories：侧边栏分类中显示的名称</li>
<li>tags：侧边栏标签中显示的名称</li>
</ul>
<p><img src="https://s2.loli.net/2021/12/10/ku19YJR3fWQxvcd.png" alt="image-20211210104637132"></p>
<p><img src="https://s2.loli.net/2021/12/10/8CDvygtwjpJ1nim.png" alt="image-20211210105146894"></p>
<p>4、完成以上操作之后,在根目录中进入git界面，输入命令开始部署</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ hexo clean </span><br><span class="line">$ hexo g </span><br><span class="line">$ hexo d</span><br></pre></td></tr></table></figure>



<h2 id="六、个人博客部署到Github"><a href="#六、个人博客部署到Github" class="headerlink" title="六、个人博客部署到Github"></a>六、个人博客部署到Github</h2><p>1、登录到Github中新建一个仓库，仓库名称必须为==Github用户名==.github.io</p>
<p><strong>例如</strong></p>
<p>我的用户名是：Y-tim</p>
<p>那么我的仓库名字为：Y-tim.github.io</p>
<p>==点击创建，其他就不用管了==</p>
<p><img src="https://s2.loli.net/2021/12/10/UBipgOjZenGdwHW.png" alt="image-20211210110518004"></p>
<p>2、回到自己的Git控制台中，配置Github账户信息，（其中==用户名==和==邮箱==都替换成你自己的注测Github的）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git config --global user.name &quot;用户名&quot;</span><br><span class="line">$ git config --global user.email &quot;邮箱&quot;</span><br></pre></td></tr></table></figure>



<p>3、生成ssh公钥和秘钥(==为了部署的时候不需要每次都输入账号密码==)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ssh-keygen -t rsa -C &quot;你的Github邮箱&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>执行完毕之后，生成的秘钥在c盘中的用户里面，有一个.ssh目录，将里面的<code>id_rsa.pub</code>文件内容复制</li>
<li>进入到你创建好的仓库中，点击setting–》Deploy Key—》Add new，完成粘贴并保存。</li>
</ul>
<p><img src="https://s2.loli.net/2021/12/10/XOe6utqS5yl9zYb.png" alt="image-20211210111424186"></p>
<p>4、再回到blog根目录下面，在==_config.yml==文件里面搜索deploy所在的位置，一般在最底部，添加配置条件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line"> type: git</span><br><span class="line"> repo: git@github.com:Y-tim/Y-tim.github.io.git</span><br><span class="line"> branch: main</span><br></pre></td></tr></table></figure>

<ul>
<li>==因为是yml文件，所以格式很敏感，type后面有空格，其他也一样==</li>
<li>type： git –》因为是github所以这里是git</li>
<li>repo：就是平时克隆项目的位置，随便复制一个地址都可以</li>
<li>branch： 这是上传到项目中的分支，==分支最好是该项目的默认分支，main或者master都可以== </li>
</ul>
<p><img src="https://s2.loli.net/2021/12/10/28HhbEwAOKkZoMV.png" alt="image-20211210111843817"></p>
<p><img src="https://s2.loli.net/2021/12/10/xr1hbpcMjZI8To4.png" alt="image-20211210112609385"></p>
<p>5、回到git控制台，安装一键部署工具</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>

<p>6、然后执行以下命令完成最终部署</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ hexo clean                            #清除缓存       可缩写hexo c</span><br><span class="line">$ hexo generate                         #生成静态文件    可缩写hexo g</span><br><span class="line">$ hexo deploy                           #部署到Github   可缩写hexo d</span><br></pre></td></tr></table></figure>

<p>==可以使用脚本进行一键双击部署以及更新==</p>
<p>编写==自定义名称.sh== 的脚本：保存在方便点击的地方，当编辑完文章保存之后，直接双击该脚本就行，它会自动完成部署</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># deploy_hexo.sh</span></span><br><span class="line"><span class="built_in">cd</span> /e/logan_test/blog</span><br><span class="line"><span class="built_in">pwd</span></span><br><span class="line"><span class="comment"># 白底黑字效果</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[47;30m&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;hexo clean&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;\033[0m&quot;</span></span><br><span class="line">hexo clean</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[47;30m&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;hexo g&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;\033[0m&quot;</span></span><br><span class="line">hexo g</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[47;30m&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;hexo d&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;\033[0m&quot;</span></span><br><span class="line">hexo d</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[47;30m&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;Successful！！！&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;\033[0m&quot;</span></span><br><span class="line">sleep 5</span><br><span class="line"><span class="comment"># 执行完毕不退出</span></span><br><span class="line"><span class="comment"># exec /bin/bash</span></span><br></pre></td></tr></table></figure>

<p>==点击运行的效果==</p>
<p><img src="https://s2.loli.net/2021/12/10/cuDS9IUQTegkaxB.png" alt="image-20211210235820463"></p>
<p>7、项目部署到github之后，回到Github中，点击setting—》pages，选择分支，根目录，点击save</p>
<p><img src="https://s2.loli.net/2021/12/10/ML8FYia1NJwcEDg.png" alt="image-20211210113113809"></p>
<p>8、访问 <a href="https://y-tim.github.io/">https://y-tim.github.io/</a></p>
<p><img src="https://s2.loli.net/2021/12/10/86dZP7TCfmunXob.png" alt="image-20211210113255351"></p>
<p>==剩下的界面优化，只需要在该主题的配置文件中修改即可==</p>
<p><strong>主题配置文件在你克隆下来的根目录下</strong>：==__config.yml==</p>
<h2 id="七、Github绑定域名"><a href="#七、Github绑定域名" class="headerlink" title="七、Github绑定域名"></a>七、Github绑定域名</h2><h3 id="作用："><a href="#作用：" class="headerlink" title="作用："></a>作用：</h3><p>​    将自己购买的域名，通过实名认证和解析dns之后即可实现使用域名访问我们在Github上面部署的个人博客。</p>
<h3 id="绑定步骤："><a href="#绑定步骤：" class="headerlink" title="绑定步骤："></a>绑定步骤：</h3><p>1、在域名服务当中你可以看到自己购买的域名，购买完成之后是需要实名的，根据向导一步一步操作即可。</p>
<p><img src="https://s2.loli.net/2021/12/10/Nv1dpFjYBxay4IU.png" alt="image-20211210233141000"></p>
<p>2、在域名的后面有一个解析，点击解析进入到域名解析界面</p>
<p><img src="https://s2.loli.net/2021/12/10/zl61VeUydskJRr9.png" alt="image-20211210233225710"></p>
<p><img src="https://s2.loli.net/2021/12/10/7xvD1pqMdburKEV.png" alt="image-20211210233318982"></p>
<p>3、点击添加记录，然后配置域名指向，主机记录（这个意思是输入url的时候前面加上www.）,解析路线默认，记录值为你GIthub博客地址，我的是y-tim.github.io.</p>
<p><img src="https://s2.loli.net/2021/12/10/SGROw8Btcq4bFpm.png" alt="image-20211210234030600"></p>
<p>4、还要加上一个主机记录为@的，这代表不需要前缀，直接域名就能访问，例如我的：ylxlogan.top</p>
<p><img src="https://s2.loli.net/2021/12/10/qaPfG4QvgKOm8TD.png" alt="image-20211210234218799"></p>
<p>5、回到Github仓库目录中，在根目录下创建一个文件CNAME，然后在里面添加域名，我添加的是ylxlogan.top.</p>
<p><img src="https://s2.loli.net/2021/12/10/qc691rjwXafvOil.png" alt="image-20211210234518922"></p>
<p><img src="https://s2.loli.net/2021/12/10/VK4iz5MCj9LyhlP.png" alt="image-20211210234559845"></p>
<p><img src="https://s2.loli.net/2021/12/10/m6dCYP3VWXocNnE.png" alt="image-20211210234634170"></p>
<p>6、点击setting—》pages，如果创建了CNAME文件，那么这里会自动显示域名，没有的话可以手动添加，然后保存。</p>
<p><img src="https://s2.loli.net/2021/12/10/bNhCGEFP7RwrWtM.png" alt="image-20211210234833348"></p>
<p>7、等待检测，可能需要5分钟左右，当出现域名后面出现绿色的勾，说明域名绑定成功，可以使用域名访问博客了。</p>
<p><img src="https://s2.loli.net/2021/12/10/Fn78heCGPIjAmKD.png" alt="image-20211210235012093"></p>
]]></content>
      <categories>
        <category>博客</category>
        <category>hexo+github博客搭建</category>
      </categories>
      <tags>
        <tag>博客搭建</tag>
      </tags>
  </entry>
  <entry>
    <title>博客bug</title>
    <url>/2021/12/13/%E5%8D%9A%E5%AE%A2bug/</url>
    <content><![CDATA[<p>博客bug记录：</p>
<p>一、无法显示问题</p>
<p>1、关于我的页面，编辑之后无法正常显示，不清楚原因，本地调试没有问题但是部署到了github之后就无法正常显示了。经过测试并不是信息敏感的问题。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">解决：</span><br><span class="line">	重新创建关于我的文件和路径，参照tags和categories一样</span><br><span class="line">	因为部署的是github上，所以国内加载</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>博客</category>
        <category>博客bug</category>
      </categories>
      <tags>
        <tag>博客搭建</tag>
      </tags>
  </entry>
  <entry>
    <title>博客迁移</title>
    <url>/2021/12/14/%E5%8D%9A%E5%AE%A2%E8%BF%81%E7%A7%BB%E5%88%B0%E8%87%AA%E5%B7%B1%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
    <content><![CDATA[<p>博客迁移到自己的阿里云服务器</p>
<p>​    暂时没有成功，我将用在github上面的域名无法用到自己的服务器地址，导致无法访问，后续努力！</p>
]]></content>
      <categories>
        <category>博客</category>
        <category>博客迁移</category>
      </categories>
      <tags>
        <tag>博客迁移</tag>
      </tags>
  </entry>
  <entry>
    <title>博客测试</title>
    <url>/2021/12/11/%E6%B5%8B%E8%AF%95%E5%86%85%E5%AE%B9/</url>
    <content><![CDATA[<h1 id="博客测试内容"><a href="#博客测试内容" class="headerlink" title="博客测试内容"></a>博客测试内容</h1><h2 id="1、网页是否正常显示✔"><a href="#1、网页是否正常显示✔" class="headerlink" title="1、网页是否正常显示✔"></a>1、网页是否正常显示✔</h2><h2 id="2、右上角的进入我的github✔"><a href="#2、右上角的进入我的github✔" class="headerlink" title="2、右上角的进入我的github✔"></a>2、右上角的进入我的github✔</h2><h2 id="3、分类侧边栏一级分类功能✔"><a href="#3、分类侧边栏一级分类功能✔" class="headerlink" title="3、分类侧边栏一级分类功能✔"></a>3、分类侧边栏一级分类功能✔</h2><h2 id="4、分类侧边栏二级分类功能✔"><a href="#4、分类侧边栏二级分类功能✔" class="headerlink" title="4、分类侧边栏二级分类功能✔"></a>4、分类侧边栏二级分类功能✔</h2><h2 id="5、一篇文章多个标签✔"><a href="#5、一篇文章多个标签✔" class="headerlink" title="5、一篇文章多个标签✔"></a>5、一篇文章多个标签✔</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">title: Hello World</span><br><span class="line">categories:</span><br><span class="line">- [父目录一, 子目录一]</span><br><span class="line">- [父目录一, 子目录二]</span><br><span class="line">- [父目录二]</span><br><span class="line">tags: </span><br><span class="line">  - 标签一</span><br><span class="line">  - 标签二</span><br></pre></td></tr></table></figure>

<h2 id="6、网页，文章浏览量✔"><a href="#6、网页，文章浏览量✔" class="headerlink" title="6、网页，文章浏览量✔"></a>6、网页，文章浏览量✔</h2><h2 id="7、文章评论功能，以及回复功能✔"><a href="#7、文章评论功能，以及回复功能✔" class="headerlink" title="7、文章评论功能，以及回复功能✔"></a>7、文章评论功能，以及回复功能✔</h2><ul>
<li><p>第一步  </p>
<ul>
<li>进行<a href="https://console.leancloud.cn/register">注册 · LeanCloud</a><ul>
<li><img src="https://s2.loli.net/2021/12/11/JInYD3r8POcZlyw.png" alt="image-20211211185231872" style="zoom: 50%;" /></li>
</ul>
</li>
</ul>
</li>
<li><p>第二步 </p>
<ul>
<li>注册完成之后登陆，在应用当中创建应用<ul>
<li><img src="https://s2.loli.net/2021/12/11/4RPzXMc7rjoFbWG.png" alt="image-20211211185515048" style="zoom: 50%;" /></li>
<li>自定义应用名称之后，点击创建</li>
</ul>
</li>
</ul>
</li>
<li><p>第三步</p>
<ul>
<li>点击设置，选择凭证<ul>
<li><img src="https://s2.loli.net/2021/12/11/MWpz2OmLotrZRD9.png" alt="image-20211211185740100" style="zoom:67%;" /></li>
</ul>
</li>
<li>回到主题配置文件里面，找到Valine这里，按照对应id，key粘贴<ul>
<li><img src="https://s2.loli.net/2021/12/11/1Y3Kptb54nrHCwa.png" alt="image-20211211190038352" style="zoom:67%;" /></li>
</ul>
</li>
</ul>
</li>
<li><p>第四步，完成功能的实现！！！</p>
</li>
</ul>
<h2 id="8、文章视频播放（待测试）"><a href="#8、文章视频播放（待测试）" class="headerlink" title="8、文章视频播放（待测试）"></a>8、文章视频播放（<strong>待测试</strong>）</h2><h2 id="9、文章音乐播放（待测试）"><a href="#9、文章音乐播放（待测试）" class="headerlink" title="9、文章音乐播放（待测试）"></a>9、文章音乐播放（<strong>待测试</strong>）</h2><h2 id="10、全局搜索功能✔"><a href="#10、全局搜索功能✔" class="headerlink" title="10、全局搜索功能✔"></a>10、全局搜索功能✔</h2><h2 id="11、右边栏的目录不能收起，屏占比小的时候会影响内容的查看，需要修改成左边的侧边栏一样。"><a href="#11、右边栏的目录不能收起，屏占比小的时候会影响内容的查看，需要修改成左边的侧边栏一样。" class="headerlink" title="11、右边栏的目录不能收起，屏占比小的时候会影响内容的查看，需要修改成左边的侧边栏一样。"></a>11、右边栏的目录不能收起，屏占比小的时候会影响内容的查看，需要修改成左边的侧边栏一样。</h2><ul>
<li><p><strong>注意</strong>：</p>
<p>​        写文章的时候，尽量不要有特殊字符，否则搜索功能会失效</p>
</li>
</ul>
]]></content>
      <categories>
        <category>博客</category>
        <category>博客功能测试</category>
      </categories>
      <tags>
        <tag>博客功能测试</tag>
      </tags>
  </entry>
  <entry>
    <title>知识碎片</title>
    <url>/2021/12/23/%E7%9F%A5%E8%AF%86%E7%A2%8E%E7%89%87/</url>
    <content><![CDATA[<p>1、在写sparkstreaming代码出现暴内存不足的情况？</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> sparkConf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">&quot;InitData&quot;</span>)</span><br><span class="line">      .setMaster(<span class="string">&quot;local[*]&quot;</span>).set(<span class="string">&quot;spark.testing.memory&quot;</span>,<span class="string">&quot;471859200&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>2、代码中出现</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java.lang.NoClassDefFoundError: org/apache/spark/sql/SparkSession</span><br><span class="line">Error: A JNI error has occurred, please check your installation and try again</span><br><span class="line">原因：</span><br><span class="line">	pom文件中的依赖中scope填写的是provided，这是用于打包的时候防止需要的依赖一起打包导致包太大，但需要在服务器中已经有这些依赖了，否则加上这个在服务其中报没有依赖的错误，idea默认是compile，</span><br><span class="line">解决：</span><br><span class="line">	注释掉该标签</span><br></pre></td></tr></table></figure>

<p>3、通过idea代码读取hdfs数据时，可能会出现lzo压缩找不到，所以需要在core-site.xml文件中添加配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span><span class="comment">&lt;!--这个配置可以不要--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">name</span>&gt;</span>io.compression.codecs<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">           org.apache.hadoop.io.compress.GzipCodec,</span><br><span class="line">           org.apache.hadoop.io.compress.DefaultCodec,</span><br><span class="line">           org.apache.hadoop.io.compress.BZip2Codec,</span><br><span class="line">           org.apache.hadoop.io.compress.SnappyCodec</span><br><span class="line">           <span class="comment">&lt;!--com.hadoop.compression.lzo.LzoCodec,这里不能打开，否则报lzo找不到--&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--com.hadoop.compression.lzo.LzopCodec这里不能打开，否则报lzo找不到--&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">name</span>&gt;</span>io.compression.codec.lzo.class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">value</span>&gt;</span>com.hadoop.compression.lzo.LzoCodec<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4、spark中task并发和并行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">三台节点，一个2核，总共6核，</span><br><span class="line">并发度理解为同时执行的task数量。这里并发度为6；</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>碎片</category>
        <category>知识碎片</category>
      </categories>
      <tags>
        <tag>知识碎片</tag>
      </tags>
  </entry>
  <entry>
    <title>Hive中sql练习</title>
    <url>/2021/12/22/HIve%E4%B8%ADsql%E7%BB%83%E4%B9%A0/</url>
    <content><![CDATA[<h2 id="一、行列转换"><a href="#一、行列转换" class="headerlink" title="一、行列转换"></a>一、行列转换</h2><p>描述：表中记录了各年份各部门的平均绩效考核成绩。</p>
<p>表名：t1</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">表结构：</span><br><span class="line">a -- 年份</span><br><span class="line">b -- 部门</span><br><span class="line">c -- 绩效得分</span><br></pre></td></tr></table></figure>



<p>表内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> a  b c</span><br><span class="line">2014 B 9</span><br><span class="line">2015 A 8</span><br><span class="line">2014 A 10</span><br><span class="line">2015 B 7</span><br></pre></td></tr></table></figure>



<h4 id="问题一：多行转多列"><a href="#问题一：多行转多列" class="headerlink" title="问题一：多行转多列"></a>问题一：多行转多列</h4><p>问题描述：将上述表内容转为如下输出结果所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a col_A col_B</span><br><span class="line">2014 10  9</span><br><span class="line">2015 8  7</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">  a,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> <span class="keyword">when</span> b<span class="operator">=</span>&quot;A&quot; <span class="keyword">then</span> c <span class="keyword">end</span>) col_A,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> <span class="keyword">when</span> b<span class="operator">=</span>&quot;B&quot; <span class="keyword">then</span> c <span class="keyword">end</span>) col_B</span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a;</span><br></pre></td></tr></table></figure>



<h4 id="问题二：如何将结果转成源表？（多列转多行）"><a href="#问题二：如何将结果转成源表？（多列转多行）" class="headerlink" title="问题二：如何将结果转成源表？（多列转多行）"></a>问题二：如何将结果转成源表？（多列转多行）</h4><p>问题描述：将问题一的结果转成源表，问题一结果表名为t1_2。</p>
<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">  a,</span><br><span class="line">  b,</span><br><span class="line">  c</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">  <span class="keyword">select</span> a,&quot;A&quot; <span class="keyword">as</span> b,col_a <span class="keyword">as</span> c <span class="keyword">from</span> t1_2 </span><br><span class="line">  <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">  <span class="keyword">select</span> a,&quot;B&quot; <span class="keyword">as</span> b,col_b <span class="keyword">as</span> c <span class="keyword">from</span> t1_2 </span><br><span class="line">)tmp; </span><br></pre></td></tr></table></figure>



<h4 id="问题三：同一部门会有多个绩效，求多行转多列结果"><a href="#问题三：同一部门会有多个绩效，求多行转多列结果" class="headerlink" title="问题三：同一部门会有多个绩效，求多行转多列结果"></a>问题三：同一部门会有多个绩效，求多行转多列结果</h4><p>问题描述：2014年公司组织架构调整，导致部门出现多个绩效，业务及人员不同，无法合并算绩效，源表内容如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="number">2014</span> B <span class="number">9</span></span><br><span class="line"><span class="number">2015</span> A <span class="number">8</span></span><br><span class="line"><span class="number">2014</span> A <span class="number">10</span></span><br><span class="line"><span class="number">2015</span> B <span class="number">7</span></span><br><span class="line"><span class="number">2014</span> B <span class="number">6</span></span><br></pre></td></tr></table></figure>



<p>输出结果如下所示：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"> a  col_A col_B</span><br><span class="line"><span class="number">2014</span>  <span class="number">10</span>  <span class="number">6</span>,<span class="number">9</span></span><br><span class="line"><span class="number">2015</span>  <span class="number">8</span>   <span class="number">7</span></span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">  a,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> <span class="keyword">when</span> b<span class="operator">=</span>&quot;A&quot; <span class="keyword">then</span> c <span class="keyword">end</span>) col_A,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> <span class="keyword">when</span> b<span class="operator">=</span>&quot;B&quot; <span class="keyword">then</span> c <span class="keyword">end</span>) col_B</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">  <span class="keyword">select</span> </span><br><span class="line">    a,</span><br><span class="line">   b,</span><br><span class="line">    concat_ws(&quot;,&quot;,collect_set(<span class="built_in">cast</span>(c <span class="keyword">as</span> string))) <span class="keyword">as</span> c</span><br><span class="line">  <span class="keyword">from</span> t1</span><br><span class="line">  <span class="keyword">group</span> <span class="keyword">by</span> a,b</span><br><span class="line">)tmp</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a;</span><br></pre></td></tr></table></figure>



<h2 id="二、排名中取他值"><a href="#二、排名中取他值" class="headerlink" title="二、排名中取他值"></a>二、排名中取他值</h2><p>表名：t2</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a  b  c</span><br><span class="line">2014 A 3</span><br><span class="line">2014 B  1</span><br><span class="line">2014 C  2</span><br><span class="line">2015 A  4</span><br><span class="line">2015 D  3</span><br></pre></td></tr></table></figure>



<h4 id="问题一：按a分组取b字段最小时对应的c字段"><a href="#问题一：按a分组取b字段最小时对应的c字段" class="headerlink" title="问题一：按a分组取b字段最小时对应的c字段"></a>问题一：按a分组取b字段最小时对应的c字段</h4><p>输出结果如下所示：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">a  min_c</span><br><span class="line"><span class="number">2014</span> <span class="number">3</span></span><br><span class="line"><span class="number">2015</span> <span class="number">4</span></span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select a,</span><br><span class="line">		c as min_cfrom(  </span><br><span class="line">            select  a,  </span><br><span class="line">            		b,  </span><br><span class="line">            		c,   </span><br><span class="line">            		row_number() over(partition by a order by b) as rn </span><br><span class="line">            from t2 )a </span><br><span class="line">where rn = 1;</span><br></pre></td></tr></table></figure>



<h4 id="问题二：按a分组取b字段排第二时对应的c字段"><a href="#问题二：按a分组取b字段排第二时对应的c字段" class="headerlink" title="问题二：按a分组取b字段排第二时对应的c字段"></a>问题二：按a分组取b字段排第二时对应的c字段</h4><p>输出结果如下所示：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">a second_c</span><br><span class="line"><span class="number">2014</span> <span class="number">1</span></span><br><span class="line"><span class="number">2015</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a, c <span class="keyword">AS</span> second_c</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, b, c, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> b) <span class="keyword">AS</span> rn</span><br><span class="line">	<span class="keyword">FROM</span> t2</span><br><span class="line">) a</span><br><span class="line"><span class="keyword">WHERE</span> rn <span class="operator">=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>



<h4 id="问题三：按a分组取b字段最小和最大时对应的c字段"><a href="#问题三：按a分组取b字段最小和最大时对应的c字段" class="headerlink" title="问题三：按a分组取b字段最小和最大时对应的c字段"></a>问题三：按a分组取b字段最小和最大时对应的c字段</h4><p>输出结果如下所示：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">a  min_c max_c</span><br><span class="line"><span class="number">2014</span> <span class="number">3</span>   <span class="number">2</span></span><br><span class="line"><span class="number">2015</span> <span class="number">4</span>   <span class="number">3</span></span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a</span><br><span class="line">	, <span class="built_in">min</span>(if(asc_rn <span class="operator">=</span> <span class="number">1</span>, c, <span class="keyword">NULL</span>)) <span class="keyword">AS</span> min_c</span><br><span class="line">	, <span class="built_in">max</span>(if(desc_rn <span class="operator">=</span> <span class="number">1</span>, c, <span class="keyword">NULL</span>)) <span class="keyword">AS</span> max_c</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, b, c, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> b) <span class="keyword">AS</span> asc_rn</span><br><span class="line">		, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> b <span class="keyword">DESC</span>) <span class="keyword">AS</span> desc_rn</span><br><span class="line">	<span class="keyword">FROM</span> t2</span><br><span class="line">) a</span><br><span class="line"><span class="keyword">WHERE</span> asc_rn <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">	<span class="keyword">OR</span> desc_rn <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a;</span><br></pre></td></tr></table></figure>



<h4 id="问题四：按a分组取b字段第二小和第二大时对应的c字段"><a href="#问题四：按a分组取b字段第二小和第二大时对应的c字段" class="headerlink" title="问题四：按a分组取b字段第二小和第二大时对应的c字段"></a>问题四：按a分组取b字段第二小和第二大时对应的c字段</h4><p>输出结果如下所示：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">a  min_c max_c</span><br><span class="line"><span class="number">2014</span> <span class="number">1</span>   <span class="number">1</span></span><br><span class="line"><span class="number">2015</span> <span class="number">3</span>   <span class="number">4</span></span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ret.a</span><br><span class="line">	, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">		<span class="keyword">WHEN</span> ret.rn_min <span class="operator">=</span> <span class="number">2</span> <span class="keyword">THEN</span> ret.c</span><br><span class="line">		<span class="keyword">ELSE</span> <span class="keyword">NULL</span></span><br><span class="line">	<span class="keyword">END</span>) <span class="keyword">AS</span> min_c</span><br><span class="line">	, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">		<span class="keyword">WHEN</span> ret.rn_max <span class="operator">=</span> <span class="number">2</span> <span class="keyword">THEN</span> ret.c</span><br><span class="line">		<span class="keyword">ELSE</span> <span class="keyword">NULL</span></span><br><span class="line">	<span class="keyword">END</span>) <span class="keyword">AS</span> max_c</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="operator">*</span>, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> t2.a <span class="keyword">ORDER</span> <span class="keyword">BY</span> t2.b) <span class="keyword">AS</span> rn_min, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> t2.a <span class="keyword">ORDER</span> <span class="keyword">BY</span> t2.b <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn_max</span><br><span class="line">	<span class="keyword">FROM</span> t2</span><br><span class="line">) ret</span><br><span class="line"><span class="keyword">WHERE</span> ret.rn_min <span class="operator">=</span> <span class="number">2</span></span><br><span class="line">	<span class="keyword">OR</span> ret.rn_max <span class="operator">=</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> ret.a;</span><br></pre></td></tr></table></figure>



<h4 id="问题五：按a分组取b字段前两小和前两大时对应的c字段"><a href="#问题五：按a分组取b字段前两小和前两大时对应的c字段" class="headerlink" title="问题五：按a分组取b字段前两小和前两大时对应的c字段"></a>问题五：按a分组取b字段前两小和前两大时对应的c字段</h4><p>注意：需保持b字段最小、最大排首位</p>
<p>输出结果如下所示：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">a  min_c max_c</span><br><span class="line"><span class="number">2014</span> <span class="number">3</span>,<span class="number">1</span>   <span class="number">2</span>,<span class="number">1</span></span><br><span class="line"><span class="number">2015</span> <span class="number">4</span>,<span class="number">3</span>   <span class="number">3</span>,<span class="number">4</span></span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> tmp1.a <span class="keyword">AS</span> a, min_c, max_c</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, concat_ws(<span class="string">&#x27;,&#x27;</span>, collect_list(c)) <span class="keyword">AS</span> min_c</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> a, b, c, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> b) <span class="keyword">AS</span> asc_rn</span><br><span class="line">		<span class="keyword">FROM</span> t2</span><br><span class="line">	) a</span><br><span class="line">	<span class="keyword">WHERE</span> asc_rn <span class="operator">&lt;=</span> <span class="number">2</span></span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> a</span><br><span class="line">) tmp1</span><br><span class="line">	<span class="keyword">JOIN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> a, concat_ws(<span class="string">&#x27;,&#x27;</span>, collect_list(c)) <span class="keyword">AS</span> max_c</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> a, b, c, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> b <span class="keyword">DESC</span>) <span class="keyword">AS</span> desc_rn</span><br><span class="line">			<span class="keyword">FROM</span> t2</span><br><span class="line">		) a</span><br><span class="line">		<span class="keyword">WHERE</span> desc_rn <span class="operator">&lt;=</span> <span class="number">2</span></span><br><span class="line">		<span class="keyword">GROUP</span> <span class="keyword">BY</span> a</span><br><span class="line">	) tmp2</span><br><span class="line">	<span class="keyword">ON</span> tmp1.a <span class="operator">=</span> tmp2.a;</span><br></pre></td></tr></table></figure>



<h2 id="三、累计求值"><a href="#三、累计求值" class="headerlink" title="三、累计求值"></a>三、累计求值</h2><p>表名：t3</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a  b  c</span><br><span class="line">2014 A  3</span><br><span class="line">2014 B  1</span><br><span class="line">2014 C  2</span><br><span class="line">2015 A  4</span><br><span class="line">2015 D  3</span><br></pre></td></tr></table></figure>



<h4 id="问题一：按a分组按b字段排序，对c累计求和"><a href="#问题一：按a分组按b字段排序，对c累计求和" class="headerlink" title="问题一：按a分组按b字段排序，对c累计求和"></a>问题一：按a分组按b字段排序，对c累计求和</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a  b  sum_c</span><br><span class="line">2014 A  3</span><br><span class="line">2014 B  4</span><br><span class="line">2014 C  6</span><br><span class="line">2015 A  4</span><br><span class="line">2015 D  7</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT a, b, c</span><br><span class="line">	, sum(c) OVER (PARTITION BY a ORDER BY b) AS sum_c</span><br><span class="line">FROM t3;</span><br></pre></td></tr></table></figure>



<h4 id="问题二：按a分组按b字段排序，对c取累计平均值"><a href="#问题二：按a分组按b字段排序，对c取累计平均值" class="headerlink" title="问题二：按a分组按b字段排序，对c取累计平均值"></a>问题二：按a分组按b字段排序，对c取累计平均值</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a  b  avg_c</span><br><span class="line">2014 A  3</span><br><span class="line">2014 B  2</span><br><span class="line">2014 C  2</span><br><span class="line">2015 A  4</span><br><span class="line">2015 D  3.5</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT a, b, c</span><br><span class="line">	, avg(c) OVER (PARTITION BY a ORDER BY b) AS avg_c</span><br><span class="line">FROM t3;</span><br></pre></td></tr></table></figure>



<h4 id="问题三：按a分组按b字段排序，对b取累计排名比例"><a href="#问题三：按a分组按b字段排序，对b取累计排名比例" class="headerlink" title="问题三：按a分组按b字段排序，对b取累计排名比例"></a>问题三：按a分组按b字段排序，对b取累计排名比例</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a  b  ratio_c</span><br><span class="line">2014 A  0.33</span><br><span class="line">2014 B  0.67</span><br><span class="line">2014 C  1.00</span><br><span class="line">2015 A  0.50</span><br><span class="line">2015 D  1.00</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT a, b, c</span><br><span class="line">	, round(row_number() OVER (PARTITION BY a ORDER BY b) / count(c) OVER (PARTITION BY a ), 2) AS ratio_c</span><br><span class="line">FROM t3</span><br><span class="line">ORDER BY a, b;</span><br></pre></td></tr></table></figure>



<h4 id="问题四：按a分组按b字段排序，对b取累计求和比例"><a href="#问题四：按a分组按b字段排序，对b取累计求和比例" class="headerlink" title="问题四：按a分组按b字段排序，对b取累计求和比例"></a>问题四：按a分组按b字段排序，对b取累计求和比例</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a  b  ratio_c</span><br><span class="line">2014 A  0.50</span><br><span class="line">2014 B  0.67</span><br><span class="line">2014 C  1.00</span><br><span class="line">2015 A  0.57</span><br><span class="line">2015 D  1.00</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT a, b, c</span><br><span class="line">	, round(sum(c) OVER (PARTITION BY a ORDER BY b) / sum(c) OVER (PARTITION BY a ), 2) AS ratio_c</span><br><span class="line">FROM t3</span><br><span class="line">ORDER BY a, b;</span><br></pre></td></tr></table></figure>



<h2 id="四、窗口大小控制"><a href="#四、窗口大小控制" class="headerlink" title="四、窗口大小控制"></a>四、窗口大小控制</h2><p>表名：t4</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a  b  c</span><br><span class="line">2014 A  3</span><br><span class="line">2014 B  1</span><br><span class="line">2014 C  2</span><br><span class="line">2015 A  4</span><br><span class="line">2015 D  3</span><br></pre></td></tr></table></figure>



<h3 id="问题一：按a分组按b字段排序，对c取前后各一行的和"><a href="#问题一：按a分组按b字段排序，对c取前后各一行的和" class="headerlink" title="问题一：按a分组按b字段排序，对c取前后各一行的和"></a>问题一：按a分组按b字段排序，对c取前后各一行的和</h3><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a  b  sum_c</span><br><span class="line">2014 A  1</span><br><span class="line">2014 B  5</span><br><span class="line">2014 C  1</span><br><span class="line">2015 A  3</span><br><span class="line">2015 D  4</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select </span><br><span class="line"> a,</span><br><span class="line"> b,</span><br><span class="line"> lag(c,1,0) over(partition by a order by b)+lead(c,1,0) over(partition by a order by b) as sum_c</span><br><span class="line">from t4;</span><br></pre></td></tr></table></figure>



<h3 id="问题二：按a分组按b字段排序，对c取平均值"><a href="#问题二：按a分组按b字段排序，对c取平均值" class="headerlink" title="问题二：按a分组按b字段排序，对c取平均值"></a>问题二：按a分组按b字段排序，对c取平均值</h3><p>问题描述：前一行与当前行的均值！</p>
<p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a  b  avg_c</span><br><span class="line">2014 A  3</span><br><span class="line">2014 B  2</span><br><span class="line">2014 C  1.5</span><br><span class="line">2015 A  4</span><br><span class="line">2015 D  3.5</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select</span><br><span class="line"> a,</span><br><span class="line"> b,</span><br><span class="line"> case when lag_c is null then c</span><br><span class="line"> else (c+lag_c)/2 end as avg_c</span><br><span class="line">from</span><br><span class="line"> (</span><br><span class="line"> select</span><br><span class="line">  a,</span><br><span class="line"> b,</span><br><span class="line">  c,</span><br><span class="line">  lag(c,1) over(partition by a order by b) as lag_c</span><br><span class="line"> from t4</span><br><span class="line"> )temp;</span><br></pre></td></tr></table></figure>



<h2 id="五、产生连续数值"><a href="#五、产生连续数值" class="headerlink" title="五、产生连续数值"></a>五、产生连续数值</h2><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">...</span><br><span class="line">100</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<p>不借助其他任何外表，实现产生连续数值</p>
<p>此处给出两种解法，其一：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id_start <span class="operator">+</span> pos <span class="keyword">AS</span> id</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">AS</span> id_start, <span class="number">1000000</span> <span class="keyword">AS</span> id_end</span><br><span class="line">) m</span><br><span class="line">	<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> posexplode(split(space(id_end <span class="operator">-</span> id_start), <span class="string">&#x27;&#x27;</span>)) t <span class="keyword">AS</span> pos, val</span><br></pre></td></tr></table></figure>



<p>其二：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">row_number</span>() <span class="keyword">OVER</span> () <span class="keyword">AS</span> id</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> split(space(<span class="number">99</span>), <span class="string">&#x27; &#x27;</span>) <span class="keyword">AS</span> x</span><br><span class="line">) t</span><br><span class="line">	<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> explode(x) ex;</span><br></pre></td></tr></table></figure>



<p>那如何产生1至1000000连续数值？</p>
<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT row_number() OVER () AS id</span><br><span class="line">FROM (</span><br><span class="line">	SELECT split(space(999999), &#x27; &#x27;) AS x</span><br><span class="line">) t</span><br><span class="line">	LATERAL VIEW explode(x) ex;</span><br></pre></td></tr></table></figure>



<h2 id="六、数据扩充与收缩"><a href="#六、数据扩充与收缩" class="headerlink" title="六、数据扩充与收缩"></a>六、数据扩充与收缩</h2><p>表名：t6</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a </span><br><span class="line">3 </span><br><span class="line">2</span><br><span class="line">4</span><br></pre></td></tr></table></figure>



<h4 id="问题一：数据扩充"><a href="#问题一：数据扩充" class="headerlink" title="问题一：数据扩充"></a>问题一：数据扩充</h4><p>输出结果如下所示：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">a   b</span><br><span class="line"><span class="number">3</span>  <span class="number">3</span>、<span class="number">2</span>、<span class="number">1</span></span><br><span class="line"><span class="number">2</span>  <span class="number">2</span>、<span class="number">1</span></span><br><span class="line"><span class="number">4</span>  <span class="number">4</span>、<span class="number">3</span>、<span class="number">2</span>、<span class="number">1</span></span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"> t.a,</span><br><span class="line"> concat_ws(<span class="string">&#x27;、&#x27;</span>,collect_set(<span class="built_in">cast</span>(t.rn <span class="keyword">as</span> string))) <span class="keyword">as</span> b</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">( </span><br><span class="line"> <span class="keyword">select</span> </span><br><span class="line">  t6.a,</span><br><span class="line">  b.rn</span><br><span class="line"> <span class="keyword">from</span> t6</span><br><span class="line"> <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line"> (   <span class="keyword">select</span></span><br><span class="line">   <span class="built_in">row_number</span>() <span class="keyword">over</span>() <span class="keyword">as</span> rn</span><br><span class="line">  <span class="keyword">from</span> </span><br><span class="line">  (<span class="keyword">select</span> split(space(<span class="number">5</span>), <span class="string">&#x27; &#x27;</span>) <span class="keyword">as</span> x) t <span class="comment">-- space(5)可根据t6表的最大值灵活调整</span></span><br><span class="line">  <span class="keyword">lateral</span> <span class="keyword">view</span></span><br><span class="line">  explode(x) pe</span><br><span class="line"> ) b</span><br><span class="line"> <span class="keyword">on</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"> <span class="keyword">where</span> t6.a <span class="operator">&gt;=</span> b.rn</span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> t6.a, b.rn <span class="keyword">desc</span> </span><br><span class="line">) t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> t.a;</span><br></pre></td></tr></table></figure>



<h4 id="问题二：数据扩充，排除偶数"><a href="#问题二：数据扩充，排除偶数" class="headerlink" title="问题二：数据扩充，排除偶数"></a>问题二：数据扩充，排除偶数</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a   b</span><br><span class="line">3  3、1</span><br><span class="line">2  1</span><br><span class="line">4  3、1</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select </span><br><span class="line"> t.a,</span><br><span class="line"> concat_ws(&#x27;、&#x27;,collect_set(cast(t.rn as string))) as b</span><br><span class="line">from</span><br><span class="line">( </span><br><span class="line"> select </span><br><span class="line">  t6.a,</span><br><span class="line">  b.rn</span><br><span class="line"> from t6</span><br><span class="line"> left join</span><br><span class="line"> ( </span><br><span class="line">  select</span><br><span class="line">   row_number() over() as rn</span><br><span class="line">  from </span><br><span class="line">  (select split(space(5), &#x27; &#x27;) as x) t</span><br><span class="line">  lateral view</span><br><span class="line">  explode(x) pe</span><br><span class="line"> ) b</span><br><span class="line"> on 1 = 1</span><br><span class="line"> where t6.a &gt;= b.rn and b.rn % 2 = 1</span><br><span class="line"> order by t6.a, b.rn desc </span><br><span class="line">) t</span><br><span class="line">group by t.a;</span><br></pre></td></tr></table></figure>



<h4 id="问题三：如何处理字符串累计拼接"><a href="#问题三：如何处理字符串累计拼接" class="headerlink" title="问题三：如何处理字符串累计拼接"></a>问题三：如何处理字符串累计拼接</h4><p>问题描述：将小于等于a字段的值聚合拼接起来</p>
<p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a   b</span><br><span class="line">3   2、3</span><br><span class="line">2   2</span><br><span class="line">4   2、3、4</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"> t.a,</span><br><span class="line"> concat_ws(<span class="string">&#x27;、&#x27;</span>,collect_set(<span class="built_in">cast</span>(t.a1 <span class="keyword">as</span> string))) <span class="keyword">as</span> b</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(   <span class="keyword">select</span> </span><br><span class="line"></span><br><span class="line">  t6.a,</span><br><span class="line">  b.a1 <span class="keyword">from</span> t6</span><br><span class="line"> <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line"> (  </span><br><span class="line">  <span class="keyword">select</span> a <span class="keyword">as</span> a1 </span><br><span class="line">  <span class="keyword">from</span> t6</span><br><span class="line"> ) b</span><br><span class="line"> <span class="keyword">on</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"> <span class="keyword">where</span> t6.a <span class="operator">&gt;=</span> b.a1</span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> t6.a, b.a1 </span><br><span class="line">) t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> t.a;</span><br></pre></td></tr></table></figure>



<h4 id="问题四：如果a字段有重复，如何实现字符串累计拼接"><a href="#问题四：如果a字段有重复，如何实现字符串累计拼接" class="headerlink" title="问题四：如果a字段有重复，如何实现字符串累计拼接"></a>问题四：如果a字段有重复，如何实现字符串累计拼接</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a   b</span><br><span class="line">2   2</span><br><span class="line">3   2、3</span><br><span class="line">3   2、3、3</span><br><span class="line">4   2、3、3、4</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"> a,</span><br><span class="line"> b</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line"> <span class="keyword">select</span> </span><br><span class="line">  t.a,</span><br><span class="line">  t.rn,</span><br><span class="line">  concat_ws(<span class="string">&#x27;、&#x27;</span>,collect_list(<span class="built_in">cast</span>(t.a1 <span class="keyword">as</span> string))) <span class="keyword">as</span> b</span><br><span class="line"> <span class="keyword">from</span></span><br><span class="line"> (  </span><br><span class="line">  <span class="keyword">select</span> </span><br><span class="line">   a.a,</span><br><span class="line">   a.rn,</span><br><span class="line">   b.a1</span><br><span class="line">  <span class="keyword">from</span></span><br><span class="line">  (</span><br><span class="line">   <span class="keyword">select</span> </span><br><span class="line">​    a,</span><br><span class="line">​    <span class="built_in">row_number</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> a ) <span class="keyword">as</span> rn </span><br><span class="line">   <span class="keyword">from</span> t6</span><br><span class="line">  ) a</span><br><span class="line">  <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">  (  </span><br><span class="line">   <span class="keyword">select</span> a <span class="keyword">as</span> a1,</span><br><span class="line">   <span class="built_in">row_number</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> a ) <span class="keyword">as</span> rn </span><br><span class="line">   <span class="keyword">from</span> t6</span><br><span class="line">  ) b</span><br><span class="line">  <span class="keyword">on</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">  <span class="keyword">where</span> a.a <span class="operator">&gt;=</span> b.a1 <span class="keyword">and</span> a.rn <span class="operator">&gt;=</span> b.rn </span><br><span class="line">  <span class="keyword">order</span> <span class="keyword">by</span> a.a, b.a1 </span><br><span class="line"> ) t</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> t.a,t.rn</span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> t.a,t.rn</span><br><span class="line">) tt; </span><br></pre></td></tr></table></figure>



<h4 id="问题五：数据展开"><a href="#问题五：数据展开" class="headerlink" title="问题五：数据展开"></a>问题五：数据展开</h4><p>问题描述：如何将字符串”1-5,16,11-13,9”扩展成”1,2,3,4,5,16,11,12,13,9”？注意顺序不变。</p>
<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"> concat_ws(<span class="string">&#x27;,&#x27;</span>,collect_list(<span class="built_in">cast</span>(rn <span class="keyword">as</span> string)))</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line"> <span class="keyword">select</span> </span><br><span class="line">  a.rn,</span><br><span class="line">  b.num,</span><br><span class="line">  b.pos</span><br><span class="line"> <span class="keyword">from</span></span><br><span class="line">  (</span><br><span class="line">  <span class="keyword">select</span></span><br><span class="line">   <span class="built_in">row_number</span>() <span class="keyword">over</span>() <span class="keyword">as</span> rn</span><br><span class="line">  <span class="keyword">from</span> (<span class="keyword">select</span> split(space(<span class="number">20</span>), <span class="string">&#x27; &#x27;</span>) <span class="keyword">as</span> x) t <span class="comment">-- space(20)可灵活调整</span></span><br><span class="line">  <span class="keyword">lateral</span> <span class="keyword">view</span></span><br><span class="line">  explode(x) pe</span><br><span class="line">  ) a <span class="keyword">lateral</span> <span class="keyword">view</span> <span class="keyword">outer</span> </span><br><span class="line">  posexplode(split(<span class="string">&#x27;1-5,16,11-13,9&#x27;</span>, <span class="string">&#x27;,&#x27;</span>)) b <span class="keyword">as</span> pos, num</span><br><span class="line">  <span class="keyword">where</span> a.rn <span class="keyword">between</span> <span class="built_in">cast</span>(split(num, <span class="string">&#x27;-&#x27;</span>)[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">int</span>) <span class="keyword">and</span> <span class="built_in">cast</span>(split(num, <span class="string">&#x27;-&#x27;</span>)[<span class="number">1</span>] <span class="keyword">as</span> <span class="type">int</span>) <span class="keyword">or</span> a.rn <span class="operator">=</span> num</span><br><span class="line">  <span class="keyword">order</span> <span class="keyword">by</span> pos, rn </span><br><span class="line">) t;</span><br></pre></td></tr></table></figure>



<h2 id="七、合并与拆分"><a href="#七、合并与拆分" class="headerlink" title="七、合并与拆分"></a>七、合并与拆分</h2><p>表名：t7</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a  b</span><br><span class="line">2014 A</span><br><span class="line">2014 B</span><br><span class="line">2015 B</span><br><span class="line">2015 D</span><br></pre></td></tr></table></figure>



<h4 id="问题一：合并"><a href="#问题一：合并" class="headerlink" title="问题一：合并"></a>问题一：合并</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2014 A、B</span><br><span class="line"></span><br><span class="line">2015 B、D</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line"> a,</span><br><span class="line"> concat_ws(<span class="string">&#x27;、&#x27;</span>, collect_set(t.b)) b</span><br><span class="line"><span class="keyword">from</span> t7</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a;</span><br></pre></td></tr></table></figure>



<h4 id="问题二：拆分"><a href="#问题二：拆分" class="headerlink" title="问题二：拆分"></a>问题二：拆分</h4><p>问题描述：将分组合并的结果拆分出来</p>
<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line"> t.a,</span><br><span class="line"> d</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line"> <span class="keyword">select</span></span><br><span class="line"> a,</span><br><span class="line"> concat_ws(<span class="string">&#x27;、&#x27;</span>, collect_set(t7.b)) b</span><br><span class="line"> <span class="keyword">from</span> t7</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> a</span><br><span class="line">)t</span><br><span class="line"><span class="keyword">lateral</span> <span class="keyword">view</span> </span><br><span class="line">explode(split(t.b, <span class="string">&#x27;、&#x27;</span>)) table_tmp <span class="keyword">as</span> d;</span><br></pre></td></tr></table></figure>



<h2 id="八、模拟循环操作"><a href="#八、模拟循环操作" class="headerlink" title="八、模拟循环操作"></a>八、模拟循环操作</h2><p>表名：t8</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a</span><br><span class="line">1011</span><br><span class="line">0101</span><br></pre></td></tr></table></figure>



<h5 id="问题一：如何将字符’1’的位置提取出来"><a href="#问题一：如何将字符’1’的位置提取出来" class="headerlink" title="问题一：如何将字符’1’的位置提取出来"></a>问题一：如何将字符’1’的位置提取出来</h5><p>输出结果如下所示:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1,3,4</span><br><span class="line">2,4</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a, concat_ws(<span class="string">&#x27;,&#x27;</span>, collect_list(<span class="built_in">CAST</span>(index <span class="keyword">AS</span> string))) <span class="keyword">AS</span> res</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, index <span class="operator">+</span> <span class="number">1</span> <span class="keyword">AS</span> index, chr</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> a</span><br><span class="line">			, concat_ws(<span class="string">&#x27;,&#x27;</span>, substr(a, <span class="number">1</span>, <span class="number">1</span>), substr(a, <span class="number">2</span>, <span class="number">1</span>), substr(a, <span class="number">3</span>, <span class="number">1</span>), substr(a, <span class="number">-1</span>)) <span class="keyword">AS</span> str</span><br><span class="line">		<span class="keyword">FROM</span> t8</span><br><span class="line">	) tmp1</span><br><span class="line">		<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> posexplode(split(str, <span class="string">&#x27;,&#x27;</span>)) t <span class="keyword">AS</span> index, chr</span><br><span class="line">	<span class="keyword">WHERE</span> chr <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">) tmp2</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a;</span><br></pre></td></tr></table></figure>



<h2 id="九、不使用distinct或group-by去重"><a href="#九、不使用distinct或group-by去重" class="headerlink" title="九、不使用distinct或group by去重"></a>九、不使用distinct或group by去重</h2><p>表名：t9</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a   b   c  d</span><br><span class="line">2014 2016 2014  A</span><br><span class="line">2014 2015 2015  B</span><br></pre></td></tr></table></figure>



<h4 id="问题一：不使用distinct或group-by去重"><a href="#问题一：不使用distinct或group-by去重" class="headerlink" title="问题一：不使用distinct或group by去重"></a>问题一：不使用distinct或group by去重</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2014 A</span><br><span class="line">2016 A</span><br><span class="line">2014 B</span><br><span class="line">2015 B</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> t2.year, t2.num</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> t1.year, t1.num ) <span class="keyword">AS</span> rank_1</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> a <span class="keyword">AS</span> <span class="keyword">year</span>, d <span class="keyword">AS</span> num</span><br><span class="line">		<span class="keyword">FROM</span> t9</span><br><span class="line">		<span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">		<span class="keyword">SELECT</span> b <span class="keyword">AS</span> <span class="keyword">year</span>, d <span class="keyword">AS</span> num</span><br><span class="line">		<span class="keyword">FROM</span> t9</span><br><span class="line">		<span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">		<span class="keyword">SELECT</span> c <span class="keyword">AS</span> <span class="keyword">year</span>, d <span class="keyword">AS</span> num</span><br><span class="line">		<span class="keyword">FROM</span> t9</span><br><span class="line">	) t1</span><br><span class="line">) t2</span><br><span class="line"><span class="keyword">WHERE</span> rank_1 <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> num;</span><br></pre></td></tr></table></figure>



<h2 id="十、容器–反转内容"><a href="#十、容器–反转内容" class="headerlink" title="十、容器–反转内容"></a>十、容器–反转内容</h2><p>表名：t10</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a</span><br><span class="line"></span><br><span class="line">AB,CA,BAD</span><br><span class="line"></span><br><span class="line">BD,EA</span><br></pre></td></tr></table></figure>



<h4 id="问题一：反转逗号分隔的数据：改变顺序，内容不变"><a href="#问题一：反转逗号分隔的数据：改变顺序，内容不变" class="headerlink" title="问题一：反转逗号分隔的数据：改变顺序，内容不变"></a>问题一：反转逗号分隔的数据：改变顺序，内容不变</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">BAD,CA,AB</span><br><span class="line"></span><br><span class="line">EA,BD</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a</span><br><span class="line">	, concat_ws(<span class="string">&#x27;,&#x27;</span>, collect_list(reverse(str)))</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, str</span><br><span class="line">	<span class="keyword">FROM</span> t10</span><br><span class="line">		<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> explode(split(reverse(a), <span class="string">&#x27;,&#x27;</span>)) t <span class="keyword">AS</span> str</span><br><span class="line">) tmp1</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a;</span><br></pre></td></tr></table></figure>



<h4 id="问题二：反转逗号分隔的数据：改变内容，顺序不变"><a href="#问题二：反转逗号分隔的数据：改变内容，顺序不变" class="headerlink" title="问题二：反转逗号分隔的数据：改变内容，顺序不变"></a>问题二：反转逗号分隔的数据：改变内容，顺序不变</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">BA,AC,DAB</span><br><span class="line"></span><br><span class="line">DB,AE</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a</span><br><span class="line">	, concat_ws(<span class="string">&#x27;,&#x27;</span>, collect_list(reverse(str)))</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, str</span><br><span class="line">	<span class="keyword">FROM</span> t10</span><br><span class="line">		<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> explode(split(a, <span class="string">&#x27;,&#x27;</span>)) t <span class="keyword">AS</span> str</span><br><span class="line">) tmp1</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a;</span><br></pre></td></tr></table></figure>



<h2 id="十一、多容器–成对提取数据"><a href="#十一、多容器–成对提取数据" class="headerlink" title="十一、多容器–成对提取数据"></a>十一、多容器–成对提取数据</h2><p>表名：t11</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a    b</span><br><span class="line"></span><br><span class="line">A/B   1/3</span><br><span class="line"></span><br><span class="line">B/C/D  4/5/2</span><br></pre></td></tr></table></figure>



<h4 id="问题一：成对提取数据，字段一一对应"><a href="#问题一：成对提取数据，字段一一对应" class="headerlink" title="问题一：成对提取数据，字段一一对应"></a>问题一：成对提取数据，字段一一对应</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a    b</span><br><span class="line"></span><br><span class="line">A    1</span><br><span class="line"></span><br><span class="line">B    3</span><br><span class="line"></span><br><span class="line">B    4</span><br><span class="line"></span><br><span class="line">C    5</span><br><span class="line"></span><br><span class="line">D    2</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a_inx, b_inx</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, b, a_id, a_inx, b_id</span><br><span class="line">		, b_inx</span><br><span class="line">	<span class="keyword">FROM</span> t11</span><br><span class="line">		<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> posexplode(split(a, <span class="string">&#x27;/&#x27;</span>)) t <span class="keyword">AS</span> a_id, a_inx</span><br><span class="line">		<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> posexplode(split(b, <span class="string">&#x27;/&#x27;</span>)) t <span class="keyword">AS</span> b_id, b_inx</span><br><span class="line">) tmp</span><br><span class="line"><span class="keyword">WHERE</span> a_id <span class="operator">=</span> b_id;</span><br></pre></td></tr></table></figure>



<h2 id="十二、多容器–转多行"><a href="#十二、多容器–转多行" class="headerlink" title="十二、多容器–转多行"></a>十二、多容器–转多行</h2><p>表名：t12</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a    b   c</span><br><span class="line"></span><br><span class="line">001   A/B   1/3/5</span><br><span class="line"></span><br><span class="line">002   B/C/D  4/5</span><br></pre></td></tr></table></figure>



<h4 id="问题一：转多行"><a href="#问题一：转多行" class="headerlink" title="问题一：转多行"></a>问题一：转多行</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a    d    e</span><br><span class="line"></span><br><span class="line">001   type_b  A</span><br><span class="line"></span><br><span class="line">001   type_b  B</span><br><span class="line"></span><br><span class="line">001   type_c  1</span><br><span class="line"></span><br><span class="line">001   type_c  3</span><br><span class="line"></span><br><span class="line">001   type_c  5</span><br><span class="line"></span><br><span class="line">002   type_b  B</span><br><span class="line"></span><br><span class="line">002   type_b  C</span><br><span class="line"></span><br><span class="line">002   type_b  D</span><br><span class="line"></span><br><span class="line">002   type_c  4</span><br><span class="line"></span><br><span class="line">002   type_c  5</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a, d, e</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, <span class="string">&#x27;type_b&#x27;</span> <span class="keyword">AS</span> d, str <span class="keyword">AS</span> e</span><br><span class="line">	<span class="keyword">FROM</span> t12</span><br><span class="line">		<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> explode(split(b, <span class="string">&#x27;/&#x27;</span>)) t <span class="keyword">AS</span> str</span><br><span class="line">	<span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">	<span class="keyword">SELECT</span> a, <span class="string">&#x27;type_c&#x27;</span> <span class="keyword">AS</span> d, str <span class="keyword">AS</span> e</span><br><span class="line">	<span class="keyword">FROM</span> t12</span><br><span class="line">		<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> explode(split(c, <span class="string">&#x27;/&#x27;</span>)) t <span class="keyword">AS</span> str</span><br><span class="line">) tmp</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a, d;</span><br></pre></td></tr></table></figure>



<h2 id="十三、抽象分组–断点排序"><a href="#十三、抽象分组–断点排序" class="headerlink" title="十三、抽象分组–断点排序"></a>十三、抽象分组–断点排序</h2><p>表名：t13</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a  b</span><br><span class="line"></span><br><span class="line">2014 1</span><br><span class="line"></span><br><span class="line">2015 1</span><br><span class="line"></span><br><span class="line">2016 1</span><br><span class="line"></span><br><span class="line">2017 0</span><br><span class="line"></span><br><span class="line">2018 0</span><br><span class="line"></span><br><span class="line">2019 -1</span><br><span class="line"></span><br><span class="line">2020 -1</span><br><span class="line"></span><br><span class="line">2021 -1</span><br><span class="line"></span><br><span class="line">2022 1</span><br><span class="line"></span><br><span class="line">2023 1</span><br></pre></td></tr></table></figure>



<h4 id="问题一：断点排序"><a href="#问题一：断点排序" class="headerlink" title="问题一：断点排序"></a>问题一：断点排序</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a  b  c </span><br><span class="line"></span><br><span class="line">2014 1  1</span><br><span class="line"></span><br><span class="line">2015 1  2</span><br><span class="line"></span><br><span class="line">2016 1  3</span><br><span class="line"></span><br><span class="line">2017 0  1</span><br><span class="line"></span><br><span class="line">2018 0  2</span><br><span class="line"></span><br><span class="line">2019 -1  1</span><br><span class="line"></span><br><span class="line">2020 -1  2</span><br><span class="line"></span><br><span class="line">2021 -1  3</span><br><span class="line"></span><br><span class="line">2022 1  1</span><br><span class="line"></span><br><span class="line">2023 1  2</span><br></pre></td></tr></table></figure>





<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"> a,</span><br><span class="line"> b,</span><br><span class="line"> <span class="built_in">row_number</span>() <span class="keyword">over</span>( <span class="keyword">partition</span> <span class="keyword">by</span> b,repair_a <span class="keyword">order</span> <span class="keyword">by</span> a <span class="keyword">asc</span>) <span class="keyword">as</span> c <span class="comment">--按照b列和[b的组首]分组，排序</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line"> <span class="keyword">select</span> </span><br><span class="line">  a,</span><br><span class="line">  b,</span><br><span class="line">  a<span class="operator">-</span>b_rn <span class="keyword">as</span> repair_a <span class="comment">-- 根据b列值出现的次序,修复a列值为b首次出现的a列值,称为b的[组首]</span></span><br><span class="line"> <span class="keyword">from</span> </span><br><span class="line"> (</span><br><span class="line">  <span class="keyword">select</span> </span><br><span class="line">   a,</span><br><span class="line">   b,</span><br><span class="line">   <span class="built_in">row_number</span>() <span class="keyword">over</span>( <span class="keyword">partition</span> <span class="keyword">by</span> b <span class="keyword">order</span> <span class="keyword">by</span> a <span class="keyword">asc</span> ) <span class="keyword">as</span> b_rn <span class="comment">-- 按b列分组,按a列排序,得到b列各值出现的次序</span></span><br><span class="line">  <span class="keyword">from</span> t13 </span><br><span class="line">)tmp1</span><br><span class="line">)tmp2 <span class="comment">-- 注意，如果不同的b列值，可能出现同样的组首值，但组首值需要和a列值 一并参与分组，故并不影响排序。</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> a <span class="keyword">asc</span>; </span><br></pre></td></tr></table></figure>



<h2 id="十四、业务逻辑的分类与抽象–时效"><a href="#十四、业务逻辑的分类与抽象–时效" class="headerlink" title="十四、业务逻辑的分类与抽象–时效"></a>十四、业务逻辑的分类与抽象–时效</h2><p>日期表：d_date</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_id   is_work</span><br><span class="line"></span><br><span class="line">2017-04-13    1</span><br><span class="line"></span><br><span class="line">2017-04-14    1</span><br><span class="line"></span><br><span class="line">2017-04-15    0</span><br><span class="line"></span><br><span class="line">2017-04-16    0</span><br><span class="line"></span><br><span class="line">2017-04-17    1</span><br></pre></td></tr></table></figure>



<p>工作日：周一至周五09:30-18:30</p>
<p>客户申请表：t14</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a   b    c</span><br><span class="line"></span><br><span class="line">1   申请  2017-04-14 18:03:00</span><br><span class="line"></span><br><span class="line">1   通过  2017-04-17 09:43:00</span><br><span class="line"></span><br><span class="line">2   申请  2017-04-13 17:02:00</span><br><span class="line"></span><br><span class="line">2   通过  2017-04-15 09:42:00</span><br></pre></td></tr></table></figure>



<h4 id="问题一：计算上表中从申请到通过占用的工作时长"><a href="#问题一：计算上表中从申请到通过占用的工作时长" class="headerlink" title="问题一：计算上表中从申请到通过占用的工作时长"></a>问题一：计算上表中从申请到通过占用的工作时长</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a     d</span><br><span class="line"></span><br><span class="line">1    0.67h</span><br><span class="line"></span><br><span class="line">2    10.67h </span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a</span><br><span class="line">	, round(<span class="built_in">sum</span>(diff) <span class="operator">/</span> <span class="number">3600</span>, <span class="number">2</span>) <span class="keyword">AS</span> d</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, apply_time, pass_time, dates, rn</span><br><span class="line">		, ct, is_work</span><br><span class="line">		, <span class="keyword">CASE</span> </span><br><span class="line">			<span class="keyword">WHEN</span> is_work <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">				<span class="keyword">AND</span> rn <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">			<span class="keyword">THEN</span> unix_timestamp(concat(dates, <span class="string">&#x27; 18:30:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>) <span class="operator">-</span> unix_timestamp(apply_time, <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)</span><br><span class="line">			<span class="keyword">WHEN</span> is_work <span class="operator">=</span> <span class="number">0</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">			<span class="keyword">WHEN</span> is_work <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">				<span class="keyword">AND</span> rn <span class="operator">=</span> ct</span><br><span class="line">			<span class="keyword">THEN</span> unix_timestamp(pass_time, <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>) <span class="operator">-</span> unix_timestamp(concat(dates, <span class="string">&#x27; 09:30:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)</span><br><span class="line">			<span class="keyword">WHEN</span> is_work <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">				<span class="keyword">AND</span> rn <span class="operator">!=</span> ct</span><br><span class="line">			<span class="keyword">THEN</span> <span class="number">93600</span></span><br><span class="line">		<span class="keyword">END</span> <span class="keyword">AS</span> diff</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> a, apply_time, pass_time, time_diff, day_diff</span><br><span class="line">			, rn, ct</span><br><span class="line">			, date_add(<span class="keyword">start</span>, rn <span class="operator">-</span> <span class="number">1</span>) <span class="keyword">AS</span> dates</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> a, apply_time, pass_time, time_diff, day_diff</span><br><span class="line">				, strs, <span class="keyword">start</span>, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a ) <span class="keyword">AS</span> rn</span><br><span class="line">				, <span class="built_in">count</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a ) <span class="keyword">AS</span> ct</span><br><span class="line">			<span class="keyword">FROM</span> (</span><br><span class="line">				<span class="keyword">SELECT</span> a, apply_time, pass_time, time_diff, day_diff</span><br><span class="line">					, substr(repeat(concat(substr(apply_time, <span class="number">1</span>, <span class="number">10</span>), <span class="string">&#x27;,&#x27;</span>), day_diff <span class="operator">+</span> <span class="number">1</span>), <span class="number">1</span>, <span class="number">11</span> <span class="operator">*</span> (day_diff <span class="operator">+</span> <span class="number">1</span>) <span class="operator">-</span> <span class="number">1</span>) <span class="keyword">AS</span> strs</span><br><span class="line">				<span class="keyword">FROM</span> (</span><br><span class="line">					<span class="keyword">SELECT</span> a, apply_time, pass_time</span><br><span class="line">						, unix_timestamp(pass_time, <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>) <span class="operator">-</span> unix_timestamp(apply_time, <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>) <span class="keyword">AS</span> time_diff</span><br><span class="line">						, datediff(substr(pass_time, <span class="number">1</span>, <span class="number">10</span>), substr(apply_time, <span class="number">1</span>, <span class="number">10</span>)) <span class="keyword">AS</span> day_diff</span><br><span class="line">					<span class="keyword">FROM</span> (</span><br><span class="line">						<span class="keyword">SELECT</span> a</span><br><span class="line">							, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">								<span class="keyword">WHEN</span> b <span class="operator">=</span> <span class="string">&#x27;申请&#x27;</span> <span class="keyword">THEN</span> c</span><br><span class="line">							<span class="keyword">END</span>) <span class="keyword">AS</span> apply_time</span><br><span class="line">							, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">								<span class="keyword">WHEN</span> b <span class="operator">=</span> <span class="string">&#x27;通过&#x27;</span> <span class="keyword">THEN</span> c</span><br><span class="line">							<span class="keyword">END</span>) <span class="keyword">AS</span> pass_time</span><br><span class="line">						<span class="keyword">FROM</span> t14</span><br><span class="line">						<span class="keyword">GROUP</span> <span class="keyword">BY</span> a</span><br><span class="line">					) tmp1</span><br><span class="line">				) tmp2</span><br><span class="line">			) tmp3</span><br><span class="line">				<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> explode(split(strs, <span class="string">&#x27;,&#x27;</span>)) t <span class="keyword">AS</span> <span class="keyword">start</span></span><br><span class="line">		) tmp4</span><br><span class="line">	) tmp5</span><br><span class="line">		<span class="keyword">JOIN</span> d_date <span class="keyword">ON</span> tmp5.dates <span class="operator">=</span> d_date.date_id</span><br><span class="line">) tmp6</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a;</span><br></pre></td></tr></table></figure>



<h2 id="十五、时间序列–进度及剩余"><a href="#十五、时间序列–进度及剩余" class="headerlink" title="十五、时间序列–进度及剩余"></a>十五、时间序列–进度及剩余</h2><p>表名：t15</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_id   is_work</span><br><span class="line"></span><br><span class="line">2017-07-30   0</span><br><span class="line"></span><br><span class="line">2017-07-31   1</span><br><span class="line"></span><br><span class="line">2017-08-01   1</span><br><span class="line"></span><br><span class="line">2017-08-02   1</span><br><span class="line"></span><br><span class="line">2017-08-03   1</span><br><span class="line"></span><br><span class="line">2017-08-04   1</span><br><span class="line"></span><br><span class="line">2017-08-05   0</span><br><span class="line"></span><br><span class="line">2017-08-06   0</span><br><span class="line"></span><br><span class="line">2017-08-07   1</span><br></pre></td></tr></table></figure>



<h4 id="问题一：求每天的累计周工作日，剩余周工作日"><a href="#问题一：求每天的累计周工作日，剩余周工作日" class="headerlink" title="问题一：求每天的累计周工作日，剩余周工作日"></a>问题一：求每天的累计周工作日，剩余周工作日</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_id   week_to_work week_left_work</span><br><span class="line"></span><br><span class="line">2017-07-31   1       4</span><br><span class="line"></span><br><span class="line">2017-08-01   2       3</span><br><span class="line"></span><br><span class="line">2017-08-02   3       2</span><br><span class="line"></span><br><span class="line">2017-08-03   4       1</span><br><span class="line"></span><br><span class="line">2017-08-04   5       0</span><br><span class="line"></span><br><span class="line">2017-08-05   5       0</span><br><span class="line"></span><br><span class="line">2017-08-06   5       0</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<p>此处给出两种解法，其一：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> date_id</span><br><span class="line">	, <span class="keyword">CASE</span> date_format(date_id, <span class="string">&#x27;u&#x27;</span>)</span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="number">2</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">3</span> <span class="keyword">THEN</span> <span class="number">3</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">4</span> <span class="keyword">THEN</span> <span class="number">4</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">5</span> <span class="keyword">THEN</span> <span class="number">5</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">6</span> <span class="keyword">THEN</span> <span class="number">5</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">7</span> <span class="keyword">THEN</span> <span class="number">5</span></span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">AS</span> week_to_work</span><br><span class="line">	, <span class="keyword">CASE</span> date_format(date_id, <span class="string">&#x27;u&#x27;</span>)</span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="number">4</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="number">3</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">3</span> <span class="keyword">THEN</span> <span class="number">2</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">4</span> <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">5</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">6</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">7</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">AS</span> week_to_work</span><br><span class="line"><span class="keyword">FROM</span> t15</span><br></pre></td></tr></table></figure>



<p>其二：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> date_id, week_to_work, week_sum_work <span class="operator">-</span> week_to_work <span class="keyword">AS</span> week_left_work</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> date_id, <span class="built_in">sum</span>(is_work) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">year</span>, week <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id) <span class="keyword">AS</span> week_to_work</span><br><span class="line">		, <span class="built_in">sum</span>(is_work) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">year</span>, week ) <span class="keyword">AS</span> week_sum_work</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> date_id, is_work, <span class="keyword">year</span>(date_id) <span class="keyword">AS</span> <span class="keyword">year</span></span><br><span class="line">			, weekofyear(date_id) <span class="keyword">AS</span> week</span><br><span class="line">		<span class="keyword">FROM</span> t15</span><br><span class="line">	) ta</span><br><span class="line">) tb</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id;</span><br></pre></td></tr></table></figure>



<h2 id="十六、时间序列–构造日期"><a href="#十六、时间序列–构造日期" class="headerlink" title="十六、时间序列–构造日期"></a>十六、时间序列–构造日期</h2><h4 id="问题一：直接使用SQL实现一张日期维度表，包含以下字段："><a href="#问题一：直接使用SQL实现一张日期维度表，包含以下字段：" class="headerlink" title="问题一：直接使用SQL实现一张日期维度表，包含以下字段："></a>问题一：直接使用SQL实现一张日期维度表，包含以下字段：</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date         string        日期</span><br><span class="line"></span><br><span class="line">d_week        string        年内第几周</span><br><span class="line"></span><br><span class="line">weeks        int         周几</span><br><span class="line"></span><br><span class="line">w_start       string        周开始日</span><br><span class="line"></span><br><span class="line">w_end        string        周结束日</span><br><span class="line"></span><br><span class="line">d_month       int         第几月</span><br><span class="line"></span><br><span class="line">m_start       string        月开始日</span><br><span class="line"></span><br><span class="line">m_end        string        月结束日</span><br><span class="line"></span><br><span class="line">d_quarter      int          第几季</span><br><span class="line"></span><br><span class="line">q_start       string        季开始日</span><br><span class="line"></span><br><span class="line">q_end        string        季结束日</span><br><span class="line"></span><br><span class="line">d_year        int          年份</span><br><span class="line"></span><br><span class="line">y_start       string        年开始日</span><br><span class="line"></span><br><span class="line">y_end        string        年结束日</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dim_date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> dim_date (</span><br><span class="line">	`<span class="type">date</span>` string COMMENT <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">	d_week string COMMENT <span class="string">&#x27;年内第几周&#x27;</span>,</span><br><span class="line">	weeks string COMMENT <span class="string">&#x27;周几&#x27;</span>,</span><br><span class="line">	w_start string COMMENT <span class="string">&#x27;周开始日&#x27;</span>,</span><br><span class="line">	w_end string COMMENT <span class="string">&#x27;周结束日&#x27;</span>,</span><br><span class="line">	d_month string COMMENT <span class="string">&#x27;第几月&#x27;</span>,</span><br><span class="line">	m_start string COMMENT <span class="string">&#x27;月开始日&#x27;</span>,</span><br><span class="line">	m_end string COMMENT <span class="string">&#x27;月结束日&#x27;</span>,</span><br><span class="line">	d_quarter <span class="type">int</span> COMMENT <span class="string">&#x27;第几季&#x27;</span>,</span><br><span class="line">	q_start string COMMENT <span class="string">&#x27;季开始日&#x27;</span>,</span><br><span class="line">	q_end string COMMENT <span class="string">&#x27;季结束日&#x27;</span>,</span><br><span class="line">	d_year <span class="type">int</span> COMMENT <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">	y_start string COMMENT <span class="string">&#x27;年开始日&#x27;</span>,</span><br><span class="line">	y_end string COMMENT <span class="string">&#x27;年结束日&#x27;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<p>–自然月: 指每月的1号到那个月的月底，它是按照阳历来计算的。就是从每月1号到月底，不管这个月有30天，31天，29天或者28天，都算是一个自然月。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dim_date</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> `<span class="type">date</span>`</span><br><span class="line"></span><br><span class="line">   , d_week <span class="comment">--年内第几周</span></span><br><span class="line"></span><br><span class="line">   , <span class="keyword">case</span> weekid</span><br><span class="line"></span><br><span class="line">​      <span class="keyword">when</span> <span class="number">0</span> <span class="keyword">then</span> <span class="string">&#x27;周日&#x27;</span></span><br><span class="line"></span><br><span class="line">​      <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">&#x27;周一&#x27;</span></span><br><span class="line"></span><br><span class="line">​      <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">&#x27;周二&#x27;</span></span><br><span class="line"></span><br><span class="line">​      <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">&#x27;周三&#x27;</span></span><br><span class="line"></span><br><span class="line">​      <span class="keyword">when</span> <span class="number">4</span> <span class="keyword">then</span> <span class="string">&#x27;周四&#x27;</span></span><br><span class="line"></span><br><span class="line">​      <span class="keyword">when</span> <span class="number">5</span> <span class="keyword">then</span> <span class="string">&#x27;周五&#x27;</span></span><br><span class="line"></span><br><span class="line">​      <span class="keyword">when</span> <span class="number">6</span> <span class="keyword">then</span> <span class="string">&#x27;周六&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">as</span> weeks <span class="comment">-- 周</span></span><br><span class="line"></span><br><span class="line">   , date_add(next_day(`<span class="type">date</span>`,<span class="string">&#x27;MO&#x27;</span>),<span class="number">-7</span>) <span class="keyword">as</span> w_start <span class="comment">--周一</span></span><br><span class="line"></span><br><span class="line">   , date_add(next_day(`<span class="type">date</span>`,<span class="string">&#x27;MO&#x27;</span>),<span class="number">-1</span>) <span class="keyword">as</span> w_end  <span class="comment">-- 周日_end</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">-- 月份日期</span></span><br><span class="line"></span><br><span class="line">   , concat(<span class="string">&#x27;第&#x27;</span>, monthid, <span class="string">&#x27;月&#x27;</span>) <span class="keyword">as</span> d_month</span><br><span class="line"></span><br><span class="line">   , m_start</span><br><span class="line"></span><br><span class="line">   , m_end</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">   <span class="comment">-- 季节</span></span><br><span class="line"></span><br><span class="line">   , quarterid <span class="keyword">as</span> d_quart</span><br><span class="line"></span><br><span class="line">   , concat(d_year, <span class="string">&#x27;-&#x27;</span>, substr(concat(<span class="string">&#x27;0&#x27;</span>, (quarterid <span class="operator">-</span> <span class="number">1</span>)  <span class="number">3</span> <span class="operator">+</span> <span class="number">1</span>), <span class="number">-2</span>), <span class="string">&#x27;-01&#x27;</span>) <span class="keyword">as</span> q_start <span class="comment">--季开始日</span></span><br><span class="line"></span><br><span class="line">   , date_sub(concat(d_year, <span class="string">&#x27;-&#x27;</span>, substr(concat(<span class="string">&#x27;0&#x27;</span>, (quarterid)  <span class="number">3</span> <span class="operator">+</span> <span class="number">1</span>), <span class="number">-2</span>), <span class="string">&#x27;-01&#x27;</span>), <span class="number">1</span>) <span class="keyword">as</span> q_end  <span class="comment">--季结束日</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">-- 年</span></span><br><span class="line"></span><br><span class="line">   , d_year</span><br><span class="line"></span><br><span class="line">   , y_start</span><br><span class="line"></span><br><span class="line">   , y_end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line"></span><br><span class="line">​     <span class="keyword">select</span> `<span class="type">date</span>`</span><br><span class="line"></span><br><span class="line">​       , pmod(datediff(`<span class="type">date</span>`, <span class="string">&#x27;2012-01-01&#x27;</span>), <span class="number">7</span>)         <span class="keyword">as</span> weekid  <span class="comment">--获取周几</span></span><br><span class="line"></span><br><span class="line">​       , <span class="built_in">cast</span>(substr(`<span class="type">date</span>`, <span class="number">6</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="type">int</span>)            <span class="keyword">as</span> monthid  <span class="comment">--获取月份</span></span><br><span class="line"></span><br><span class="line">​       , <span class="keyword">case</span></span><br><span class="line"></span><br><span class="line">​          <span class="keyword">when</span> <span class="built_in">cast</span>(substr(`<span class="type">date</span>`, <span class="number">6</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="type">int</span>) <span class="operator">&lt;=</span> <span class="number">3</span> <span class="keyword">then</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">​          <span class="keyword">when</span> <span class="built_in">cast</span>(substr(`<span class="type">date</span>`, <span class="number">6</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="type">int</span>) <span class="operator">&lt;=</span> <span class="number">6</span> <span class="keyword">then</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">​          <span class="keyword">when</span> <span class="built_in">cast</span>(substr(`<span class="type">date</span>`, <span class="number">6</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="type">int</span>) <span class="operator">&lt;=</span> <span class="number">9</span> <span class="keyword">then</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">​          <span class="keyword">when</span> <span class="built_in">cast</span>(substr(`<span class="type">date</span>`, <span class="number">6</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="type">int</span>) <span class="operator">&lt;=</span> <span class="number">12</span> <span class="keyword">then</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line">​       <span class="keyword">end</span>                            <span class="keyword">as</span> quarterid <span class="comment">--获取季节 可以直接使用 quarter(`date`)</span></span><br><span class="line"></span><br><span class="line">​       , substr(`<span class="type">date</span>`, <span class="number">1</span>, <span class="number">4</span>)                   <span class="keyword">as</span> d_year  <span class="comment">-- 获取年份</span></span><br><span class="line"></span><br><span class="line">​       , trunc(`<span class="type">date</span>`, <span class="string">&#x27;YYYY&#x27;</span>)                  <span class="keyword">as</span> y_start  <span class="comment">--年开始日</span></span><br><span class="line"></span><br><span class="line">​       , date_sub(trunc(add_months(`<span class="type">date</span>`, <span class="number">12</span>), <span class="string">&#x27;YYYY&#x27;</span>), <span class="number">1</span>) <span class="keyword">as</span> y_end   <span class="comment">--年结束日</span></span><br><span class="line"></span><br><span class="line">​       , date_sub(`<span class="type">date</span>`, dayofmonth(`<span class="type">date</span>`) <span class="operator">-</span> <span class="number">1</span>)         <span class="keyword">as</span> m_start  <span class="comment">--当月第一天</span></span><br><span class="line"></span><br><span class="line">​       , last_day(date_sub(`<span class="type">date</span>`, dayofmonth(`<span class="type">date</span>`) <span class="operator">-</span> <span class="number">1</span>))     m_end   <span class="comment">--当月最后一天</span></span><br><span class="line"></span><br><span class="line">​       , weekofyear(`<span class="type">date</span>`)                    <span class="keyword">as</span> d_week  <span class="comment">--年内第几周</span></span><br><span class="line"></span><br><span class="line">​     <span class="keyword">from</span> (</span><br><span class="line"></span><br><span class="line">​          <span class="comment">-- &#x27;2021-04-01&#x27;是开始日期, &#x27;2022-03-31&#x27;是截止日期</span></span><br><span class="line"></span><br><span class="line">​         <span class="keyword">select</span> date_add(<span class="string">&#x27;2021-04-01&#x27;</span>, t0.pos) <span class="keyword">as</span> `<span class="type">date</span>`</span><br><span class="line"></span><br><span class="line">​         <span class="keyword">from</span> (</span><br><span class="line"></span><br><span class="line">​              <span class="keyword">select</span> posexplode(</span><br><span class="line"></span><br><span class="line">​                     split(</span><br><span class="line"></span><br><span class="line">​                         repeat(<span class="string">&#x27;o&#x27;</span>, datediff(</span><br><span class="line"></span><br><span class="line">​                             from_unixtime(unix_timestamp(<span class="string">&#x27;2022-03-31&#x27;</span>, <span class="string">&#x27;yyyy-mm-dd&#x27;</span>),</span><br><span class="line"></span><br><span class="line">​                                    <span class="string">&#x27;yyyy-mm-dd&#x27;</span>),</span><br><span class="line"></span><br><span class="line">​                             <span class="string">&#x27;2021-04-01&#x27;</span>)), <span class="string">&#x27;o&#x27;</span></span><br><span class="line"></span><br><span class="line">​                       )</span><br><span class="line"></span><br><span class="line">​                   )</span><br><span class="line"></span><br><span class="line">​            ) t0</span><br><span class="line"></span><br><span class="line">​       ) t1</span><br><span class="line"></span><br><span class="line">   ) t2;</span><br></pre></td></tr></table></figure>



<h2 id="十七、时间序列–构造累积日期"><a href="#十七、时间序列–构造累积日期" class="headerlink" title="十七、时间序列–构造累积日期"></a>十七、时间序列–构造累积日期</h2><p>表名：t17</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_id</span><br><span class="line"></span><br><span class="line">2017-08-01</span><br><span class="line"></span><br><span class="line">2017-08-02</span><br><span class="line"></span><br><span class="line">2017-08-03</span><br></pre></td></tr></table></figure>



<h4 id="问题一：每一日期，都扩展成月初至当天"><a href="#问题一：每一日期，都扩展成月初至当天" class="headerlink" title="问题一：每一日期，都扩展成月初至当天"></a>问题一：每一日期，都扩展成月初至当天</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_id  date_to_day</span><br><span class="line"></span><br><span class="line">2017-08-01 2017-08-01</span><br><span class="line"></span><br><span class="line">2017-08-02 2017-08-01</span><br><span class="line"></span><br><span class="line">2017-08-02 2017-08-02</span><br><span class="line"></span><br><span class="line">2017-08-03 2017-08-01</span><br><span class="line"></span><br><span class="line">2017-08-03 2017-08-02</span><br><span class="line"></span><br><span class="line">2017-08-03 2017-08-03</span><br></pre></td></tr></table></figure>



<p>这种累积相关的表，常做桥接表。</p>
<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> date_id, date_add(date_start_id, pos) <span class="keyword">AS</span> date_to_day</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> date_id</span><br><span class="line">		, date_sub(date_id, dayofmonth(date_id) <span class="operator">-</span> <span class="number">1</span>) <span class="keyword">AS</span> date_start_id</span><br><span class="line">	<span class="keyword">FROM</span> t17</span><br><span class="line">) m</span><br><span class="line">	<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> posexplode(split(space(datediff(from_unixtime(unix_timestamp(date_id, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>)), from_unixtime(unix_timestamp(date_start_id, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>)))), <span class="string">&#x27;&#x27;</span>)) t <span class="keyword">AS</span> pos, val;</span><br></pre></td></tr></table></figure>



<h2 id="十八、时间序列–构造连续日期"><a href="#十八、时间序列–构造连续日期" class="headerlink" title="十八、时间序列–构造连续日期"></a>十八、时间序列–构造连续日期</h2><p>表名：t18</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a       b     c</span><br><span class="line"></span><br><span class="line">101    2018-01-01   10</span><br><span class="line"></span><br><span class="line">101    2018-01-03   20</span><br><span class="line"></span><br><span class="line">101    2018-01-06   40</span><br><span class="line"></span><br><span class="line">102    2018-01-02   20</span><br><span class="line"></span><br><span class="line">102    2018-01-04   30</span><br><span class="line"></span><br><span class="line">102    2018-01-07   60</span><br></pre></td></tr></table></figure>



<h4 id="问题一：构造连续日期"><a href="#问题一：构造连续日期" class="headerlink" title="问题一：构造连续日期"></a>问题一：构造连续日期</h4><p>问题描述：将表中数据的b字段扩充至范围[2018-01-01, 2018-01-07]，并累积对c求和。</p>
<p>b字段的值是较稀疏的。</p>
<p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a       b     c   d</span><br><span class="line"></span><br><span class="line">101    2018-01-01   10   10</span><br><span class="line"></span><br><span class="line">101    2018-01-02   0   10</span><br><span class="line"></span><br><span class="line">101    2018-01-03   20   30</span><br><span class="line"></span><br><span class="line">101    2018-01-04   0   30</span><br><span class="line"></span><br><span class="line">101    2018-01-05   0   30</span><br><span class="line"></span><br><span class="line">101    2018-01-06   40   70</span><br><span class="line"></span><br><span class="line">101    2018-01-07   0   70</span><br><span class="line"></span><br><span class="line">102    2018-01-01   0   0</span><br><span class="line"></span><br><span class="line">102    2018-01-02   20   20</span><br><span class="line"></span><br><span class="line">102    2018-01-03   0   20</span><br><span class="line"></span><br><span class="line">102    2018-01-04   30   50</span><br><span class="line"></span><br><span class="line">102    2018-01-05   0   50</span><br><span class="line"></span><br><span class="line">102    2018-01-06   0   50</span><br><span class="line"></span><br><span class="line">102    2018-01-07   60  110</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a, b, c</span><br><span class="line">	, <span class="built_in">sum</span>(c) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> b) <span class="keyword">AS</span> d</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> t1.a, t1.b</span><br><span class="line">		, <span class="keyword">CASE</span> </span><br><span class="line">			<span class="keyword">WHEN</span> t18.b <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span> t18.c</span><br><span class="line">			<span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line">		<span class="keyword">END</span> <span class="keyword">AS</span> c</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> a, date_add(s, pos) <span class="keyword">AS</span> b</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> a, <span class="string">&#x27;2018-01-01&#x27;</span> <span class="keyword">AS</span> s, <span class="string">&#x27;2018-01-07&#x27;</span> <span class="keyword">AS</span> r</span><br><span class="line">			<span class="keyword">FROM</span> (</span><br><span class="line">				<span class="keyword">SELECT</span> a</span><br><span class="line">				<span class="keyword">FROM</span> t18</span><br><span class="line">				<span class="keyword">GROUP</span> <span class="keyword">BY</span> a</span><br><span class="line">			) ta</span><br><span class="line">		) m</span><br><span class="line">			<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> posexplode(split(space(datediff(from_unixtime(unix_timestamp(r, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>)), from_unixtime(unix_timestamp(s, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>)))), <span class="string">&#x27;&#x27;</span>)) t <span class="keyword">AS</span> pos, val</span><br><span class="line">	) t1</span><br><span class="line">		<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t18</span><br><span class="line">		<span class="keyword">ON</span> t1.a <span class="operator">=</span> t18.a</span><br><span class="line">			<span class="keyword">AND</span> t1.b <span class="operator">=</span> t18.b</span><br><span class="line">) ts;</span><br></pre></td></tr></table></figure>



<h2 id="十九、时间序列–取多个字段最新的值"><a href="#十九、时间序列–取多个字段最新的值" class="headerlink" title="十九、时间序列–取多个字段最新的值"></a>十九、时间序列–取多个字段最新的值</h2><p>表名：t19</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_id  a  b  c</span><br><span class="line"></span><br><span class="line">2014   AB 12  bc</span><br><span class="line"></span><br><span class="line">2015     23  </span><br><span class="line"></span><br><span class="line">2016        d</span><br><span class="line"></span><br><span class="line">2017   BC </span><br></pre></td></tr></table></figure>



<h4 id="问题一：如何一并取出最新日期"><a href="#问题一：如何一并取出最新日期" class="headerlink" title="问题一：如何一并取出最新日期"></a>问题一：如何一并取出最新日期</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_a  a  date_b  b  date_c  c</span><br><span class="line"></span><br><span class="line">2017  BC  2015   23  2016  d</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<p>此处给出三种解法，其一：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">		<span class="keyword">WHEN</span> rn_a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> date_id</span><br><span class="line">		<span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line">	<span class="keyword">END</span>) <span class="keyword">AS</span> date_a</span><br><span class="line">	, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">		<span class="keyword">WHEN</span> rn_a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> a</span><br><span class="line">		<span class="keyword">ELSE</span> <span class="keyword">NULL</span></span><br><span class="line">	<span class="keyword">END</span>) <span class="keyword">AS</span> a</span><br><span class="line">	, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">		<span class="keyword">WHEN</span> rn_b <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> date_id</span><br><span class="line">		<span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line">	<span class="keyword">END</span>) <span class="keyword">AS</span> date_b</span><br><span class="line">	, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">		<span class="keyword">WHEN</span> rn_b <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> b</span><br><span class="line">		<span class="keyword">ELSE</span> <span class="keyword">NULL</span></span><br><span class="line">	<span class="keyword">END</span>) <span class="keyword">AS</span> b</span><br><span class="line">	, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">		<span class="keyword">WHEN</span> rn_c <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> date_id</span><br><span class="line">		<span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line">	<span class="keyword">END</span>) <span class="keyword">AS</span> date_c</span><br><span class="line">	, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">		<span class="keyword">WHEN</span> rn_c <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> c</span><br><span class="line">		<span class="keyword">ELSE</span> <span class="keyword">NULL</span></span><br><span class="line">	<span class="keyword">END</span>) <span class="keyword">AS</span> c</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> date_id, a, b, c <span class="comment">--对每列上不为null的值 的 日期 进行排序</span></span><br><span class="line">		, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">CASE</span> </span><br><span class="line">			<span class="keyword">WHEN</span> a <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">			<span class="keyword">ELSE</span> date_id</span><br><span class="line">		<span class="keyword">END</span> <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn_a, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">CASE</span> </span><br><span class="line">			<span class="keyword">WHEN</span> b <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">			<span class="keyword">ELSE</span> date_id</span><br><span class="line">		<span class="keyword">END</span> <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn_b</span><br><span class="line">		, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">CASE</span> </span><br><span class="line">			<span class="keyword">WHEN</span> c <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">			<span class="keyword">ELSE</span> date_id</span><br><span class="line">		<span class="keyword">END</span> <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn_c</span><br><span class="line">	<span class="keyword">FROM</span> t19</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> t.rn_a <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">	<span class="keyword">OR</span> t.rn_b <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">	<span class="keyword">OR</span> t.rn_c <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>



<p>其二：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.date_id, a.a, b.date_id, b.b, c.date_id</span><br><span class="line">	, c.c</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> t.date_id, t.a</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> t.date_id, t.a, t.b, t.c</span><br><span class="line">		<span class="keyword">FROM</span> t19 t</span><br><span class="line">			<span class="keyword">INNER</span> <span class="keyword">JOIN</span> t19 t1</span><br><span class="line">			<span class="keyword">ON</span> t.date_id <span class="operator">=</span> t1.date_id</span><br><span class="line">				<span class="keyword">AND</span> t.a <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">	) t</span><br><span class="line">	<span class="keyword">ORDER</span> <span class="keyword">BY</span> t.date_id <span class="keyword">DESC</span></span><br><span class="line">	LIMIT <span class="number">1</span></span><br><span class="line">) a</span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> t.date_id, t.b</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> t.date_id, t.b</span><br><span class="line">			<span class="keyword">FROM</span> t19 t</span><br><span class="line">				<span class="keyword">INNER</span> <span class="keyword">JOIN</span> t19 t1</span><br><span class="line">				<span class="keyword">ON</span> t.date_id <span class="operator">=</span> t1.date_id</span><br><span class="line">					<span class="keyword">AND</span> t.b <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">		) t</span><br><span class="line">		<span class="keyword">ORDER</span> <span class="keyword">BY</span> t.date_id <span class="keyword">DESC</span></span><br><span class="line">		LIMIT <span class="number">1</span></span><br><span class="line">	) b</span><br><span class="line">	<span class="keyword">ON</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> t.date_id, t.c</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> t.date_id, t.c</span><br><span class="line">			<span class="keyword">FROM</span> t19 t</span><br><span class="line">				<span class="keyword">INNER</span> <span class="keyword">JOIN</span> t19 t1</span><br><span class="line">				<span class="keyword">ON</span> t.date_id <span class="operator">=</span> t1.date_id</span><br><span class="line">					<span class="keyword">AND</span> t.c <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">		) t</span><br><span class="line">		<span class="keyword">ORDER</span> <span class="keyword">BY</span> t.date_id <span class="keyword">DESC</span></span><br><span class="line">		LIMIT <span class="number">1</span></span><br><span class="line">	) c</span><br><span class="line">	<span class="keyword">ON</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>



<p>其三：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> t1.date_id <span class="keyword">AS</span> date_a, t1.a</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> t1.date_id, t1.a</span><br><span class="line">		<span class="keyword">FROM</span> t19 t1</span><br><span class="line">		<span class="keyword">WHERE</span> t1.a <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">	) t1</span><br><span class="line">		<span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> <span class="built_in">max</span>(t1.date_id) <span class="keyword">AS</span> date_id</span><br><span class="line">			<span class="keyword">FROM</span> t19 t1</span><br><span class="line">			<span class="keyword">WHERE</span> t1.a <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">		) t2</span><br><span class="line">		<span class="keyword">ON</span> t1.date_id <span class="operator">=</span> t2.date_id</span><br><span class="line">) t1</span><br><span class="line">	<span class="keyword">CROSS</span> <span class="keyword">JOIN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> t1.date_b, t1.b</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> t1.date_id <span class="keyword">AS</span> date_b, t1.b</span><br><span class="line">			<span class="keyword">FROM</span> t19 t1</span><br><span class="line">			<span class="keyword">WHERE</span> t1.b <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">		) t1</span><br><span class="line">			<span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">				<span class="keyword">SELECT</span> <span class="built_in">max</span>(t1.date_id) <span class="keyword">AS</span> date_id</span><br><span class="line">				<span class="keyword">FROM</span> t19 t1</span><br><span class="line">				<span class="keyword">WHERE</span> t1.b <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">			) t2</span><br><span class="line">			<span class="keyword">ON</span> t1.date_b <span class="operator">=</span> t2.date_id</span><br><span class="line">	) t2</span><br><span class="line">	<span class="keyword">CROSS</span> <span class="keyword">JOIN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> t1.date_c, t1.c</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> t1.date_id <span class="keyword">AS</span> date_c, t1.c</span><br><span class="line">			<span class="keyword">FROM</span> t19 t1</span><br><span class="line">			<span class="keyword">WHERE</span> t1.c <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">		) t1</span><br><span class="line">			<span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">				<span class="keyword">SELECT</span> <span class="built_in">max</span>(t1.date_id) <span class="keyword">AS</span> date_id</span><br><span class="line">				<span class="keyword">FROM</span> t19 t1</span><br><span class="line">				<span class="keyword">WHERE</span> t1.c <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">			) t2</span><br><span class="line">			<span class="keyword">ON</span> t1.date_c <span class="operator">=</span> t2.date_id</span><br><span class="line">	) t3;</span><br></pre></td></tr></table></figure>



<h2 id="二十、时间序列–补全数据"><a href="#二十、时间序列–补全数据" class="headerlink" title="二十、时间序列–补全数据"></a>二十、时间序列–补全数据</h2><p>表名：t20</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_id  a  b  c</span><br><span class="line"></span><br><span class="line">2014   AB 12  bc</span><br><span class="line"></span><br><span class="line">2015     23  </span><br><span class="line"></span><br><span class="line">2016        d</span><br><span class="line"></span><br><span class="line">2017   BC </span><br></pre></td></tr></table></figure>



<h4 id="问题一：如何使用最新数据补全表格"><a href="#问题一：如何使用最新数据补全表格" class="headerlink" title="问题一：如何使用最新数据补全表格"></a>问题一：如何使用最新数据补全表格</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_id  a  b  c</span><br><span class="line"></span><br><span class="line">2014   AB 12  bc</span><br><span class="line"></span><br><span class="line">2015   AB 23  bc</span><br><span class="line"></span><br><span class="line">2016   AB 23  d</span><br><span class="line"></span><br><span class="line">2017   BC 23  d</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> date_id, <span class="built_in">first_value</span>(a) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> aa <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id) <span class="keyword">AS</span> a</span><br><span class="line">	, <span class="built_in">first_value</span>(b) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> bb <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id) <span class="keyword">AS</span> b</span><br><span class="line">	, <span class="built_in">first_value</span>(c) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cc <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id) <span class="keyword">AS</span> c</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> date_id, a, b, c</span><br><span class="line">		, <span class="built_in">count</span>(a) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id) <span class="keyword">AS</span> aa</span><br><span class="line">		, <span class="built_in">count</span>(b) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id) <span class="keyword">AS</span> bb</span><br><span class="line">		, <span class="built_in">count</span>(c) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id) <span class="keyword">AS</span> cc</span><br><span class="line">	<span class="keyword">FROM</span> t20</span><br><span class="line">) tmp1;</span><br></pre></td></tr></table></figure>



<h2 id="二十一、时间序列–取最新完成状态的前一个状态"><a href="#二十一、时间序列–取最新完成状态的前一个状态" class="headerlink" title="二十一、时间序列–取最新完成状态的前一个状态"></a>二十一、时间序列–取最新完成状态的前一个状态</h2><p>表名：t21</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_id  a  b</span><br><span class="line"></span><br><span class="line">2014   1  A</span><br><span class="line"></span><br><span class="line">2015   1  B</span><br><span class="line"></span><br><span class="line">2016   1  A</span><br><span class="line"></span><br><span class="line">2017   1  B</span><br><span class="line"></span><br><span class="line">2013   2  A</span><br><span class="line"></span><br><span class="line">2014   2  B</span><br><span class="line"></span><br><span class="line">2015   2  A</span><br><span class="line"></span><br><span class="line">2014   3  A</span><br><span class="line"></span><br><span class="line">2015   3  A</span><br><span class="line"></span><br><span class="line">2016   3  B</span><br><span class="line"></span><br><span class="line">2017   3  A</span><br></pre></td></tr></table></figure>



<p>上表中B为完成状态。</p>
<h4 id="问题一：取最新完成状态的前一个状态"><a href="#问题一：取最新完成状态的前一个状态" class="headerlink" title="问题一：取最新完成状态的前一个状态"></a>问题一：取最新完成状态的前一个状态</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_id a  b</span><br><span class="line"></span><br><span class="line">2016   1  A</span><br><span class="line"></span><br><span class="line">2013   2  A</span><br><span class="line"></span><br><span class="line">2015   3  A</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<p>此处给出两种解法，其一：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> t21.date_id, t21.a, t21.b</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">max</span>(date_id) <span class="keyword">AS</span> date_id, a</span><br><span class="line">	<span class="keyword">FROM</span> t21</span><br><span class="line">	<span class="keyword">WHERE</span> b <span class="operator">=</span> <span class="string">&#x27;B&#x27;</span></span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> a</span><br><span class="line">) t1</span><br><span class="line">	<span class="keyword">INNER</span> <span class="keyword">JOIN</span> t21</span><br><span class="line">	<span class="keyword">ON</span> t1.date_id <span class="operator">-</span> <span class="number">1</span> <span class="operator">=</span> t21.date_id</span><br><span class="line">		<span class="keyword">AND</span> t1.a <span class="operator">=</span> t21.a;</span><br></pre></td></tr></table></figure>



<p>其二：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> next_date_id <span class="keyword">AS</span> date_id, a, next_b <span class="keyword">AS</span> b</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="operator">*</span>, <span class="built_in">min</span>(nk) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a, b ) <span class="keyword">AS</span> minb</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> <span class="operator">*</span>, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id <span class="keyword">DESC</span>) <span class="keyword">AS</span> nk</span><br><span class="line">			, <span class="built_in">lead</span>(date_id) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id <span class="keyword">DESC</span>) <span class="keyword">AS</span> next_date_id</span><br><span class="line">			, <span class="built_in">lead</span>(b) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id <span class="keyword">DESC</span>) <span class="keyword">AS</span> next_b</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">			<span class="keyword">FROM</span> t21</span><br><span class="line">		) t</span><br><span class="line">	) t</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> minb <span class="operator">=</span> nk</span><br><span class="line">	<span class="keyword">AND</span> b <span class="operator">=</span> <span class="string">&#x27;B&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h4 id="问题二：如何将完成状态的过程合并"><a href="#问题二：如何将完成状态的过程合并" class="headerlink" title="问题二：如何将完成状态的过程合并"></a>问题二：如何将完成状态的过程合并</h4><p>输出结果如下所示:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a  b_merge</span><br><span class="line"></span><br><span class="line">1  A、B、A、B</span><br><span class="line"></span><br><span class="line">2  A、B</span><br><span class="line"></span><br><span class="line">3  A、A、B</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a, collect_list(b) <span class="keyword">AS</span> b</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">		, <span class="built_in">min</span>(if(b <span class="operator">=</span> <span class="string">&#x27;B&#x27;</span>, nk, <span class="keyword">NULL</span>)) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a ) <span class="keyword">AS</span> minb</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> <span class="operator">*</span>, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id <span class="keyword">DESC</span>) <span class="keyword">AS</span> nk</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">			<span class="keyword">FROM</span> t21</span><br><span class="line">		) t</span><br><span class="line">	) t</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> nk <span class="operator">&gt;=</span> minb</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a;</span><br></pre></td></tr></table></figure>



<h2 id="二十二、非等值连接–范围匹配"><a href="#二十二、非等值连接–范围匹配" class="headerlink" title="二十二、非等值连接–范围匹配"></a>二十二、非等值连接–范围匹配</h2><p>表f是事实表，表d是匹配表，在hive中如何将匹配表中的值关联到事实表中？</p>
<p>表d相当于拉链过的变化维，但日期范围可能是不全的。</p>
<p>表f：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_id p_id</span><br><span class="line"></span><br><span class="line"> 2017  C</span><br><span class="line"></span><br><span class="line"> 2018  B</span><br><span class="line"></span><br><span class="line"> 2019  A</span><br><span class="line"></span><br><span class="line"> 2013  C</span><br></pre></td></tr></table></figure>



<p>表d：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">d_start  d_end  p_id  p_value</span><br><span class="line"></span><br><span class="line"> 2016   2018   A    1</span><br><span class="line"></span><br><span class="line"> 2016   2018   B    2</span><br><span class="line"></span><br><span class="line"> 2008   2009   C    4</span><br><span class="line"></span><br><span class="line"> 2010   2015   C    3</span><br></pre></td></tr></table></figure>



<h4 id="问题一：范围匹配"><a href="#问题一：范围匹配" class="headerlink" title="问题一：范围匹配"></a>问题一：范围匹配</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_id p_id  p_value</span><br><span class="line"></span><br><span class="line"> 2017  C   null</span><br><span class="line"></span><br><span class="line"> 2018  B   2</span><br><span class="line"></span><br><span class="line"> 2019  A   null</span><br><span class="line"></span><br><span class="line"> 2013  C   3</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<p>此处给出两种解法，其一：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> f.date_id, f.p_id, A.p_value</span><br><span class="line"><span class="keyword">FROM</span> f</span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> date_id, p_id, p_value</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> f.date_id, f.p_id, d.p_value</span><br><span class="line">			<span class="keyword">FROM</span> f</span><br><span class="line">				<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> d <span class="keyword">ON</span> f.p_id <span class="operator">=</span> d.p_id</span><br><span class="line">			<span class="keyword">WHERE</span> f.date_id <span class="operator">&gt;=</span> d.d_start</span><br><span class="line">				<span class="keyword">AND</span> f.date_id <span class="operator">&lt;=</span> d.d_end</span><br><span class="line">		) A</span><br><span class="line">	) A</span><br><span class="line">	<span class="keyword">ON</span> f.date_id <span class="operator">=</span> A.date_id;</span><br></pre></td></tr></table></figure>



<p>其二：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> date_id, p_id, flag <span class="keyword">AS</span> p_value</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> f.date_id, f.p_id, d.d_start, d.d_end, d.p_value</span><br><span class="line">		, if(f.date_id <span class="keyword">BETWEEN</span> d.d_start <span class="keyword">AND</span> d.d_end, d.p_value, <span class="keyword">NULL</span>) <span class="keyword">AS</span> flag</span><br><span class="line">		, <span class="built_in">max</span>(d.d_end) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> date_id ) <span class="keyword">AS</span> max_end</span><br><span class="line">	<span class="keyword">FROM</span> f</span><br><span class="line">		<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> d <span class="keyword">ON</span> f.p_id <span class="operator">=</span> d.p_id</span><br><span class="line">) tmp</span><br><span class="line"><span class="keyword">WHERE</span> d_end <span class="operator">=</span> max_end;</span><br></pre></td></tr></table></figure>



<h2 id="二十三、非等值连接–最近匹配"><a href="#二十三、非等值连接–最近匹配" class="headerlink" title="二十三、非等值连接–最近匹配"></a>二十三、非等值连接–最近匹配</h2><p>表t23_1和表t23_2通过a和b关联时，有相等的取相等的值匹配，不相等时每一个a的值在b中找差值最小的来匹配。</p>
<p>t23_1和t23_2为两个班的成绩单，t23_1班的每个学生成绩在t23_2班中找出成绩最接近的成绩。</p>
<p>表t23_1：a中无重复值</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a</span><br><span class="line"></span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">2</span><br><span class="line"></span><br><span class="line">4</span><br><span class="line"></span><br><span class="line">5</span><br><span class="line"></span><br><span class="line">8</span><br><span class="line"></span><br><span class="line">10</span><br></pre></td></tr></table></figure>



<p>表t23_2：b中无重复值</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">b</span><br><span class="line"></span><br><span class="line">2</span><br><span class="line"></span><br><span class="line">3</span><br><span class="line"></span><br><span class="line">7</span><br><span class="line"></span><br><span class="line">11</span><br><span class="line"></span><br><span class="line">13</span><br></pre></td></tr></table></figure>



<h4 id="问题一：单向最近匹配"><a href="#问题一：单向最近匹配" class="headerlink" title="问题一：单向最近匹配"></a>问题一：单向最近匹配</h4><p>输出结果如下所示：</p>
<p>注意：b的值可能会被丢弃</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a  b</span><br><span class="line"></span><br><span class="line">1  2</span><br><span class="line"></span><br><span class="line">2  2</span><br><span class="line"></span><br><span class="line">4  3</span><br><span class="line"></span><br><span class="line">5  3</span><br><span class="line"></span><br><span class="line">5  7</span><br><span class="line"></span><br><span class="line">8  7</span><br><span class="line"></span><br><span class="line">10  11</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> ttt1.a, ttt1.b</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> tt1.a, t23_2.b, <span class="built_in">dense_rank</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> tt1.a <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="built_in">abs</span>(tt1.a <span class="operator">-</span> t23_2.b)) <span class="keyword">AS</span> dr</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> t23_1.a</span><br><span class="line">			<span class="keyword">FROM</span> t23_1</span><br><span class="line">				<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t23_2 <span class="keyword">ON</span> t23_1.a <span class="operator">=</span> t23_2.b</span><br><span class="line">			<span class="keyword">WHERE</span> t23_2.b <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line">		) tt1</span><br><span class="line">			<span class="keyword">CROSS</span> <span class="keyword">JOIN</span> t23_2</span><br><span class="line">	) ttt1</span><br><span class="line">	<span class="keyword">WHERE</span> ttt1.dr <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">	<span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">	<span class="keyword">SELECT</span> t23_1.a, t23_2.b</span><br><span class="line">	<span class="keyword">FROM</span> t23_1</span><br><span class="line">		<span class="keyword">INNER</span> <span class="keyword">JOIN</span> t23_2 <span class="keyword">ON</span> t23_1.a <span class="operator">=</span> t23_2.b</span><br><span class="line">) result_t</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> result_t.a;</span><br></pre></td></tr></table></figure>



<h2 id="二十四、N指标–累计去重"><a href="#二十四、N指标–累计去重" class="headerlink" title="二十四、N指标–累计去重"></a>二十四、N指标–累计去重</h2><p>假设表A为事件流水表，客户当天有一条记录则视为当天活跃。</p>
<p>表A：</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> time_id     user_id</span><br><span class="line"></span><br><span class="line">2018-01-01 10:00:00  001</span><br><span class="line"></span><br><span class="line">2018-01-01 11:03:00  002</span><br><span class="line"></span><br><span class="line">2018-01-01 13:18:00  001</span><br><span class="line"></span><br><span class="line">2018-01-02 08:34:00  004</span><br><span class="line"></span><br><span class="line">2018-01-02 10:08:00  002</span><br><span class="line"></span><br><span class="line">2018-01-02 10:40:00  003</span><br><span class="line"></span><br><span class="line">2018-01-02 14:21:00  002</span><br><span class="line"></span><br><span class="line">2018-01-02 15:39:00  004</span><br><span class="line"></span><br><span class="line">2018-01-03 08:34:00  005</span><br><span class="line"></span><br><span class="line">2018-01-03 10:08:00  003</span><br><span class="line"></span><br><span class="line">2018-01-03 10:40:00  001</span><br><span class="line"></span><br><span class="line">2018-01-03 14:21:00  005</span><br></pre></td></tr></table></figure>



<p>假设客户活跃非常，一天产生的事件记录平均达千条。</p>
<h4 id="问题一：累计去重"><a href="#问题一：累计去重" class="headerlink" title="问题一：累计去重"></a>问题一：累计去重</h4><p>输出结果如下所示：</p>
<p>日期    当日活跃人数   月累计活跃人数_截至当日</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_id  user_cnt_act  user_cnt_act_month</span><br><span class="line"></span><br><span class="line">2018-01-01   2        2</span><br><span class="line"></span><br><span class="line">2018-01-02   3        4</span><br><span class="line"></span><br><span class="line">2018-01-03   3        5</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> tt1.date_id</span><br><span class="line">    ,tt2.user_cnt_act</span><br><span class="line">    ,tt1.user_cnt_act_month</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">(  <span class="comment">-- ④ 按照t.date_id分组求出user_cnt_act_month，得到tt1</span></span><br><span class="line"> <span class="keyword">SELECT</span> t.date_id</span><br><span class="line">    ,<span class="built_in">COUNT</span>(user_id) <span class="keyword">AS</span> user_cnt_act_month</span><br><span class="line"> <span class="keyword">FROM</span></span><br><span class="line"> (  <span class="comment">-- ③ 表a和表b进行笛卡尔积，按照a.date_id,b.user_id分组，保证截止到当日的用户唯一，得出表t。</span></span><br><span class="line"> <span class="keyword">SELECT</span> a.date_id</span><br><span class="line">     ,b.user_id</span><br><span class="line"> <span class="keyword">FROM</span></span><br><span class="line"> (  <span class="comment">-- ① 按照日期分组，取出date_id字段当主表的维度字段 得出表a</span></span><br><span class="line">  <span class="keyword">SELECT</span> from_unixtime(unix_timestamp(time_id),<span class="string">&#x27;yyyy-MM-dd&#x27;</span>) <span class="keyword">AS</span> date_id</span><br><span class="line">  <span class="keyword">FROM</span> test.temp_tanhaidi_20211213_1</span><br><span class="line">  <span class="keyword">GROUP</span> <span class="keyword">BY</span> from_unixtime(unix_timestamp(time_id),<span class="string">&#x27;yyyy-MM-dd&#x27;</span>)</span><br><span class="line"> ) a</span><br><span class="line"> <span class="keyword">INNER</span> <span class="keyword">JOIN</span></span><br><span class="line"> (  <span class="comment">-- ② 按照date_id、user_id分组，保证每天每个用户只有一条记录，得出表b</span></span><br><span class="line">  <span class="keyword">SELECT</span> from_unixtime(unix_timestamp(time_id),<span class="string">&#x27;yyyy-MM-dd&#x27;</span>) <span class="keyword">AS</span> date_id</span><br><span class="line">     ,user_id</span><br><span class="line">  <span class="keyword">FROM</span> test.temp_tanhaidi_20211213_1</span><br><span class="line">  <span class="keyword">GROUP</span> <span class="keyword">BY</span> from_unixtime(unix_timestamp(time_id),<span class="string">&#x27;yyyy-MM-dd&#x27;</span>)</span><br><span class="line">      ,user_id</span><br><span class="line"> ) b</span><br><span class="line"> <span class="keyword">ON</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"> <span class="keyword">WHERE</span> a.date_id <span class="operator">&gt;=</span> b.date_id</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> a.date_id</span><br><span class="line">      ,b.user_id</span><br><span class="line"> ) t</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> t.date_id</span><br><span class="line">) tt1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">(  <span class="comment">-- ⑥ 按照date_id分组求出user_cnt_act，得到tt2</span></span><br><span class="line"> <span class="keyword">SELECT</span> date_id</span><br><span class="line">    ,<span class="built_in">COUNT</span>(user_id) <span class="keyword">AS</span> user_cnt_act</span><br><span class="line"> <span class="keyword">FROM</span></span><br><span class="line"> (  <span class="comment">-- ⑤ 按照日期分组，取出date_id字段当主表的维度字段 得出表a</span></span><br><span class="line"> <span class="keyword">SELECT</span> from_unixtime(unix_timestamp(time_id),<span class="string">&#x27;yyyy-MM-dd&#x27;</span>) <span class="keyword">AS</span> date_id</span><br><span class="line">     ,user_id</span><br><span class="line"> <span class="keyword">FROM</span> test.temp_tanhaidi_20211213_1</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> from_unixtime(unix_timestamp(time_id),<span class="string">&#x27;yyyy-MM-dd&#x27;</span>)      ,user_id</span><br><span class="line"> ) a</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> date_id</span><br><span class="line">) tt2</span><br><span class="line"><span class="keyword">ON</span> tt2.date_id <span class="operator">=</span> tt1.date_id</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>BigData</category>
        <category>HQL练习</category>
      </categories>
      <tags>
        <tag>HQL练习</tag>
      </tags>
  </entry>
  <entry>
    <title>大数据常用命令</title>
    <url>/2021/12/23/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h2 id="Linux（vi-vim）"><a href="#Linux（vi-vim）" class="headerlink" title="Linux（vi/vim）"></a>Linux（vi/vim）</h2><h3 id="一般模式"><a href="#一般模式" class="headerlink" title="一般模式"></a>一般模式</h3><table>
<thead>
<tr>
<th>语法</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>yy</td>
<td>复制光标当前一行</td>
</tr>
<tr>
<td>y数字y</td>
<td>复制一段（从第几行到第几行）</td>
</tr>
<tr>
<td>p</td>
<td>箭头移动到目的行粘贴</td>
</tr>
<tr>
<td>u</td>
<td>撤销上一步</td>
</tr>
<tr>
<td>dd</td>
<td>删除光标当前行</td>
</tr>
<tr>
<td>d数字d</td>
<td>删除光标（含）后多少行</td>
</tr>
<tr>
<td>x</td>
<td>删除一个字母，相当于del</td>
</tr>
<tr>
<td>X</td>
<td>删除一个字母，相当于Backspace</td>
</tr>
<tr>
<td>yw</td>
<td>复制一个词</td>
</tr>
<tr>
<td>dw</td>
<td>删除一个词</td>
</tr>
<tr>
<td>shift+^</td>
<td>移动到行头</td>
</tr>
<tr>
<td>shift+$</td>
<td>移动到行尾</td>
</tr>
<tr>
<td>1+shift+g</td>
<td>移动到页头，数字</td>
</tr>
<tr>
<td>shift+g</td>
<td>移动到页尾</td>
</tr>
<tr>
<td>数字N+shift+g</td>
<td>移动到目标行</td>
</tr>
</tbody></table>
<h3 id="编辑模式"><a href="#编辑模式" class="headerlink" title="编辑模式"></a>编辑模式</h3><table>
<thead>
<tr>
<th>按键</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>i</td>
<td>当前光标前</td>
</tr>
<tr>
<td>a</td>
<td>当前光标后</td>
</tr>
<tr>
<td>o</td>
<td>当前光标行的下一行</td>
</tr>
<tr>
<td>I</td>
<td>光标所在行最前</td>
</tr>
<tr>
<td>A</td>
<td>光标所在行最后</td>
</tr>
<tr>
<td>O</td>
<td>当前光标行的上一行</td>
</tr>
</tbody></table>
<h3 id="指令模式"><a href="#指令模式" class="headerlink" title="指令模式"></a>指令模式</h3><table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>:w</td>
<td>保存</td>
</tr>
<tr>
<td>:q</td>
<td>退出</td>
</tr>
<tr>
<td>:!</td>
<td>强制执行</td>
</tr>
<tr>
<td>/要查找的词</td>
<td>n 查找下一个，N 往上查找</td>
</tr>
<tr>
<td>? 要查找的词</td>
<td>n是查找上一个，shift+n是往下查找</td>
</tr>
<tr>
<td>:set nu</td>
<td>显示行号</td>
</tr>
<tr>
<td>:set nonu</td>
<td>关闭行号</td>
</tr>
</tbody></table>
<h3 id="压缩和解压"><a href="#压缩和解压" class="headerlink" title="压缩和解压"></a>压缩和解压</h3><h4 id="gzip-gunzip-压缩"><a href="#gzip-gunzip-压缩" class="headerlink" title="gzip/gunzip 压缩"></a>gzip/gunzip 压缩</h4><p>（1）只能压缩文件不能压缩目录</p>
<p>（2）不保留原来的文件</p>
<p>gzip压缩：gzip hello.txt</p>
<p>gunzip解压缩文件：gunzip hello.txt.gz</p>
<h4 id="zip-unzip-压缩"><a href="#zip-unzip-压缩" class="headerlink" title="zip/unzip 压缩"></a>zip/unzip 压缩</h4><p>可以压缩目录且保留源文件</p>
<p>zip压缩（压缩 1.txt 和2.txt，压缩后的名称为mypackage.zip）：zip hello.zip hello.txt world.txt</p>
<p>unzip解压：unzip hello.zip</p>
<p>unzip解压到指定目录：unzip hello.zip -d /opt</p>
<h4 id="tar-打包"><a href="#tar-打包" class="headerlink" title="tar 打包"></a>tar 打包</h4><p>tar压缩多个文件：tar -zcvf hello.txt world.txt</p>
<p>tar压缩目录：tar -zcvf hello.tar.gz opt/</p>
<p>tar解压到当前目录：tar -zxvf hello.tar.gz</p>
<p>tar解压到指定目录：tar -zxvf hello.tar.gz -C /opt</p>
<h3 id="RPM"><a href="#RPM" class="headerlink" title="RPM"></a>RPM</h3><p>RPM查询命令：rpm -qa |grep firefox</p>
<p>RPM卸载命令：</p>
<p>rpm -e xxxxxx</p>
<p>rpm -e –nodeps xxxxxx（不检查依赖）</p>
<p>RPM安装命令：</p>
<p>rpm -ivh xxxxxx.rpm</p>
<p>rpm -ivh –nodeps fxxxxxx.rpm（–nodeps，不检测依赖进度）</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>-i</td>
<td>-i=install，安装</td>
</tr>
<tr>
<td>-v</td>
<td>-v=verbose，显示详细信息</td>
</tr>
<tr>
<td>-h</td>
<td>-h=hash，进度条</td>
</tr>
<tr>
<td>–nodeps</td>
<td>–nodeps，不检测依赖进度</td>
</tr>
</tbody></table>
<hr>
<h2 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h2><h3 id="输入-输出重定向"><a href="#输入-输出重定向" class="headerlink" title="输入/输出重定向"></a>输入/输出重定向</h3><table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>command &gt; file</td>
<td>将输出重定向到 file</td>
</tr>
<tr>
<td>command &lt; file</td>
<td>将输入重定向到 file</td>
</tr>
<tr>
<td>command &gt;&gt; file</td>
<td>将输出以追加的方式重定向到 file</td>
</tr>
<tr>
<td>n &gt; file</td>
<td>将文件描述符为 n 的文件重定向到 file</td>
</tr>
<tr>
<td>n &gt;&gt; file</td>
<td>将文件描述符为 n 的文件以追加的方式重定向到 file</td>
</tr>
<tr>
<td>n &gt;&amp; m</td>
<td>将输出文件 m 和 n 合并</td>
</tr>
<tr>
<td>n &lt;&amp; m</td>
<td>将输入文件 m 和 n 合并</td>
</tr>
<tr>
<td>&lt;&lt; tag</td>
<td>将开始标记 tag 和结束标记 tag 之间的内容作为输入</td>
</tr>
</tbody></table>
<h3 id="脚本编辑"><a href="#脚本编辑" class="headerlink" title="脚本编辑"></a>脚本编辑</h3><table>
<thead>
<tr>
<th>快捷方式</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>shift</td>
<td>参数左移</td>
</tr>
<tr>
<td>$@</td>
<td>所有的参数</td>
</tr>
<tr>
<td>$#</td>
<td>参数的个数</td>
</tr>
</tbody></table>
<hr>
<h2 id="Hadoop"><a href="#Hadoop" class="headerlink" title="Hadoop"></a>Hadoop</h2><h3 id="启动类命令"><a href="#启动类命令" class="headerlink" title="启动类命令"></a>启动类命令</h3><table>
<thead>
<tr>
<th>功能说明</th>
<th>命令脚本</th>
</tr>
</thead>
<tbody><tr>
<td>启动hdfs集群</td>
<td>sbin/start-dfs.sh</td>
</tr>
<tr>
<td>启动yarn</td>
<td>sbin/start-yarn.sh</td>
</tr>
</tbody></table>
<h3 id="hadoop-fs-hdfs-dfs-命令"><a href="#hadoop-fs-hdfs-dfs-命令" class="headerlink" title="hadoop fs/hdfs dfs 命令"></a>hadoop fs/hdfs dfs 命令</h3><table>
<thead>
<tr>
<th>功能说明</th>
<th>命令</th>
</tr>
</thead>
<tbody><tr>
<td>创建目录</td>
<td>hdfs dfs -mkdir -p /data/flink</td>
</tr>
<tr>
<td>显示目录</td>
<td>hdfs dfs -ls /</td>
</tr>
<tr>
<td>从HDFS拷贝到本地</td>
<td>hdfs dfs -copyToLocal /data/data.txt ./</td>
</tr>
<tr>
<td>文件上传到集群(从本地)</td>
<td>hhdfs dfs -copyFromLocal data.txt /</td>
</tr>
<tr>
<td>文件下载</td>
<td>hdfs dfs -get /data/flink</td>
</tr>
<tr>
<td>删除集群的文件</td>
<td>hdfs dfs -rm /data/flink</td>
</tr>
<tr>
<td>删除文件夹</td>
<td>hdfs dfs -rm -r -skipTrash /data</td>
</tr>
<tr>
<td>从本地剪切粘贴到HDFS</td>
<td>hdfs dfs  -moveFromLocal data.txt /data/</td>
</tr>
<tr>
<td>追加一个文件到已经存在的文件末尾hdfs dfs -appendToFile data1.txt /data/data.txt</td>
<td></td>
</tr>
<tr>
<td>显示文件内容</td>
<td>hdfs dfs -cat data.txt</td>
</tr>
<tr>
<td>修改文件所属权限</td>
<td>hdfs dfs  -chmod  777 xxx.sh</td>
</tr>
<tr>
<td>修改文件所属用户组</td>
<td>hdfs dfs  -chown  root:root data.txt</td>
</tr>
<tr>
<td>从HDFS的一个路径拷贝到HDFS的另一个路径</td>
<td>hdfs dfs -cp data.txt /data1.txt</td>
</tr>
<tr>
<td>在HDFS目录中移动文件</td>
<td>hdfs dfs -mv data.txt /opt/</td>
</tr>
<tr>
<td>合并下载多个文件</td>
<td>hdfs dfs  -getmerge /data/* ./data_merge.txt</td>
</tr>
<tr>
<td>hadoop fs -put</td>
<td>等同于copyFromLocal</td>
</tr>
<tr>
<td>显示一个文件的末尾</td>
<td>hdfs dfs -tail data.txt</td>
</tr>
<tr>
<td>删除文件或文件夹</td>
<td>hdfs dfs -rm /data/data.txt</td>
</tr>
<tr>
<td>删除空目录</td>
<td>hdfs dfs -rmdir /data</td>
</tr>
<tr>
<td>统计文件夹的大小信息</td>
<td>hdfs dfs -s -h /data</td>
</tr>
<tr>
<td>统计文件夹下的文件大小信息</td>
<td>hdfs dfs  -h /data</td>
</tr>
<tr>
<td>设置HDFS中文件的副本数量</td>
<td>hdfs dfs -setrep 3 /data/data.txt</td>
</tr>
</tbody></table>
<h3 id="yarn命令"><a href="#yarn命令" class="headerlink" title="yarn命令"></a>yarn命令</h3><table>
<thead>
<tr>
<th>功能说明</th>
<th>命令</th>
</tr>
</thead>
<tbody><tr>
<td>查看正在运行的yarn任务列表</td>
<td>yarn application -list appID</td>
</tr>
<tr>
<td>kill掉指定id的yarn任务</td>
<td>yarn application -kill appID</td>
</tr>
<tr>
<td>查看任务日志信息</td>
<td>yarn logs -applicationId appID</td>
</tr>
</tbody></table>
<hr>
<h2 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h2><h3 id="启动命令"><a href="#启动命令" class="headerlink" title="启动命令"></a>启动命令</h3><table>
<thead>
<tr>
<th>功能说明</th>
<th>命令脚本</th>
</tr>
</thead>
<tbody><tr>
<td>启动zookeeper服务</td>
<td>zkServer.sh start</td>
</tr>
<tr>
<td>查看zookeeper状态</td>
<td>zkServer.sh status</td>
</tr>
<tr>
<td>停止zookeeper服务</td>
<td>zkServer.sh stop</td>
</tr>
<tr>
<td>启动zookeeper客户端</td>
<td>zkCli.sh -server 127.0.0.1:2181</td>
</tr>
<tr>
<td>退出zookeeper客户端</td>
<td>quit</td>
</tr>
</tbody></table>
<h3 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h3><table>
<thead>
<tr>
<th>功能说明</th>
<th>命令脚本</th>
</tr>
</thead>
<tbody><tr>
<td>当前znode中所包含的内容</td>
<td>ls /</td>
</tr>
<tr>
<td>创建普通节点(前面是节点的路径，后面是值）</td>
<td>create /bigdata/flink “flink”</td>
</tr>
<tr>
<td>获取节点的值</td>
<td>get /bigdata</td>
</tr>
<tr>
<td>修改节点的值</td>
<td>set /bigdata/flink “flinksql”</td>
</tr>
<tr>
<td>删除节点</td>
<td>delete /bigdata/flink</td>
</tr>
<tr>
<td>递归删除节点</td>
<td>rmr /bigdata</td>
</tr>
</tbody></table>
<h3 id="四字母命令"><a href="#四字母命令" class="headerlink" title="四字母命令"></a>四字母命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td>conf</td>
<td>zk服务配置的详细信息</td>
<td>echo conf | nc 127.0.0.1 2181</td>
</tr>
<tr>
<td>stat</td>
<td>客户端与zk连接的简要信息</td>
<td>参考上面</td>
</tr>
<tr>
<td>srvr</td>
<td>zk服务的详细信息</td>
<td>参考上面</td>
</tr>
<tr>
<td>cons</td>
<td>客户端与zk连接的详细信息</td>
<td>参考上面</td>
</tr>
<tr>
<td>mntr</td>
<td>zk服务目前的性能状况</td>
<td>参考上面</td>
</tr>
<tr>
<td>crst</td>
<td>重置当前的所有连接、会话</td>
<td>参考上面</td>
</tr>
<tr>
<td>dump</td>
<td>列出未经处理的会话和连接信息</td>
<td>参考上面</td>
</tr>
<tr>
<td>envi</td>
<td>列出zk的版本信息、主机名称、Java版本、服务器名称等等</td>
<td>参考上面</td>
</tr>
<tr>
<td>ruok</td>
<td>测试服务器是否正在运行，如果在运行返回imok，否则返回空</td>
<td>参考上面</td>
</tr>
<tr>
<td>srst</td>
<td>重置Zookeeper的所有统计信息</td>
<td>参考上面</td>
</tr>
<tr>
<td>wchs</td>
<td>列出watch的总数，连接数</td>
<td>参考上面</td>
</tr>
<tr>
<td>wchp</td>
<td>列出所有watch的路径及sessionID</td>
<td>参考上面</td>
</tr>
<tr>
<td>mntr</td>
<td>列出集群的关键性能数据，包括zk的版本、node数量、临时节点数等等</td>
<td>参考上面</td>
</tr>
</tbody></table>
<hr>
<h2 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h2><p><strong>注:</strong> 这里机器我只写一个。命令你们也可使用 ./bin/xx.sh (如：./bin/kafka-topics.sh) </p>
<h3 id="查看当前服务器中的所有topic"><a href="#查看当前服务器中的所有topic" class="headerlink" title="查看当前服务器中的所有topic"></a>查看当前服务器中的所有topic</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-topics --zookeeper xxxxxx:2181 --list --exclude-internal </span><br><span class="line"></span><br><span class="line">说明：</span><br><span class="line"></span><br><span class="line">exclude-internal：排除kafka内部topic</span><br><span class="line"></span><br><span class="line">比如： --exclude-internal  --topic &quot;test_.*&quot;</span><br></pre></td></tr></table></figure>

<h3 id="创建topic"><a href="#创建topic" class="headerlink" title="创建topic"></a>创建topic</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-topics --zookeeper xxxxxx:2181  --create </span><br><span class="line">--replication-factor </span><br><span class="line">--partitions 1 </span><br><span class="line">--topic topic_name</span><br><span class="line"></span><br><span class="line">说明：</span><br><span class="line"></span><br><span class="line">--topic 定义topic名</span><br><span class="line"></span><br><span class="line">--replication-factor  定义副本数</span><br><span class="line"></span><br><span class="line">--partitions  定义分区数</span><br></pre></td></tr></table></figure>

<h3 id="删除topic"><a href="#删除topic" class="headerlink" title="删除topic"></a>删除topic</h3><p><strong>注意:</strong> 需要server.properties中设置delete.topic.enable=true否则只是标记删除</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-topics --zookeeper xxxxxx:2181 --delete --topic topic_name</span><br></pre></td></tr></table></figure>

<h3 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-console-producer --broker-list xxxxxx:9092 --topic topic_name</span><br><span class="line"></span><br><span class="line">可加：--property parse.key=true（有key消息）</span><br></pre></td></tr></table></figure>

<h3 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-console-consumer --bootstrap-server xxxxxx:9092 --topic topic_name</span><br><span class="line"></span><br><span class="line">注：可选</span><br><span class="line"></span><br><span class="line">--from-beginning：会把主题中以往所有的数据都读取出来</span><br><span class="line"></span><br><span class="line">--whitelist &#x27;.*&#x27; ：消费所有的topic</span><br><span class="line"></span><br><span class="line">--property print.key=true：显示key进行消费</span><br><span class="line"></span><br><span class="line">--partition 0：指定分区消费</span><br><span class="line"></span><br><span class="line">--offset：指定起始偏移量消费</span><br></pre></td></tr></table></figure>

<h3 id="查看某个Topic的详情"><a href="#查看某个Topic的详情" class="headerlink" title="查看某个Topic的详情"></a>查看某个Topic的详情</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-topics --zookeeper xxxxxx:2181 --describe --topic topic_name</span><br></pre></td></tr></table></figure>

<h3 id="修改分区数"><a href="#修改分区数" class="headerlink" title="修改分区数"></a>修改分区数</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-topics --zookeeper xxxxxx:2181 --alter --topic topic_name --partitions 6</span><br></pre></td></tr></table></figure>

<h3 id="查看某个消费者组信息"><a href="#查看某个消费者组信息" class="headerlink" title="查看某个消费者组信息"></a>查看某个消费者组信息</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-consumer-groups --bootstrap-server  xxxxxx:9092  --describe --group group_name </span><br></pre></td></tr></table></figure>

<h3 id="删除消费者组"><a href="#删除消费者组" class="headerlink" title="删除消费者组"></a>删除消费者组</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-consumer-groups --bootstrap-server  xxxxxx:9092  ---delete --group group_name </span><br></pre></td></tr></table></figure>

<h3 id="重置offset"><a href="#重置offset" class="headerlink" title="重置offset"></a>重置offset</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-consumer-groups --bootstrap-server  xxxxxx:9092  --group group_name--reset-offsets --all-topics --to-latest --execute </span><br></pre></td></tr></table></figure>

<h3 id="leader重新选举"><a href="#leader重新选举" class="headerlink" title="leader重新选举"></a>leader重新选举</h3><p>指定Topic指定分区用重新PREFERRED：优先副本策略 进行Leader重选举</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-leader-election --bootstrap-server xxxxxx:9092 --topic topic_name --election-type PREFERRED --partition 0</span><br></pre></td></tr></table></figure>

<p>所有Topic所有分区用重新PREFERRED：优先副本策略 进行Leader重选举</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-leader-election --bootstrap-server xxxxxx:9092 --election-type preferred  --all-topic-partitions</span><br></pre></td></tr></table></figure>

<h3 id="查询kafka版本信息"><a href="#查询kafka版本信息" class="headerlink" title="查询kafka版本信息"></a>查询kafka版本信息</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-configs --bootstrap-server xxxxxx:9092--describe --version</span><br></pre></td></tr></table></figure>

<h3 id="增删改配置"><a href="#增删改配置" class="headerlink" title="增删改配置"></a>增删改配置</h3><table>
<thead>
<tr>
<th>功能说明</th>
<th>参数</th>
</tr>
</thead>
<tbody><tr>
<td>选择类型</td>
<td>–entity-type (topics/clients/users/brokers/broker- loggers)</td>
</tr>
<tr>
<td>类型名称</td>
<td>–entity-name</td>
</tr>
<tr>
<td>删除配置</td>
<td>–delete-config k1=v1,k2=v2</td>
</tr>
<tr>
<td>添加/修改配置</td>
<td>–add-config k1,k2</td>
</tr>
</tbody></table>
<p>topic添加/修改动态配置</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-configs --bootstrap-server xxxxxx:9092--alter --entity-type topics --entity-name topic_name --add-config file.delete.delay.ms=222222,retention.ms=999999</span><br></pre></td></tr></table></figure>

<p>topic删除动态配置</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-configs --bootstrap-server xxxxxx:9092 --alter --entity-type topics --entity-name topic_name --delete-config file.delete.delay.ms,retention.ms</span><br></pre></td></tr></table></figure>

<h3 id="持续批量拉取消息"><a href="#持续批量拉取消息" class="headerlink" title="持续批量拉取消息"></a>持续批量拉取消息</h3><p>单次最大消费10条消息(不加参数意为持续消费)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-verifiable-consumer --bootstrap-server xxxxxx:9092 --group group_name--topic topic_name --max-messages 10</span><br></pre></td></tr></table></figure>

<h3 id="删除指定分区的消息"><a href="#删除指定分区的消息" class="headerlink" title="删除指定分区的消息"></a>删除指定分区的消息</h3><p>删除指定topic的某个分区的消息删除至offset为1024</p>
<p>json文件offset-json-file.json</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;    &quot;partitions&quot;: [        &#123;            &quot;topic&quot;: &quot;topic_name&quot;,            &quot;partition&quot;: 0,            &quot;offset&quot;: 1024        &#125;    ],    &quot;version&quot;: 1&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-delete-records --bootstrap-server xxxxxx:9092 --offset-json-file offset-json-file.json</span><br></pre></td></tr></table></figure>

<h3 id="查看Broker磁盘信息"><a href="#查看Broker磁盘信息" class="headerlink" title="查看Broker磁盘信息"></a>查看Broker磁盘信息</h3><p>查询指定topic磁盘信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-log-dirs --bootstrap-server xxxxxx:9090 --describe --topic-list topic1,topic2</span><br></pre></td></tr></table></figure>

<p>查询指定Broker磁盘信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kafka-log-dirs --bootstrap-server xxxxxx:9090 --describe --topic-list topic1 --broker-list 0</span><br></pre></td></tr></table></figure>

<h2 id="Hive"><a href="#Hive" class="headerlink" title="Hive"></a>Hive</h2><h3 id="启动类"><a href="#启动类" class="headerlink" title="启动类"></a>启动类</h3><table>
<thead>
<tr>
<th>功能说明</th>
<th>命令</th>
</tr>
</thead>
<tbody><tr>
<td>启动hiveserver2服务</td>
<td>bin/hiveserver2</td>
</tr>
<tr>
<td>启动beeline</td>
<td>bin/beeline</td>
</tr>
<tr>
<td>连接hiveserver2</td>
<td>beeline&gt; !connect jdbc:hive2://hadoop102:10000</td>
</tr>
<tr>
<td>metastroe服务</td>
<td>bin/hive –service metastore</td>
</tr>
</tbody></table>
<p>hive 启动元数据服务（metastore和hiveserver2）和优雅关闭脚本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">启动： hive.sh start关闭： hive.sh stop重启： hive.sh restart状态： hive.sh status</span><br></pre></td></tr></table></figure>

<p>脚本如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bashHIVE_LOG_DIR=$HIVE_HOME/logsmkdir -p $HIVE_LOG_DIR#检查进程是否运行正常，参数1为进程名，参数2为进程端口function check_process()&#123;    pid=$(ps -ef 2&gt;/dev/null | grep -v grep | grep -i $1 | awk &#x27;&#123;print $2&#125;&#x27;)    ppid=$(netstat -nltp 2&gt;/dev/null | grep $2 | awk &#x27;&#123;print $7&#125;&#x27; | cut -d &#x27;/&#x27; -f 1)    echo $pid    [[ &quot;$pid&quot; =~ &quot;$ppid&quot; ]] &amp;&amp; [ &quot;$ppid&quot; ] &amp;&amp; return 0 || return 1&#125;function hive_start()&#123;    metapid=$(check_process HiveMetastore 9083)    cmd=&quot;nohup hive --service metastore &gt;$HIVE_LOG_DIR/metastore.log 2&gt;&amp;1 &amp;&quot;    cmd=$cmd&quot; sleep4; hdfs dfsadmin -safemode wait &gt;/dev/null 2&gt;&amp;1&quot;    [ -z &quot;$metapid&quot; ] &amp;&amp; eval $cmd || echo &quot;Metastroe服务已启动&quot;    server2pid=$(check_process HiveServer2 10000)    cmd=&quot;nohup hive --service hiveserver2 &gt;$HIVE_LOG_DIR/hiveServer2.log 2&gt;&amp;1 &amp;&quot;    [ -z &quot;$server2pid&quot; ] &amp;&amp; eval $cmd || echo &quot;HiveServer2服务已启动&quot;&#125;function hive_stop()&#123;    metapid=$(check_process HiveMetastore 9083)    [ &quot;$metapid&quot; ] &amp;&amp; kill $metapid || echo &quot;Metastore服务未启动&quot;    server2pid=$(check_process HiveServer2 10000)    [ &quot;$server2pid&quot; ] &amp;&amp; kill $server2pid || echo &quot;HiveServer2服务未启动&quot;&#125;case $1 in&quot;start&quot;)    hive_start    ;;&quot;stop&quot;)    hive_stop    ;;&quot;restart&quot;)    hive_stop    sleep 2    hive_start    ;;&quot;status&quot;)    check_process HiveMetastore 9083 &gt;/dev/null &amp;&amp; echo &quot;Metastore服务运行正常&quot; || echo &quot;Metastore服务运行异常&quot;    check_process HiveServer2 10000 &gt;/dev/null &amp;&amp; echo &quot;HiveServer2服务运行正常&quot; || echo &quot;HiveServer2服务运行异常&quot;    ;;*)    echo Invalid Args!    echo &#x27;Usage: &#x27;$(basename $0)&#x27; start|stop|restart|status&#x27;    ;;esac</span><br></pre></td></tr></table></figure>

<h3 id="常用交互命令"><a href="#常用交互命令" class="headerlink" title="常用交互命令"></a>常用交互命令</h3><table>
<thead>
<tr>
<th>功能说明</th>
<th>命令</th>
</tr>
</thead>
<tbody><tr>
<td>不进入hive的交互窗口执行sql</td>
<td>bin/hive -e “sql语句”</td>
</tr>
<tr>
<td>执行脚本中sql语句</td>
<td>bin/hive -f hive.sql</td>
</tr>
<tr>
<td>退出hive窗口</td>
<td>exit 或 quit</td>
</tr>
<tr>
<td>命令窗口中查看hdfs文件系统</td>
<td>dfs -ls /</td>
</tr>
<tr>
<td>命令窗口中查看hdfs文件系统</td>
<td>! ls /data/h</td>
</tr>
</tbody></table>
<h3 id="SQL类-特殊的"><a href="#SQL类-特殊的" class="headerlink" title="SQL类(特殊的)"></a>SQL类(特殊的)</h3><table>
<thead>
<tr>
<th>说明</th>
<th>语句</th>
</tr>
</thead>
<tbody><tr>
<td>查看hive中的所有数据库</td>
<td>show databases</td>
</tr>
<tr>
<td>用default数据库</td>
<td>use default</td>
</tr>
<tr>
<td>查询表结构</td>
<td>desc table_name</td>
</tr>
<tr>
<td>查看数据库</td>
<td>show databases</td>
</tr>
<tr>
<td>重命名表名</td>
<td>alter table table1 rename to table2</td>
</tr>
<tr>
<td>修改表中字段</td>
<td>alter table table_name change name user_name String</td>
</tr>
<tr>
<td>修改字段类型</td>
<td>alter table table_name change salary salary Double</td>
</tr>
<tr>
<td>创建外部表</td>
<td>create external table ….</td>
</tr>
<tr>
<td>查询外部表信息</td>
<td>desc formatted outsidetable</td>
</tr>
<tr>
<td>创建视图</td>
<td>create view view_name as select * from table_name …..</td>
</tr>
<tr>
<td>添加数据</td>
<td>load data local inpath ‘xxx’  overwrite into table table_name partition(day=’2021-12-01’)</td>
</tr>
</tbody></table>
<h3 id="内置函数"><a href="#内置函数" class="headerlink" title="内置函数"></a>内置函数</h3><p>（1） NVL</p>
<p>给值为NULL的数据赋值，它的格式是NVL( value，default_value)。它的功能是如果value为NULL，则NVL函数返回default_value的值，否则返回value的值，如果两个参数都为NULL ，则返回NULL</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select nvl(column, 0) from xxx；</span><br></pre></td></tr></table></figure>

<p>（2）行转列</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>CONCAT(string A/col, string B/col…)</td>
<td>返回输入字符串连接后的结果，支持任意个输入字符串</td>
</tr>
<tr>
<td>CONCAT_WS(separator, str1, str2,…)</td>
<td>第一个参数参数间的分隔符，如果分隔符是 NULL，返回值也将为 NULL。这个函数会跳过分隔符参数后的任何 NULL 和空字符串。分隔符将被加到被连接的字符串之间。</td>
</tr>
<tr>
<td>COLLECT_SET(col)</td>
<td>将某字段的值进行去重汇总，产生array类型字段</td>
</tr>
<tr>
<td>COLLECT_LIST(col)</td>
<td>函数只接受基本数据类型，它的主要作用是将某字段的值进行不去重汇总，产生array类型字段。</td>
</tr>
</tbody></table>
<p>（3）列转行(一列转多行)</p>
<p><strong>Split(str, separator)：</strong> 将字符串按照后面的分隔符切割，转换成字符array。</p>
<p><strong>EXPLODE(col)：</strong><br>将hive一列中复杂的array或者map结构拆分成多行。</p>
<p><strong>LATERAL VIEW</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">用法：LATERAL VIEW udtf(expression) tableAlias AS columnAlias</span><br></pre></td></tr></table></figure>

<p>解释：lateral view用于和split, explode等UDTF一起使用，它能够将一行数据拆成多行数据，在此基础上可以对拆分后的数据进行聚合。</p>
<p>lateral view首先为原始表的每行调用UDTF，UDTF会把一行拆分成一或者多行，lateral view再把结果组合，产生一个支持别名表的虚拟表。</p>
<p><strong>准备数据源测试</strong></p>
<table>
<thead>
<tr>
<th>movie</th>
<th>category</th>
</tr>
</thead>
<tbody><tr>
<td>《功勋》</td>
<td>记录,剧情</td>
</tr>
<tr>
<td>《战狼2》</td>
<td>战争,动作,灾难</td>
</tr>
</tbody></table>
<p><strong>SQL</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT movie,category_name FROM movie_info lateral VIEWexplode(split(category,&quot;,&quot;)) movie_info_tmp  AS category_name ;</span><br></pre></td></tr></table></figure>

<p><strong>测试结果</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">《功勋》      记录《功勋》      剧情《战狼2》     战争《战狼2》     动作《战狼2》     灾难</span><br></pre></td></tr></table></figure>

<h3 id="窗口函数"><a href="#窗口函数" class="headerlink" title="窗口函数"></a>窗口函数</h3><p>（1）OVER()</p>
<p>定分析函数工作的数据窗口大小，这个数据窗口大小可能会随着行的变而变化。</p>
<p>（2）CURRENT ROW（当前行）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">n PRECEDING：往前n行数据n FOLLOWING：往后n行数据</span><br></pre></td></tr></table></figure>

<p>（3）UNBOUNDED（无边界）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UNBOUNDED PRECEDING 前无边界，表示从前面的起点UNBOUNDED FOLLOWING后无边界，表示到后面的终点</span><br></pre></td></tr></table></figure>

<p><strong>SQL案例：由起点到当前行的聚合</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select     sum(money) over(partition by user_id order by pay_time rows between UNBOUNDED PRECEDING and current row) from or_order;</span><br></pre></td></tr></table></figure>

<p><strong>SQL案例：当前行和前面一行做聚合</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select     sum(money) over(partition by user_id order by pay_time rows between 1 PRECEDING and current row) from or_order;</span><br></pre></td></tr></table></figure>

<p><strong>SQL案例：当前行和前面一行和后一行做聚合</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select     sum(money) over(partition by user_id order by pay_time rows between 1 PRECEDING AND 1 FOLLOWING )from or_order;</span><br></pre></td></tr></table></figure>

<p><strong>SQL案例：当前行及后面所有行</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select     sum(money) over(partition by user_id order by pay_time rows between current row and UNBOUNDED FOLLOWING  )from or_order;</span><br></pre></td></tr></table></figure>

<p>（4）LAG(col,n,default_val)</p>
<p>往前第n行数据，没有的话default_val</p>
<p>（5）LEAD(col,n, default_val)</p>
<p>往后第n行数据，没有的话default_val</p>
<p><strong>SQL案例：查询用户购买明细以及上次的购买时间和下次购买时间</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select 	user_id,,pay_time,money,		lag(pay_time,1,&#x27;1970-01-01&#x27;) over(PARTITION by name order by pay_time) prev_time,		lead(pay_time,1,&#x27;1970-01-01&#x27;) over(PARTITION by name order by pay_time) next_timefrom or_order;</span><br></pre></td></tr></table></figure>

<p>（6）FIRST_VALUE(col,true/false)</p>
<p>当前窗口下的第一个值，第二个参数为true，跳过空值。</p>
<p>（7）LAST_VALUE (col,true/false)</p>
<p>当前窗口下的最后一个值，第二个参数为true，跳过空值。</p>
<p><strong>SQL案例：查询用户每个月第一次的购买时间 和 每个月的最后一次购买时间</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select	FIRST_VALUE(pay_time) 	    over(	        partition by user_id,month(pay_time) order by pay_time 	        rows between UNBOUNDED PRECEDING and UNBOUNDED FOLLOWING	        ) first_time,		LAST_VALUE(pay_time) 	    over(partition by user_id,month(pay_time) order by pay_time rows between UNBOUNDED PRECEDING and UNBOUNDED FOLLOWING	    ) last_timefrom or_order;</span><br></pre></td></tr></table></figure>


<p>（8）NTILE(n)</p>
<p>把有序窗口的行分发到指定数据的组中，各个组有编号，编号从1开始，对于每一行，NTILE返回此行所属的组的编号。（用于将分组数据按照顺序切分成n片，返回当前切片值）</p>
<p><strong>SQL案例：查询前25%时间的订单信息</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * from (    select User_id,pay_time,money,        ntile(4) over(order by pay_time) sorted        from or_order) twhere sorted = 1;</span><br></pre></td></tr></table></figure>

<h3 id="4个By"><a href="#4个By" class="headerlink" title="4个By"></a>4个By</h3><p>（1）Order By</p>
<p>全局排序，只有一个Reducer。</p>
<p>（2）Sort By</p>
<p>分区内有序。</p>
<p>（3）Distrbute By</p>
<p>类似MR中Partition，进行分区，结合sort by使用。</p>
<p>（4） Cluster By</p>
<p>当Distribute by和Sorts by字段相同时，可以使用Cluster by方式。Cluster by除了具有Distribute by的功能外还兼具Sort by的功能。但是排序只能是升序排序，不能指定排序规则为ASC或者DESC。</p>
<p>在生产环境中Order By用的比较少，容易导致OOM。</p>
<p>在生产环境中Sort By+ Distrbute By用的多。</p>
<h3 id="排序函数"><a href="#排序函数" class="headerlink" title="排序函数"></a>排序函数</h3><p>（1）RANK() </p>
<p>排序相同时会重复，总数不会变</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">11335</span><br></pre></td></tr></table></figure>

<p>（2）DENSE_RANK() </p>
<p>排序相同时会重复，总数会减少</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">11223</span><br></pre></td></tr></table></figure>

<p>（3）ROW_NUMBER()</p>
<p>会根据顺序计算</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">12345</span><br></pre></td></tr></table></figure>

<h3 id="日期函数"><a href="#日期函数" class="headerlink" title="日期函数"></a>日期函数</h3><p>datediff：返回结束日期减去开始日期的天数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">datediff(string enddate, string startdate) select datediff(&#x27;2021-11-20&#x27;,&#x27;2021-11-22&#x27;) </span><br></pre></td></tr></table></figure>

<p>date_add：返回开始日期startdate增加days天后的日期</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_add(string startdate, int days) select date_add(&#x27;2021-11-20&#x27;,3) </span><br></pre></td></tr></table></figure>

<p>date_sub：返回开始日期startdate减少days天后的日期</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">date_sub (string startdate, int days) select date_sub(&#x27;2021-11-22&#x27;,3)</span><br></pre></td></tr></table></figure>

<h2 id="Impala-时间处理，可类比到hive可用"><a href="#Impala-时间处理，可类比到hive可用" class="headerlink" title="Impala(时间处理，可类比到hive可用)"></a>Impala(时间处理，可类比到hive可用)</h2><h3 id="1-获取当前时间"><a href="#1-获取当前时间" class="headerlink" title="1. 获取当前时间"></a>1. 获取当前时间</h3><p>timestamp 样式2021-12-10 04:36:48.147046000</p>
<p>bigint 样式 1639110956</p>
<table>
<thead>
<tr>
<th>函数/方法</th>
<th>输出类型</th>
<th>说明/样式</th>
</tr>
</thead>
<tbody><tr>
<td>current_timestamp()</td>
<td>timestamp</td>
<td>所在时区的当前时间</td>
</tr>
<tr>
<td>now()</td>
<td>timestamp</td>
<td>所在时区的当前时间</td>
</tr>
<tr>
<td>unix_timestamp()</td>
<td>bigint</td>
<td>所在时区的当前时间戳</td>
</tr>
<tr>
<td>utc_timestamp</td>
<td>timestamp</td>
<td>UTC时区的当前时间</td>
</tr>
<tr>
<td>timeofday()</td>
<td>string</td>
<td>Fri Dec 10 12:39:46 2021 CST</td>
</tr>
</tbody></table>
<h3 id="2-获取时间指定单位函数"><a href="#2-获取时间指定单位函数" class="headerlink" title="2. 获取时间指定单位函数"></a>2. 获取时间指定单位函数</h3><table>
<thead>
<tr>
<th>序号</th>
<th>函数/方法</th>
<th>输出类型</th>
<th>说明/样式</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>year(timestamp/date)</td>
<td>int</td>
<td>获取年 yyyy</td>
</tr>
<tr>
<td>2</td>
<td>quarter(timestamp/date)</td>
<td>int</td>
<td>获取季节（1,2,3,4）</td>
</tr>
<tr>
<td>3</td>
<td>month(timestamp/date)</td>
<td>int</td>
<td>获取月</td>
</tr>
<tr>
<td>4</td>
<td>monthname(timestamp/date)</td>
<td>string</td>
<td>获取月份名称 December</td>
</tr>
<tr>
<td>5</td>
<td>week(timestamp/date)</td>
<td>int</td>
<td>获取周（1-53）</td>
</tr>
<tr>
<td>6</td>
<td>weekofyear(timestamp/date)</td>
<td>int</td>
<td>获取周（1-53）</td>
</tr>
<tr>
<td>7</td>
<td>dayofweek(timestamp/date)</td>
<td>int</td>
<td>获取天（本周第多少天,周日算第一天）</td>
</tr>
<tr>
<td>8</td>
<td>dayname(timestamp/date)</td>
<td>string</td>
<td>获取天（星期几）Friday</td>
</tr>
<tr>
<td>9</td>
<td>next_day(timestamp/date, 10</td>
<td>day(string))</td>
<td>timestamp/date</td>
</tr>
<tr>
<td>11</td>
<td>day(timestamp/date)</td>
<td>int</td>
<td>获取天（本月第多少天）</td>
</tr>
<tr>
<td>12</td>
<td>dayofmonth(timestamp/date)</td>
<td>int</td>
<td>获取天（本月第多少天）</td>
</tr>
<tr>
<td>13</td>
<td>last_day(timestamp/date)</td>
<td>timestamp/date</td>
<td>获取天（本月的最后一天日期）</td>
</tr>
<tr>
<td>14</td>
<td>dayofyear(timestamp/date)</td>
<td>int</td>
<td>获取天（本年第多少天）</td>
</tr>
<tr>
<td>15</td>
<td>hour(timestamp/date)</td>
<td>int</td>
<td>获取小时</td>
</tr>
<tr>
<td>16</td>
<td>minute(timestamp date)</td>
<td>int</td>
<td>获取分钟</td>
</tr>
<tr>
<td>17</td>
<td>second(timestamp date)</td>
<td>int</td>
<td>获取秒</td>
</tr>
<tr>
<td>18</td>
<td>millisecond(timestamp date)</td>
<td>int</td>
<td>获取毫秒</td>
</tr>
<tr>
<td>19</td>
<td>extract (YEAR FROM timestamp)</td>
<td>bigint</td>
<td>获取参数指定的时间单位 YEAR MONTH DAY  HOUR MINUTE SECOND</td>
</tr>
<tr>
<td>20</td>
<td>date_part(‘year’,timestamp)</td>
<td>bigint</td>
<td>获取参数指定的时间单位 YEAR MONTH DAY  HOUR MINUTE SECOND</td>
</tr>
<tr>
<td>21</td>
<td>trunc(timestamp/date,unit)</td>
<td>timestamp/date</td>
<td>获取截断为指定单位的时间</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>unit</th>
<th>截取说明</th>
</tr>
</thead>
<tbody><tr>
<td>SYYYY，YYYY，YEAR，SYEAR，YYY，YY，Y</td>
<td>年</td>
</tr>
<tr>
<td>Q</td>
<td>季节</td>
</tr>
<tr>
<td>MONTH，MON，MM，RM</td>
<td>月</td>
</tr>
<tr>
<td>WW</td>
<td>最近的日期是与一年中的第一天相同的日期</td>
</tr>
<tr>
<td>W</td>
<td>最近的日期是与该月的第一天相同的星期几</td>
</tr>
<tr>
<td>DDD，DD，J</td>
<td>天</td>
</tr>
<tr>
<td>DAY，DY，D</td>
<td>星期几（星期一）的开始</td>
</tr>
<tr>
<td>HH，HH12，HH24</td>
<td>小时</td>
</tr>
<tr>
<td>MI</td>
<td>分钟</td>
</tr>
</tbody></table>
<h3 id="3-时间比较函数"><a href="#3-时间比较函数" class="headerlink" title="3. 时间比较函数"></a>3. 时间比较函数</h3><table>
<thead>
<tr>
<th>序号</th>
<th>函数/方法</th>
<th>输出类型</th>
<th>说明/样式</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>datediff(timestamp enddate,startdate)</td>
<td>int</td>
<td>返回endDate比startDate多多少天</td>
</tr>
<tr>
<td>2</td>
<td>int_months_between(timestamp t1,t2)</td>
<td>int</td>
<td>返回两个日期相差的整数月份个数</td>
</tr>
<tr>
<td>3</td>
<td>months_between(timestamp t1,t2)</td>
<td>double</td>
<td>返回浮点数的月数相差的数</td>
</tr>
<tr>
<td>4</td>
<td>date_cmp(DATE date1, DATE date2)</td>
<td>int</td>
<td>比较是否相等，返回-1,0,1,null四种数值</td>
</tr>
<tr>
<td>5</td>
<td>timestamp_cmp(timestamp t1，timestamp t2)</td>
<td>int</td>
<td>比较是否相等，返回-1,0,1,null四种数值</td>
</tr>
</tbody></table>
<h3 id="4-时间格式转换函数"><a href="#4-时间格式转换函数" class="headerlink" title="4. 时间格式转换函数"></a>4. 时间格式转换函数</h3><table>
<thead>
<tr>
<th>序号</th>
<th>函数/方法</th>
<th>输出类型</th>
<th>说明/样式</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>to_date(timestamp date)</td>
<td>string</td>
<td>返回时间戳对应的date</td>
</tr>
<tr>
<td>2</td>
<td>to_timestamp(bigint unixtime)</td>
<td>timestamp</td>
<td>返回整数对应的timestamp值</td>
</tr>
<tr>
<td>3</td>
<td>to_timestamp(string date，string pattern)</td>
<td>timestamp</td>
<td>返回字符串对应的timestamp值</td>
</tr>
<tr>
<td>4</td>
<td>to_utc_timestamp(timestamp t，string timezone)</td>
<td>timestamp</td>
<td>指定时区的时间戳转化为UTC时区的时间戳</td>
</tr>
<tr>
<td>5</td>
<td>from_timestamp(timestamp t，string pattern)</td>
<td>string</td>
<td>把timestamp按照pattern进行格式化</td>
</tr>
<tr>
<td>6</td>
<td>from_timestamp(string date，string pattern)</td>
<td>string</td>
<td>把date按照pattern进行格式化</td>
</tr>
<tr>
<td>7</td>
<td>from_unixtime(bigint unixtime)</td>
<td>string</td>
<td>把时间戳秒数转化为本地地区中的字符串</td>
</tr>
<tr>
<td>8</td>
<td>from_unixtime(bigint unixtime，string pattern）</td>
<td>string</td>
<td>时间戳转化为本地时区字符串，pattern格式</td>
</tr>
<tr>
<td>9</td>
<td>from_utc_timestamp（timestamp t，string timezone）</td>
<td>timestamp</td>
<td>UTC时区指定时间戳转化为指定时区时间戳</td>
</tr>
<tr>
<td>10</td>
<td>unix_timestamp(string datetime)</td>
<td>bigint</td>
<td>把string类型的date或日期转化成时间戳Unix</td>
</tr>
<tr>
<td>11</td>
<td>unix_timestamp(timestamp datetime)</td>
<td>bigint</td>
<td>把string类型的timestamp转化成时间戳Unix</td>
</tr>
<tr>
<td>12</td>
<td>unix_timestamp(string datetime，string pattern)</td>
<td>bigint</td>
<td>日期按pattern转化成时间戳Unix</td>
</tr>
</tbody></table>
<h3 id="5-时间计算函数"><a href="#5-时间计算函数" class="headerlink" title="5. 时间计算函数"></a>5. 时间计算函数</h3><table>
<thead>
<tr>
<th>序号</th>
<th>函数/方法</th>
<th>输出类型</th>
<th>说明/样式</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>years_add(timestamp/date date, int/bigint years)</td>
<td>timestamp/date</td>
<td>增加指定年数</td>
</tr>
<tr>
<td>2</td>
<td>years_sub(timestamp/date date, int/bigint years)</td>
<td>timestamp/date</td>
<td>减少指定年数</td>
</tr>
<tr>
<td>3</td>
<td>months_add(timestamp/date date, int/bigint months)</td>
<td>timestamp/date</td>
<td>增加指定月数</td>
</tr>
<tr>
<td>4</td>
<td>months_sub(timestamp/date date, int/bigint months)</td>
<td>timestamp/date</td>
<td>减少指定月数</td>
</tr>
<tr>
<td>5</td>
<td>add_months(timestamp/date date, int/bigint months)</td>
<td>timestamp/date</td>
<td>增加指定月数</td>
</tr>
<tr>
<td>6</td>
<td>weeks_add(timestamp/date date, int/bigint weeks)</td>
<td>timestamp/date</td>
<td>增加指定周数</td>
</tr>
<tr>
<td>7</td>
<td>weeks_sub(timestamp/date date, int/bigint weeks)</td>
<td>timestamp/date</td>
<td>减少指定周数</td>
</tr>
<tr>
<td>8</td>
<td>days_add(timestamp/date startdate, int/bigint days)</td>
<td>timestamp/date</td>
<td>增加指定天数</td>
</tr>
<tr>
<td>9</td>
<td>days_sub(timestamp/date startdate, int/bigint days)</td>
<td>timestamp/date</td>
<td>减少指定天数</td>
</tr>
<tr>
<td>10</td>
<td>date_add(timestamp/date startdate, int/bigint days)</td>
<td>timestamp/date</td>
<td>增加指定天数</td>
</tr>
<tr>
<td>11</td>
<td>date_sub(timestamp/date startdate, int/bigint days)</td>
<td>timestamp/date</td>
<td>减少指定天数</td>
</tr>
<tr>
<td>12</td>
<td>adddate(timestamp/date startdate, int/int days)</td>
<td>timestamp/date</td>
<td>增加指定天数</td>
</tr>
<tr>
<td>13</td>
<td>subdate(timestamp/date startdate，bigint/int days)</td>
<td>timestamp/date</td>
<td>减少指定天数</td>
</tr>
<tr>
<td>14</td>
<td>hours_add(timestamp date, int/bigint hours)</td>
<td>timestamp</td>
<td>增加指定小时</td>
</tr>
<tr>
<td>15</td>
<td>hours_sub(timestamp date, int/bigint hours)</td>
<td>timestamp</td>
<td>减少指定小时</td>
</tr>
<tr>
<td>16</td>
<td>minutes_add(timestamp date, int/bigint minutes)</td>
<td>timestamp</td>
<td>增加指定分钟</td>
</tr>
<tr>
<td>17</td>
<td>minutes_sub(timestamp date, int/bigint minutes)</td>
<td>timestamp</td>
<td>减少指定分钟</td>
</tr>
<tr>
<td>18</td>
<td>seconds_add(timestamp date, int/bigint seconds)</td>
<td>timestamp</td>
<td>增加指定秒数</td>
</tr>
<tr>
<td>19</td>
<td>seconds_sub(timestamp date, int/bigint seconds)</td>
<td>timestamp</td>
<td>减少指定秒数</td>
</tr>
<tr>
<td>20</td>
<td>milliseconds_add(timestamp t, int/bigint s）</td>
<td>timestamp</td>
<td>增加指定毫秒数</td>
</tr>
<tr>
<td>21</td>
<td>milliseconds_sub(timestamp t, int/bigint s）</td>
<td>timestamp</td>
<td>减少指定毫秒数</td>
</tr>
<tr>
<td>22</td>
<td>microseconds_add(timestamp t, int/bigint s)</td>
<td>timestamp</td>
<td>增加指定微秒数</td>
</tr>
<tr>
<td>23</td>
<td>microseconds_sub(timestamp t, int/bigint s)</td>
<td>timestamp</td>
<td>减少指定微秒数</td>
</tr>
<tr>
<td>24</td>
<td>nanoseconds_add(timestamp t, int/bigint s）</td>
<td>timestamp</td>
<td>增加指定纳秒数</td>
</tr>
<tr>
<td>25</td>
<td>nanoseconds_sub(timestamp t, int/bigint s）</td>
<td>timestamp</td>
<td>减少指定纳秒数</td>
</tr>
<tr>
<td>26</td>
<td>date_add(timestamp/date startdate, interval_expression)</td>
<td>timestamp/date</td>
<td>使用参数计算日期增量值（增加）</td>
</tr>
<tr>
<td>27</td>
<td>date_sub(timestamp/date startdate, interval_expression)</td>
<td>timestamp/date</td>
<td>使用参数计算日期增量值（减少）</td>
</tr>
</tbody></table>
<hr>
<h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><h3 id="启动类-1"><a href="#启动类-1" class="headerlink" title="启动类"></a>启动类</h3><h3 id="key"><a href="#key" class="headerlink" title="key"></a>key</h3><table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>keys  *</td>
<td>查看当前库的所有键</td>
</tr>
<tr>
<td>exists <key></td>
<td>判断某个键是否存在</td>
</tr>
<tr>
<td>type <key></td>
<td>查看键的类型</td>
</tr>
<tr>
<td>del <key></td>
<td>删除某个键</td>
</tr>
<tr>
<td>expire <key> <seconds></td>
<td>为键值设置过期时间，单位秒</td>
</tr>
<tr>
<td>ttl <key></td>
<td>查看还有多久过期,-1表示永不过期,-2表示已过期</td>
</tr>
<tr>
<td>dbsize</td>
<td>查看当前数据库中key的数量</td>
</tr>
<tr>
<td>flushdb</td>
<td>清空当前库</td>
</tr>
<tr>
<td>Flushall</td>
<td>通杀全部库</td>
</tr>
</tbody></table>
<h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>get <key></td>
<td>查询对应键值</td>
</tr>
<tr>
<td>set <key> <value></td>
<td>添加键值对</td>
</tr>
<tr>
<td>append <key> <value></td>
<td>将给定的<value>追加到原值的末尾</td>
</tr>
<tr>
<td>strlen <key></td>
<td>获取值的长度</td>
</tr>
<tr>
<td>setnx <key> <value></td>
<td>只有在key 不存在时设置key的值</td>
</tr>
<tr>
<td>incr <key></td>
<td>将key中存储的数字值增1只能对数字值操作，如果为空，新增值为1</td>
</tr>
<tr>
<td>decr <key></td>
<td>将key中存储的数字值减1只能对数字之操作，如果为空,新增值为-1</td>
</tr>
<tr>
<td>incrby /decrby <key> 步长</td>
<td>将key中存储的数字值增减，自定义步长</td>
</tr>
<tr>
<td>mset <key1> <value1> <key2> <value2></td>
<td>同时设置一个或多个key-value对</td>
</tr>
<tr>
<td>mget <key1> <key2>  <key3></td>
<td>同时获取一个或多个value</td>
</tr>
<tr>
<td>msetnx <key1> <value1> <key2> <value2></td>
<td>同时设置一个或多个key-value对，当且仅当所有给定的key都不存在</td>
</tr>
<tr>
<td>getrange <key> &lt;起始位置&gt; &lt;结束位置&gt;</td>
<td>获得值的范围,类似java中的substring</td>
</tr>
<tr>
<td>setrange <key> &lt;起始位置&gt; <value></td>
<td>用<value>覆盖<key>所存储的字符串值，从&lt;起始位置&gt;开始</td>
</tr>
<tr>
<td>setex <key> &lt;过期时间&gt; <value></td>
<td>设置键值的同时，设置过去时间，单位秒</td>
</tr>
<tr>
<td>getset <key> <value></td>
<td>以新换旧,设置了新值的同时获取旧值</td>
</tr>
</tbody></table>
<h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>lpush/rpush  <key>  <value1>  <value2></td>
<td>从左边/右边插入一个或多个值。</td>
</tr>
<tr>
<td>lpop/rpop  <key></td>
<td>从左边/右边吐出一个值。值在键在，值光键亡。</td>
</tr>
<tr>
<td>rpoplpush  <key1>  <key2></td>
<td>从<key1>列表右边吐出一个值，插到<key2>列表左边</td>
</tr>
<tr>
<td>lrange <key> <start> <stop></td>
<td>按照索引下标获得元素(从左到右)</td>
</tr>
<tr>
<td>lindex <key> <index></td>
<td>按照索引下标获得元素(从左到右)</td>
</tr>
<tr>
<td>llen <key></td>
<td>获得列表长度</td>
</tr>
<tr>
<td>linsert <key>  before <value>  <newvalue></td>
<td>在<value>的后面插入<newvalue> 插入值</td>
</tr>
<tr>
<td>lrem <key> <n>  <value></td>
<td>从左边删除n个value(从左到右)</td>
</tr>
</tbody></table>
<h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h3><table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>sadd <key>  <value1>  <value2> ….</td>
<td>将一个或多个 member 元素加入到集合 key 当中，已经存在于集合的 member 元素将被忽略。</td>
</tr>
<tr>
<td>smembers <key></td>
<td>取出该集合的所有值。</td>
</tr>
<tr>
<td>sismember <key>  <value></td>
<td>判断集合<key>是否为含有该<value>值，有返回1，没有返回0</td>
</tr>
<tr>
<td>scard  <key></td>
<td>返回该集合的元素个数。</td>
</tr>
<tr>
<td>srem <key> <value1> <value2> ….</td>
<td>删除集合中的某个元素。</td>
</tr>
<tr>
<td>spop <key></td>
<td>随机从该集合中吐出一个值。</td>
</tr>
<tr>
<td>srandmember <key> <n></td>
<td>随机从该集合中取出n个值。不会从集合中删除</td>
</tr>
<tr>
<td>sinter <key1> <key2></td>
<td>返回两个集合的交集元素。</td>
</tr>
<tr>
<td>sunion <key1> <key2></td>
<td>返回两个集合的并集元素。</td>
</tr>
<tr>
<td>sdiff <key1> <key2></td>
<td>返回两个集合的差集元素。</td>
</tr>
</tbody></table>
<h3 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h3><table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>hset <key>  <field>  <value></td>
<td>给<key>集合中的  <field>键赋值<value></td>
</tr>
<tr>
<td>hget <key1>  <field></td>
<td>从<key1>集合<field> 取出 value</td>
</tr>
<tr>
<td>hmset <key1>  <field1> <value1> <field2> <value2>…</td>
<td>批量设置hash的值</td>
</tr>
<tr>
<td>hexists key  <field></td>
<td>查看哈希表 key 中，给定域 field 是否存在。</td>
</tr>
<tr>
<td>hkeys <key></td>
<td>列出该hash集合的所有field</td>
</tr>
<tr>
<td>hvals <key></td>
<td>列出该hash集合的所有value</td>
</tr>
<tr>
<td>hincrby <key> <field>  <increment></td>
<td>为哈希表 key 中的域 field 的值加上增量 increment</td>
</tr>
<tr>
<td>hsetnx <key>  <field> <value></td>
<td>将哈希表 key 中的域 field 的值设置为 value ，当且仅当域 field 不存在</td>
</tr>
</tbody></table>
<h3 id="zset-Sorted-set"><a href="#zset-Sorted-set" class="headerlink" title="zset(Sorted set)"></a>zset(Sorted set)</h3><table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>zadd  <key> <score1> <value1>  <score2> <value2>…</td>
<td>将一个或多个 member 元素及其 score 值加入到有序集 key 当中</td>
</tr>
<tr>
<td>zrange <key>  <start> <stop>  [WITHSCORES]</td>
<td>返回有序集 key 中，下标在<start> <stop>之间的元素带WITHSCORES，可以让分数一起和值返回到结果集。</td>
</tr>
<tr>
<td>zrangebyscore key min max [withscores] [limit offset count]</td>
<td>返回有序集 key 中，所有 score 值介于 min 和 max 之间(包括等于 min 或 max )的成员。有序集成员按 score 值递增(从小到大)次序排列。</td>
</tr>
<tr>
<td>zrevrangebyscore key max min [withscores] [limit offset count]</td>
<td>同上，改为从大到小排列。</td>
</tr>
<tr>
<td>zincrby <key> <increment> <value></td>
<td>为元素的score加上增量</td>
</tr>
<tr>
<td>zrem  <key>  <value></td>
<td>删除该集合下，指定值的元素</td>
</tr>
<tr>
<td>zcount <key>  <min>  <max></td>
<td>统计该集合，分数区间内的元素个数</td>
</tr>
<tr>
<td>zrank <key>  <value></td>
<td>返回该值在集合中的排名，从0开始。</td>
</tr>
</tbody></table>
<hr>
<h2 id="Flink"><a href="#Flink" class="headerlink" title="Flink"></a>Flink</h2><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./start-cluster.sh </span><br></pre></td></tr></table></figure>

<h3 id="run"><a href="#run" class="headerlink" title="run"></a>run</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./bin/flink run [OPTIONS]./bin/flink run -m yarn-cluster -c com.wang.flink.WordCount /opt/app/WordCount.jar</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>OPTIONS</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>-d</td>
<td>detached 是否使用分离模式</td>
</tr>
<tr>
<td>-m</td>
<td>jobmanager 指定提交的jobmanager</td>
</tr>
<tr>
<td>-yat</td>
<td>–yarnapplicationType 设置yarn应用的类型</td>
</tr>
<tr>
<td>-yD</td>
<td>使用给定属性的值</td>
</tr>
<tr>
<td>-yd</td>
<td>–yarndetached 使用yarn分离模式</td>
</tr>
<tr>
<td>-yh</td>
<td>–yarnhelp yarn session的帮助</td>
</tr>
<tr>
<td>-yid</td>
<td>–yarnapplicationId 挂到正在运行的yarnsession上</td>
</tr>
<tr>
<td>-yj</td>
<td>–yarnjar Flink jar文件的路径</td>
</tr>
<tr>
<td>-yjm</td>
<td>–yarnjobManagerMemory jobmanager的内存(单位M)</td>
</tr>
<tr>
<td>-ynl</td>
<td>–yarnnodeLabel 指定 YARN 应用程序 YARN 节点标签</td>
</tr>
<tr>
<td>-ynm</td>
<td>–yarnname 自定义yarn应用名称</td>
</tr>
<tr>
<td>-yq</td>
<td>–yarnquery 显示yarn的可用资源</td>
</tr>
<tr>
<td>-yqu</td>
<td>–yarnqueue 指定yarn队列</td>
</tr>
<tr>
<td>-ys</td>
<td>–yarnslots 指定每个taskmanager的slots数</td>
</tr>
<tr>
<td>-yt</td>
<td>yarnship 在指定目录中传输文件</td>
</tr>
<tr>
<td>-ytm</td>
<td>–yarntaskManagerMemory 每个taskmanager的内存</td>
</tr>
<tr>
<td>-yz</td>
<td>–yarnzookeeperNamespace 用来创建ha的zk子路径的命名空间</td>
</tr>
<tr>
<td>-z</td>
<td>–zookeeperNamespace 用来创建ha的zk子路径的命名空间</td>
</tr>
<tr>
<td>-p</td>
<td>并行度</td>
</tr>
<tr>
<td>-yn</td>
<td>需要分配的YARN容器个数(=任务管理器的数量)</td>
</tr>
</tbody></table>
<h3 id="info"><a href="#info" class="headerlink" title="info"></a>info</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./bin/flink info [OPTIONS]</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>OPTIONS</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>-c</td>
<td>程序进入点，主类</td>
</tr>
<tr>
<td>-p</td>
<td>并行度</td>
</tr>
</tbody></table>
<h3 id="list"><a href="#list" class="headerlink" title="list"></a>list</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./bin/flink list [OPTIONS]</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>OPTIONS</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>-a</td>
<td>–all 显示所有应用和对应的job id</td>
</tr>
<tr>
<td>-r</td>
<td>–running 显示正在运行的应用和job id</td>
</tr>
<tr>
<td>-s</td>
<td>–scheduled 显示调度的应用和job id</td>
</tr>
<tr>
<td>-m</td>
<td>–jobmanager 指定连接的jobmanager</td>
</tr>
<tr>
<td>-yid</td>
<td>–yarnapplicationId 挂到指定的yarn id对应的yarn session上</td>
</tr>
<tr>
<td>-z</td>
<td>–zookeeperNamespace 用来创建ha的zk子路径的命名空间</td>
</tr>
</tbody></table>
<h3 id="stop"><a href="#stop" class="headerlink" title="stop"></a>stop</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./bin/flink stop  [OPTIONS] &lt;Job ID&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>OPTIONS</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>-d</td>
<td>在采取保存点和停止管道之前，发送MAX_WATERMARK</td>
</tr>
<tr>
<td>-p</td>
<td>savepointPath 保存点的路径 ‘xxxxx’</td>
</tr>
<tr>
<td>-m</td>
<td>–jobmanager 指定连接的jobmanager</td>
</tr>
<tr>
<td>-yid</td>
<td>–yarnapplicationId 挂到指定的yarn id对应的yarn session上</td>
</tr>
<tr>
<td>-z</td>
<td>–zookeeperNamespace 用来创建ha的zk子路径的命名空间</td>
</tr>
</tbody></table>
<h3 id="cancel-弱化"><a href="#cancel-弱化" class="headerlink" title="cancel(弱化)"></a>cancel(弱化)</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./bin/flink cancel  [OPTIONS] &lt;Job ID&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>OPTIONS</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>-s</td>
<td>使用 “stop “代替</td>
</tr>
<tr>
<td>-D</td>
<td>允许指定多个通用配置选项</td>
</tr>
<tr>
<td>-m</td>
<td>要连接的JobManager的地址</td>
</tr>
<tr>
<td>-yid</td>
<td>–yarnapplicationId 挂到指定的yarn id对应的yarn session上</td>
</tr>
<tr>
<td>-z</td>
<td>–zookeeperNamespace 用来创建ha的zk子路径的命名空间</td>
</tr>
</tbody></table>
<h3 id="savepoint"><a href="#savepoint" class="headerlink" title="savepoint"></a>savepoint</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./bin/flink savepoint  [OPTIONS] &lt;Job ID&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>OPTIONS</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>-d</td>
<td>要处理的保存点的路径</td>
</tr>
<tr>
<td>-j</td>
<td>Flink程序的JAR文件</td>
</tr>
<tr>
<td>-m</td>
<td>要连接的JobManager的地址</td>
</tr>
<tr>
<td>-yid</td>
<td>–yarnapplicationId 挂到指定的yarn id对应的yarn session上</td>
</tr>
<tr>
<td>-z</td>
<td>–zookeeperNamespace 用来创建ha的zk子路径的命名空间</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>BigData</category>
        <category>大数据常用命令</category>
      </categories>
      <tags>
        <tag>BigData</tag>
      </tags>
  </entry>
  <entry>
    <title>试用期</title>
    <url>/2022/01/01/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h1 id="试用期流程"><a href="#试用期流程" class="headerlink" title="试用期流程"></a>试用期流程</h1><h2 id="一、业务调研"><a href="#一、业务调研" class="headerlink" title="一、业务调研"></a>一、业务调研</h2><p>​    首先了解公司的业务系统有哪些(<code>只要是公司用的，能给公司带来利益的系统都需要知道</code>)</p>
<h2 id="二、数据调研"><a href="#二、数据调研" class="headerlink" title="二、数据调研"></a>二、数据调研</h2><p>​    了解公司的数据来源有哪些，绘制一个数据来源渠道(<code>数据来源就是数据的源头，例如从其他公司过来的数据有哪些，或者自己系统埋点的数据有哪些，这些都需要了解</code>)。</p>
<h2 id="三、数据ETL"><a href="#三、数据ETL" class="headerlink" title="三、数据ETL"></a>三、数据ETL</h2><p>​    所谓的ETL就是数据抽取，转换，装载。换句话说就是数据从源头过来了之后是怎么进行处理的，之后获取我们需要的数据，然后通过某种组件消费数据，最后进行装载之后就是我们能在系统前端看到的样子了<code>例如公司的销售额今天多少，或者公司近段时间销售额变化趋势图</code></p>
<h2 id="四、需求调研"><a href="#四、需求调研" class="headerlink" title="四、需求调研"></a>四、需求调研</h2><p>​    指标分析、指标拆解，针对各个影响因素进行比较也就是，清除我们前端展示的数据能代表什么。</p>
]]></content>
      <categories>
        <category>工作</category>
        <category>试用期步骤</category>
      </categories>
      <tags>
        <tag>试用期</tag>
      </tags>
  </entry>
  <entry>
    <title>使用kubeadm快速部署一个K8s集群</title>
    <url>/2022/01/09/%E4%BD%BF%E7%94%A8kubeadm%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2%E4%B8%80%E4%B8%AAK8s%E9%9B%86%E7%BE%A4/</url>
    <content><![CDATA[<p>kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具。</p>
<p>这个工具能通过两条指令完成一个kubernetes集群的部署：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 创建一个 Master 节点</span><br><span class="line">$ kubeadm init</span><br><span class="line"></span><br><span class="line"># 将一个 Node 节点加入到当前集群中</span><br><span class="line">$ kubeadm join &lt;Master节点的IP和端口 &gt;</span><br></pre></td></tr></table></figure>

<h2 id="1-安装要求"><a href="#1-安装要求" class="headerlink" title="1. 安装要求"></a>1. 安装要求</h2><p>在开始之前，部署Kubernetes集群机器需要满足以下几个条件：</p>
<ul>
<li>一台或多台机器，操作系统 CentOS7.x-86_x64</li>
<li>硬件配置：2GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多</li>
<li>可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像并导入节点</li>
<li>禁止swap分区</li>
</ul>
<h2 id="2-准备环境"><a href="#2-准备环境" class="headerlink" title="2. 准备环境"></a>2. 准备环境</h2><table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>master</td>
<td>192.168.1.11</td>
</tr>
<tr>
<td>node1</td>
<td>192.168.1.12</td>
</tr>
<tr>
<td>node2</td>
<td>192.168.1.13</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 关闭防火墙</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"></span><br><span class="line"># 关闭selinux</span><br><span class="line">sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config  # 永久</span><br><span class="line">setenforce 0  # 临时</span><br><span class="line"></span><br><span class="line"># 关闭swap</span><br><span class="line">swapoff -a  # 临时</span><br><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab    # 永久</span><br><span class="line"></span><br><span class="line"># 根据规划设置主机名</span><br><span class="line">hostnamectl set-hostname &lt;hostname&gt;</span><br><span class="line"></span><br><span class="line"># 在master添加hosts</span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.44.146 k8smaster</span><br><span class="line">192.168.44.145 k8snode1</span><br><span class="line">192.168.44.144 k8snode2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 将桥接的IPv4流量传递到iptables的链</span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">sysctl --system  # 生效</span><br><span class="line"></span><br><span class="line"># 时间同步</span><br><span class="line">yum install ntpdate -y</span><br><span class="line">ntpdate time.windows.com</span><br></pre></td></tr></table></figure>

<h2 id="3-所有节点安装Docker-kubeadm-kubelet"><a href="#3-所有节点安装Docker-kubeadm-kubelet" class="headerlink" title="3. 所有节点安装Docker/kubeadm/kubelet"></a>3. 所有节点安装Docker/kubeadm/kubelet</h2><p>Kubernetes默认CRI（容器运行时）为Docker，因此先安装Docker。</p>
<h3 id="3-1-安装Docker"><a href="#3-1-安装Docker" class="headerlink" title="3.1 安装Docker"></a>3.1 安装Docker</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">$ yum -y install docker-ce-18.06.1.ce-3.el7</span><br><span class="line">$ systemctl enable docker &amp;&amp; systemctl start docker</span><br><span class="line">$ docker --version</span><br><span class="line">Docker version 18.06.1-ce, build e68fc7a</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="3-2-添加阿里云YUM软件源"><a href="#3-2-添加阿里云YUM软件源" class="headerlink" title="3.2 添加阿里云YUM软件源"></a>3.2 添加阿里云YUM软件源</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="3-3-安装kubeadm，kubelet和kubectl"><a href="#3-3-安装kubeadm，kubelet和kubectl" class="headerlink" title="3.3 安装kubeadm，kubelet和kubectl"></a>3.3 安装kubeadm，kubelet和kubectl</h3><p>由于版本更新频繁，这里指定版本号部署：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0</span><br><span class="line">$ systemctl enable kubelet</span><br></pre></td></tr></table></figure>

<h2 id="4-部署Kubernetes-Master"><a href="#4-部署Kubernetes-Master" class="headerlink" title="4. 部署Kubernetes Master"></a>4. 部署Kubernetes Master</h2><p>在192.168.31.61（Master）执行。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ kubeadm init \</span><br><span class="line">  --apiserver-advertise-address=192.168.44.146 \</span><br><span class="line">  --image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">  --kubernetes-version v1.18.0 \</span><br><span class="line">  --service-cidr=10.96.0.0/12 \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>

<p>由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址。</p>
<p>使用kubectl工具：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ kubectl get nodes</span><br></pre></td></tr></table></figure>

<h2 id="5-加入Kubernetes-Node"><a href="#5-加入Kubernetes-Node" class="headerlink" title="5. 加入Kubernetes Node"></a>5. 加入Kubernetes Node</h2><p>在192.168.1.12/13（Node）执行。</p>
<p>向集群添加新节点，执行在kubeadm init输出的kubeadm join命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ kubeadm join 192.168.1.11:6443 --token esce21.q6hetwm8si29qxwn \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:00603a05805807501d7181c3d60b478788408cfe6cedefedb1f97569708be9c5</span><br></pre></td></tr></table></figure>

<p>默认token有效期为24小时，当过期之后，该token就不可用了。这时就需要重新创建token，操作如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>

<h2 id="6-部署CNI网络插件"><a href="#6-部署CNI网络插件" class="headerlink" title="6. 部署CNI网络插件"></a>6. 部署CNI网络插件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>

<p>默认镜像地址无法访问，sed命令修改为docker hub镜像仓库。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-flannel-ds-amd64-2pc95   1/1     Running   0          72s</span><br></pre></td></tr></table></figure>

<h2 id="7-测试kubernetes集群"><a href="#7-测试kubernetes集群" class="headerlink" title="7. 测试kubernetes集群"></a>7. 测试kubernetes集群</h2><p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ kubectl create deployment nginx --image=nginx</span><br><span class="line">$ kubectl expose deployment nginx --port=80 --type=NodePort</span><br><span class="line">$ kubectl get pod,svc</span><br></pre></td></tr></table></figure>

<p>访问地址：<a href="http://NodeIP:Port">http://NodeIP:Port</a>  </p>
]]></content>
      <categories>
        <category>BigData</category>
        <category>k8s</category>
        <category>使用kubeadm快速部署一个K8s集群</category>
      </categories>
      <tags>
        <tag>BigData</tag>
        <tag>k8s</tag>
      </tags>
  </entry>
  <entry>
    <title>使用kubeadm搭建高可用的K8s集群</title>
    <url>/2022/01/09/%E4%BD%BF%E7%94%A8kubeadm%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84K8s%E9%9B%86%E7%BE%A4/</url>
    <content><![CDATA[<p>kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具。</p>
<p>这个工具能通过两条指令完成一个kubernetes集群的部署：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 创建一个 Master 节点</span><br><span class="line">$ kubeadm init</span><br><span class="line"></span><br><span class="line"># 将一个 Node 节点加入到当前集群中</span><br><span class="line">$ kubeadm join &lt;Master节点的IP和端口 &gt;</span><br></pre></td></tr></table></figure>

<h2 id="1-安装要求"><a href="#1-安装要求" class="headerlink" title="1. 安装要求"></a>1. 安装要求</h2><p>在开始之前，部署Kubernetes集群机器需要满足以下几个条件：</p>
<ul>
<li>一台或多台机器，操作系统 CentOS7.x-86_x64</li>
<li>硬件配置：2GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多</li>
<li>可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像并导入节点</li>
<li>禁止swap分区</li>
</ul>
<h2 id="2-准备环境"><a href="#2-准备环境" class="headerlink" title="2. 准备环境"></a>2. 准备环境</h2><table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>master1</td>
<td>192.168.44.155</td>
</tr>
<tr>
<td>master2</td>
<td>192.168.44.156</td>
</tr>
<tr>
<td>node1</td>
<td>192.168.44.157</td>
</tr>
<tr>
<td>VIP（虚拟ip）</td>
<td>192.168.44.158</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 关闭防火墙</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"></span><br><span class="line"># 关闭selinux</span><br><span class="line">sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config  # 永久</span><br><span class="line">setenforce 0  # 临时</span><br><span class="line"></span><br><span class="line"># 关闭swap</span><br><span class="line">swapoff -a  # 临时</span><br><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab    # 永久</span><br><span class="line"></span><br><span class="line"># 根据规划设置主机名</span><br><span class="line">hostnamectl set-hostname &lt;hostname&gt;</span><br><span class="line"></span><br><span class="line"># 在master添加hosts</span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.44.158    master.k8s.io   k8s-vip</span><br><span class="line">192.168.44.155    master01.k8s.io master1</span><br><span class="line">192.168.44.156    master02.k8s.io master2</span><br><span class="line">192.168.44.157    node01.k8s.io   node1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 将桥接的IPv4流量传递到iptables的链</span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">sysctl --system  # 生效</span><br><span class="line"></span><br><span class="line"># 时间同步</span><br><span class="line">yum install ntpdate -y</span><br><span class="line">ntpdate time.windows.com</span><br></pre></td></tr></table></figure>



<h2 id="3-所有master节点部署keepalived"><a href="#3-所有master节点部署keepalived" class="headerlink" title="3. 所有master节点部署keepalived"></a>3. 所有master节点部署keepalived</h2><h3 id="3-1-安装相关包和keepalived"><a href="#3-1-安装相关包和keepalived" class="headerlink" title="3.1 安装相关包和keepalived"></a>3.1 安装相关包和keepalived</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install -y conntrack-tools libseccomp libtool-ltdl</span><br><span class="line"></span><br><span class="line">yum install -y keepalived</span><br></pre></td></tr></table></figure>

<h3 id="3-2配置master节点"><a href="#3-2配置master节点" class="headerlink" title="3.2配置master节点"></a>3.2配置master节点</h3><p>master1节点配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt;EOF </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id k8s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script &quot;killall -0 haproxy&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER </span><br><span class="line">    interface ens33 </span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 250</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass ceb1b3ec013d66163d6ab</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.44.158</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>master2节点配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt;EOF </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id k8s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script &quot;killall -0 haproxy&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP </span><br><span class="line">    interface ens33 </span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 200</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass ceb1b3ec013d66163d6ab</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.44.158</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="3-3-启动和检查"><a href="#3-3-启动和检查" class="headerlink" title="3.3 启动和检查"></a>3.3 启动和检查</h3><p>在两台master节点都执行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 启动keepalived</span><br><span class="line">$ systemctl start keepalived.service</span><br><span class="line">设置开机启动</span><br><span class="line">$ systemctl enable keepalived.service</span><br><span class="line"># 查看启动状态</span><br><span class="line">$ systemctl status keepalived.service</span><br></pre></td></tr></table></figure>

<p>启动后查看master1的网卡信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ip a s ens33</span><br></pre></td></tr></table></figure>



<h2 id="4-部署haproxy"><a href="#4-部署haproxy" class="headerlink" title="4. 部署haproxy"></a>4. 部署haproxy</h2><h3 id="4-1-安装"><a href="#4-1-安装" class="headerlink" title="4.1 安装"></a>4.1 安装</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install -y haproxy</span><br></pre></td></tr></table></figure>

<h3 id="4-2-配置"><a href="#4-2-配置" class="headerlink" title="4.2 配置"></a>4.2 配置</h3><p>两台master节点的配置均相同，配置中声明了后端代理的两个master节点服务器，指定了haproxy运行的端口为16443等，因此16443端口为集群的入口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat &gt; /etc/haproxy/haproxy.cfg &lt;&lt; EOF</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># Global settings</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">global</span><br><span class="line">    # to have these messages end up in /var/log/haproxy.log you will</span><br><span class="line">    # need to:</span><br><span class="line">    # 1) configure syslog to accept network log events.  This is done</span><br><span class="line">    #    by adding the &#x27;-r&#x27; option to the SYSLOGD_OPTIONS in</span><br><span class="line">    #    /etc/sysconfig/syslog</span><br><span class="line">    # 2) configure local2 events to go to the /var/log/haproxy.log</span><br><span class="line">    #   file. A line like the following can be added to</span><br><span class="line">    #   /etc/sysconfig/syslog</span><br><span class="line">    #</span><br><span class="line">    #    local2.*                       /var/log/haproxy.log</span><br><span class="line">    #</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line">    </span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon </span><br><span class="line">       </span><br><span class="line">    # turn on stats unix socket</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># common defaults that all the &#x27;listen&#x27; and &#x27;backend&#x27; sections will</span><br><span class="line"># use if not designated in their block</span><br><span class="line">#---------------------------------------------------------------------  </span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># kubernetes apiserver frontend which proxys to the backends</span><br><span class="line">#--------------------------------------------------------------------- </span><br><span class="line">frontend kubernetes-apiserver</span><br><span class="line">    mode                 tcp</span><br><span class="line">    bind                 *:16443</span><br><span class="line">    option               tcplog</span><br><span class="line">    default_backend      kubernetes-apiserver    </span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># round robin balancing between the various backends</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">backend kubernetes-apiserver</span><br><span class="line">    mode        tcp</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      master01.k8s.io   192.168.44.155:6443 check</span><br><span class="line">    server      master02.k8s.io   192.168.44.156:6443 check</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># collection haproxy statistics message</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">listen stats</span><br><span class="line">    bind                 *:1080</span><br><span class="line">    stats auth           admin:awesomePassword</span><br><span class="line">    stats refresh        5s</span><br><span class="line">    stats realm          HAProxy\ Statistics</span><br><span class="line">    stats uri            /admin?stats</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="4-3-启动和检查"><a href="#4-3-启动和检查" class="headerlink" title="4.3 启动和检查"></a>4.3 启动和检查</h3><p>两台master都启动</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 设置开机启动</span><br><span class="line">$ systemctl enable haproxy</span><br><span class="line"># 开启haproxy</span><br><span class="line">$ systemctl start haproxy</span><br><span class="line"># 查看启动状态</span><br><span class="line">$ systemctl status haproxy</span><br></pre></td></tr></table></figure>

<p>检查端口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">netstat -lntup|grep haproxy</span><br></pre></td></tr></table></figure>



<h2 id="5-所有节点安装Docker-kubeadm-kubelet"><a href="#5-所有节点安装Docker-kubeadm-kubelet" class="headerlink" title="5. 所有节点安装Docker/kubeadm/kubelet"></a>5. 所有节点安装Docker/kubeadm/kubelet</h2><p>Kubernetes默认CRI（容器运行时）为Docker，因此先安装Docker。</p>
<h3 id="5-1-安装Docker"><a href="#5-1-安装Docker" class="headerlink" title="5.1 安装Docker"></a>5.1 安装Docker</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">$ yum -y install docker-ce-18.06.1.ce-3.el7</span><br><span class="line">$ systemctl enable docker &amp;&amp; systemctl start docker</span><br><span class="line">$ docker --version</span><br><span class="line">Docker version 18.06.1-ce, build e68fc7a</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="5-2-添加阿里云YUM软件源"><a href="#5-2-添加阿里云YUM软件源" class="headerlink" title="5.2 添加阿里云YUM软件源"></a>5.2 添加阿里云YUM软件源</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="5-3-安装kubeadm，kubelet和kubectl"><a href="#5-3-安装kubeadm，kubelet和kubectl" class="headerlink" title="5.3 安装kubeadm，kubelet和kubectl"></a>5.3 安装kubeadm，kubelet和kubectl</h3><p>由于版本更新频繁，这里指定版本号部署：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ yum install -y kubelet-1.16.3 kubeadm-1.16.3 kubectl-1.16.3</span><br><span class="line">$ systemctl enable kubelet</span><br></pre></td></tr></table></figure>



<h2 id="6-部署Kubernetes-Master"><a href="#6-部署Kubernetes-Master" class="headerlink" title="6. 部署Kubernetes Master"></a>6. 部署Kubernetes Master</h2><h3 id="6-1-创建kubeadm配置文件"><a href="#6-1-创建kubeadm配置文件" class="headerlink" title="6.1 创建kubeadm配置文件"></a>6.1 创建kubeadm配置文件</h3><p>在具有vip的master上操作，这里为master1</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ mkdir /usr/local/kubernetes/manifests -p</span><br><span class="line"></span><br><span class="line">$ cd /usr/local/kubernetes/manifests/</span><br><span class="line"></span><br><span class="line">$ vi kubeadm-config.yaml</span><br><span class="line"></span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">    - master1</span><br><span class="line">    - master2</span><br><span class="line">    - master.k8s.io</span><br><span class="line">    - 192.168.44.158</span><br><span class="line">    - 192.168.44.155</span><br><span class="line">    - 192.168.44.156</span><br><span class="line">    - 127.0.0.1</span><br><span class="line">  extraArgs:</span><br><span class="line">    authorization-mode: Node,RBAC</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta1</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controlPlaneEndpoint: &quot;master.k8s.io:16443&quot;</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns: </span><br><span class="line">  type: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  local:    </span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: registry.aliyuncs.com/google_containers</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.16.3</span><br><span class="line">networking: </span><br><span class="line">  dnsDomain: cluster.local  </span><br><span class="line">  podSubnet: 10.244.0.0/16</span><br><span class="line">  serviceSubnet: 10.1.0.0/16</span><br><span class="line">scheduler: &#123;&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-2-在master1节点执行"><a href="#6-2-在master1节点执行" class="headerlink" title="6.2 在master1节点执行"></a>6.2 在master1节点执行</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ kubeadm init --config kubeadm-config.yaml</span><br></pre></td></tr></table></figure>



<p>按照提示配置环境变量，使用kubectl工具：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ kubectl get nodes</span><br><span class="line">$ kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>



<p><strong>按照提示保存以下内容，一会要使用：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubeadm join master.k8s.io:16443 --token jv5z7n.3y1zi95p952y9p65 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:403bca185c2f3a4791685013499e7ce58f9848e2213e27194b75a2e3293d8812 \</span><br><span class="line">    --control-plane </span><br></pre></td></tr></table></figure>

<p>查看集群状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get cs</span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>



<h2 id="7-安装集群网络"><a href="#7-安装集群网络" class="headerlink" title="7.安装集群网络"></a>7.安装集群网络</h2><p>从官方地址获取到flannel的yaml，在master1上执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir flannel</span><br><span class="line"><span class="built_in">cd</span> flannel</span><br><span class="line">wget -c https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>



<p>安装flannel网络</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml </span><br></pre></td></tr></table></figure>

<p>检查</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>



<h2 id="8、master2节点加入集群"><a href="#8、master2节点加入集群" class="headerlink" title="8、master2节点加入集群"></a>8、master2节点加入集群</h2><h3 id="8-1-复制密钥及相关文件"><a href="#8-1-复制密钥及相关文件" class="headerlink" title="8.1 复制密钥及相关文件"></a>8.1 复制密钥及相关文件</h3><p>从master1复制密钥及相关文件到master2</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ssh root@192.168.44.156 mkdir -p /etc/kubernetes/pki/etcd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># scp /etc/kubernetes/admin.conf root@192.168.44.156:/etc/kubernetes</span></span><br><span class="line">   </span><br><span class="line"><span class="comment"># scp /etc/kubernetes/pki/&#123;ca.*,sa.*,front-proxy-ca.*&#125; root@192.168.44.156:/etc/kubernetes/pki</span></span><br><span class="line">   </span><br><span class="line"><span class="comment"># scp /etc/kubernetes/pki/etcd/ca.* root@192.168.44.156:/etc/kubernetes/pki/etcd</span></span><br></pre></td></tr></table></figure>

<h3 id="8-2-master2加入集群"><a href="#8-2-master2加入集群" class="headerlink" title="8.2 master2加入集群"></a>8.2 master2加入集群</h3><p>执行在master1上init后输出的join命令,需要带上参数<code>--control-plane</code>表示把master控制节点加入集群</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubeadm join master.k8s.io:16443 --token ckf7bs.30576l0okocepg8b     --discovery-token-ca-cert-hash sha256:19afac8b11182f61073e254fb57b9f19ab4d798b70501036fc69ebef46094aba --control-plane</span><br></pre></td></tr></table></figure>

<p>检查状态</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line"></span><br><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="5-加入Kubernetes-Node"><a href="#5-加入Kubernetes-Node" class="headerlink" title="5. 加入Kubernetes Node"></a>5. 加入Kubernetes Node</h2><p>在node1上执行</p>
<p>向集群添加新节点，执行在kubeadm init输出的kubeadm join命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubeadm join master.k8s.io:16443 --token ckf7bs.30576l0okocepg8b     --discovery-token-ca-cert-hash sha256:19afac8b11182f61073e254fb57b9f19ab4d798b70501036fc69ebef46094aba</span><br></pre></td></tr></table></figure>

<p><strong>集群网络重新安装，因为添加了新的node节点</strong></p>
<p>检查状态</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line"></span><br><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure>

<h2 id="-1"><a href="#-1" class="headerlink" title=""></a></h2><h2 id="7-测试kubernetes集群"><a href="#7-测试kubernetes集群" class="headerlink" title="7. 测试kubernetes集群"></a>7. 测试kubernetes集群</h2><p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ kubectl create deployment nginx --image=nginx</span><br><span class="line">$ kubectl expose deployment nginx --port=80 --type=NodePort</span><br><span class="line">$ kubectl get pod,svc</span><br></pre></td></tr></table></figure>

<p>访问地址：<a href="http://NodeIP:Port">http://NodeIP:Port</a>  </p>
]]></content>
      <categories>
        <category>BigData</category>
        <category>k8s</category>
        <category>使用kubeadm搭建高可用的K8s集群</category>
      </categories>
      <tags>
        <tag>BigData</tag>
        <tag>k8s</tag>
      </tags>
  </entry>
  <entry>
    <title>数仓原理</title>
    <url>/2022/01/12/%E5%8E%9F%E7%90%86%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h2 id="第一章：数仓概念"><a href="#第一章：数仓概念" class="headerlink" title="第一章：数仓概念"></a>第一章：数仓概念</h2><p>数据仓库不同于数据库，是大数据岗位对数据进行采集，分析，计算的核心部位。</p>
<p>数据源主要分为两部分：用户行为日志和业务数据。</p>
<p>数据的存储不是数据仓库的目的，主要的目的是通过对数据的分析计算对结果做出报表统计和推荐系统。</p>
<p><img src="https://s2.loli.net/2022/01/12/z4SEicWesI6bVO7.png" alt="6"></p>
<h2 id="第二章：结构设计"><a href="#第二章：结构设计" class="headerlink" title="第二章：结构设计"></a>第二章：结构设计</h2><h3 id="1-需求分析-amp-选型框架"><a href="#1-需求分析-amp-选型框架" class="headerlink" title="1.需求分析&amp;选型框架"></a>1.需求分析&amp;选型框架</h3><p>采集需求：</p>
<p>​    1.采集用户行为日志 -》落盘文件 -》 flume、kafka</p>
<p>​    2.采集业务数据 -》结构型数据库数据 -》MySQL、sqoop</p>
<p>处理分析需求（核心需求）</p>
<p>​    3.数据仓库维度建模 -》将结构型数据库的格式转换为更适合大数据的维度格式 -》HDFS、Hive</p>
<p>​    4.分析计算 -》完成固定的核心指标 -》 Spark -》Echarts、Superset</p>
<p>拓展功能</p>
<p>​    5.即席查询 -》完成临时添加的功能 -》Persto、Kylin</p>
<p>​    6.性能监控 -》进程时候正常运行 -》 Zabbix</p>
<p>​    7.元数据管理 -》 监控字段的血缘依赖 -》Atlas</p>
<p>​    8.质量监控 -》 管理得出需求的结果是否高质量 -》 特殊需求</p>
<p>对以上内容写的脚本进行任务调度-》Azkaban</p>
<h3 id="2-架构流程设计"><a href="#2-架构流程设计" class="headerlink" title="2.架构流程设计"></a>2.架构流程设计</h3><p><img src="https://s2.loli.net/2022/01/12/Y6uosEm4M3aHJhd.png" alt="5"></p>
<h3 id="3-框架版本选择"><a href="#3-框架版本选择" class="headerlink" title="3.框架版本选择"></a>3.框架版本选择</h3><p>框架类型</p>
<p>​    Apache：开源，需要维护，容易出兼容性问题</p>
<p>​    CDH：收费，使用简便 -》如果有5.x版本的安装包还能够免费使用，但是不再提供升级和技术支持，不推荐使用</p>
<p>​    HDP：被收购了，和CDH一样</p>
<p>框架版本号</p>
<p>​    hadoop =》3.1.3</p>
<p>​    flume =》1.9.0</p>
<p>​    kafka =》2.4.1</p>
<p>​    hive =》3.1.2</p>
<p>​    sqoop =》1.4.6</p>
<p>​    java =》1.8</p>
<p>​    zookeeper =》3.5.7</p>
<p>​    presto =》0.189</p>
<h3 id="4-服务器选型和规划"><a href="#4-服务器选型和规划" class="headerlink" title="4.服务器选型和规划"></a>4.服务器选型和规划</h3><p>物理机 -》 长期使用价格较低，维护麻烦 =》 有长久打算的使用物理机</p>
<p>云服务器 -》使用灵活不用一次性支付大量资金</p>
<h3 id="5-集群规模和资源规划"><a href="#5-集群规模和资源规划" class="headerlink" title="5.集群规模和资源规划"></a>5.集群规模和资源规划</h3><p>集群规模 -》 百万日活大概对应80T磁盘空间保存离线数据 =》具体数据具体计算</p>
<p>资源规划 -》占用相同资源的框架放到不同的节点，有相互依赖的框架尽量放到同一台节点</p>
<h2 id="第三章：用户行为日志数据"><a href="#第三章：用户行为日志数据" class="headerlink" title="第三章：用户行为日志数据"></a>第三章：用户行为日志数据</h2><h3 id="1-数据样式"><a href="#1-数据样式" class="headerlink" title="1.数据样式"></a>1.数据样式</h3><p>页面数据</p>
<p>​    一行数据： 展示的一次页面</p>
<p>​    内容：展示的哪一种页面，页面显示的内容，点击进入的来源</p>
<p>​    关联：业务类的表</p>
<p>事件数据</p>
<p>​    一行数据： 用户的一次动作</p>
<p>​    内容： 动作的主体和内容</p>
<p>​    关联： 业务类的表</p>
<p>曝光数据</p>
<p>​    一行数据：曝光的一件商品或一个活动</p>
<p>​    内容：页面显示的一个对象，曝光的来源</p>
<p>​    关联：业务类的表</p>
<p>启动数据</p>
<p>​    一行数据： 启动一次APP</p>
<p>​    内容： 启动的时间，展示的广告</p>
<p>​    关联： 无</p>
<p>错误</p>
<p>​    一行数据：系统一次错误</p>
<p>​    内容： 错误的类型</p>
<p>​    关联： 无</p>
<h3 id="2-埋点"><a href="#2-埋点" class="headerlink" title="2.埋点"></a>2.埋点</h3><p>代码埋点</p>
<p>​    写在代码内部，在触发了条件时，额外发送一条日志</p>
<p>可视化埋点</p>
<p>​    web UI点击选取哪些可以进行埋点</p>
<p>全埋点</p>
<p>​    将用户行为全部记录，使用的时候再进行选择</p>
<p>埋点内容为 JSON 格式，大部分时候需要进行清洗，通过标志位对字符串进行切割。</p>
<p>日志上报时机</p>
<p>​    批发送 -》 对服务器压力小，实时性差 =》 数仓使用</p>
<p>​    条发送 -》 对服务器压力大，实时性强</p>
<h2 id="补充-环境变量说明"><a href="#补充-环境变量说明" class="headerlink" title="补充: 环境变量说明"></a>补充: 环境变量说明</h2><p>shell分两种</p>
<p>​    login shell ：不管是远程登录还是本地登录，需要使用账号密码登录的都是</p>
<p>​    no-login shell：使用ssh远程命令，此时是非登录的shell</p>
<p>两者加载的环境变量不同</p>
<p>自己使用的时候，共同的环境变量配置在<code>/etc/profile.d/*.sh</code>文件中，只需要给login shell使用的环境变量配置在<code>/etc/profile.d/sh.local</code></p>
<h2 id="补充-spring-boot脚本的使用"><a href="#补充-spring-boot脚本的使用" class="headerlink" title="补充: spring boot脚本的使用"></a>补充: spring boot脚本的使用</h2><p>配置文件分为两种：yml和properties</p>
<p>​    yml使用冒号加空格来隔断，可以使用缩进进行缩写</p>
<p>​    properties使用等号，不能缩写</p>
<h2 id="第四章：hadoop框架"><a href="#第四章：hadoop框架" class="headerlink" title="第四章：hadoop框架"></a>第四章：hadoop框架</h2><h3 id="1、配置存储多目录"><a href="#1、配置存储多目录" class="headerlink" title="1、配置存储多目录"></a>1、配置存储多目录</h3><p>可配置存储多目录，使用多个磁盘保存datanode文件，属于纵向扩展，修改文件hdfs-site.xml中的<code>dfs.datanode.data.dir</code>参数</p>
<p>参考值：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.datanode.data.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>file:///dfs/data1,file:///hd2/dfs/data2,file:///hd3/dfs/data3,file:///hd4/dfs/data4<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="2、集群数据均衡"><a href="#2、集群数据均衡" class="headerlink" title="2、集群数据均衡"></a>2、集群数据均衡</h3><p>集群可以进行节点间均衡和磁盘均衡</p>
<p>节点间均衡</p>
<p>​    默认开启 10% 进行均衡，将不同电脑上的数据传输进行平衡，可关闭</p>
<p>磁盘均衡</p>
<p>​    对同一台节点不同磁盘间的数据进行均衡，需要配置多目录才有用</p>
<h3 id="3、LZO压缩"><a href="#3、LZO压缩" class="headerlink" title="3、LZO压缩"></a>3、LZO压缩</h3><p>hadoop默认不支持LZO压缩，需要自己配置</p>
<p>我们常说的LZO压缩能够进行切片其实是LZOP，实际项目开发中使用snappy更多，文件大小可以控制，就不需要再进行切片了。</p>
<h3 id="4、读写性能测试"><a href="#4、读写性能测试" class="headerlink" title="4、读写性能测试"></a>4、读写性能测试</h3><p>hadoop提供有专门的脚本对性能进行测试，主要限制原因为带宽</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 mapreduce]$ hadoop jar /opt/module/hadoop-3.1.3/share/hadoop/mapreduce/hadoop-mapreduce-client-jobclient-3.1.3-tests.jar TestDFSIO -write -nrFiles 10 -fileSize 128MB</span><br><span class="line"></span><br><span class="line">[logan@hadoop102 mapreduce]$ hadoop jar /opt/module/hadoop-3.1.3/share/hadoop/mapreduce/hadoop-mapreduce-client-jobclient-3.1.3-tests.jar TestDFSIO -read -nrFiles 10 -fileSize 128MB</span><br></pre></td></tr></table></figure>

<h3 id="5、常见调优参数"><a href="#5、常见调优参数" class="headerlink" title="5、常见调优参数"></a>5、常见调优参数</h3><p><strong>NameNode有一个工作线程池</strong>：hdfs-site.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.handler.count<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>10<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>公式：dfs.namenode.handler.count=int(20*math.log(8))</p>
<p><strong>yarn内存</strong></p>
<p>yarn-site.xml 中调节yarn单个任务可以使用的内存以及整体可使用的内存。</p>
<p>（a）yarn.nodemanager.resource.memory-mb</p>
<p>表示该节点上YARN可使用的物理内存总量，默认是8192（MB），注意，如果你的节点内存资源不够8GB，则需要调减小这个值，而YARN不会智能的探测节点的物理内存总量。</p>
<p>（b）yarn.scheduler.maximum-allocation-mb</p>
<p>单个任务可申请的最多物理内存量，默认是8192（MB）。</p>
<h2 id="第五章：zookeeper框架"><a href="#第五章：zookeeper框架" class="headerlink" title="第五章：zookeeper框架"></a>第五章：zookeeper框架</h2><p>zookeeper的使用主要为别的分布式框架提供分布式基础，别的框架内部依赖zookeeper，不需要手动进行使用。</p>
<h2 id="第六章：-kafka框架"><a href="#第六章：-kafka框架" class="headerlink" title="第六章： kafka框架"></a>第六章： kafka框架</h2><h3 id="1、压力测试"><a href="#1、压力测试" class="headerlink" title="1、压力测试"></a>1、压力测试</h3><p>生产者发送速度 -》 发送消息的量要大，让速度稳定 -》 每一条消息大小要适度 -》 提高分区提高并发</p>
<p>消费者消费速度 -》 fetch-size 每次拉取的数据量 -》 提高分区的同时需要提高同一个消费者组中的消费者个数</p>
<h3 id="2、-机器数量计算"><a href="#2、-机器数量计算" class="headerlink" title="2、 机器数量计算"></a>2、 机器数量计算</h3><p>大概是3台kafka集群能够对应50MB/S的峰值生产速度</p>
<h3 id="3、分区数设置"><a href="#3、分区数设置" class="headerlink" title="3、分区数设置"></a>3、分区数设置</h3><p>通常设置为3-10 个</p>
<h2 id="第七章：-flume框架"><a href="#第七章：-flume框架" class="headerlink" title="第七章： flume框架"></a>第七章： flume框架</h2><h3 id="1、source组件选型"><a href="#1、source组件选型" class="headerlink" title="1、source组件选型"></a>1、source组件选型</h3><p>TailDir Source：断点续传、多目录。Flume1.6以前需要自己自定义Source记录每次读取文件位置，实现断点续传。</p>
<p>Exec Source可以实时搜集数据，但是在Flume不运行或者Shell命令出错的情况下，数据将会丢失。</p>
<p>Spooling Directory Source监控目录，支持断点续传。</p>
<p>无脑选择taildir source</p>
<h3 id="2、batchSize大小如何设置？"><a href="#2、batchSize大小如何设置？" class="headerlink" title="2、batchSize大小如何设置？"></a>2、batchSize大小如何设置？</h3><p>答：Event 1K左右时，500-1000合适（默认为100）</p>
<h3 id="3、channel选择"><a href="#3、channel选择" class="headerlink" title="3、channel选择"></a>3、channel选择</h3><p>FileChannel和MemoryChannel区别</p>
<p>MemoryChannel传输数据速度更快，但因为数据保存在JVM的堆内存中，Agent进程挂掉会导致数据丢失，适用于对数据质量要求不高的需求。</p>
<p>FileChannel传输速度相对于Memory慢，但数据安全保障高，Agent进程挂掉也可以从失败中恢复数据。</p>
<p>选型：</p>
<p>金融类公司、对钱要求非常准确的公司通常会选择FileChannel</p>
<p>传输的是普通日志信息（京东内部一天丢100万-200万条，这是非常正常的），通常选择MemoryChannel。</p>
<p>对比memory channel加kafka sink，采用Kafka Channel，省去了Sink，提高了效率。KafkaChannel数据存储在Kafka里面，所以数据是存储在磁盘中</p>
<p><strong>注意</strong>：在Flume1.7以前，Kafka Channel很少有人使用，因为发现parseAsFlumeEvent这个配置起不了作用。也就是无论parseAsFlumeEvent配置为true还是false，都会转为Flume Event。</p>
<h3 id="4、sink的使用"><a href="#4、sink的使用" class="headerlink" title="4、sink的使用"></a>4、sink的使用</h3><p>（1）HDFS存入大量小文件，有什么影响？</p>
<p><strong>元数据层面：</strong>每个小文件都有一份元数据，其中包括文件路径，文件名，所有者，所属组，权限，创建时间等，这些信息都保存在Namenode内存中。所以小文件过多，会占用Namenode服务器大量内存，影响Namenode性能和使用寿命</p>
<p><strong>计算层面：</strong>默认情况下MR会对每个小文件启用一个Map任务计算，非常影响计算性能。同时也影响磁盘寻址时间。</p>
<p>（2）HDFS小文件处理</p>
<p>官方默认的这三个参数配置写入HDFS后会产生小文件，hdfs.rollInterval、hdfs.rollSize、hdfs.rollCount</p>
<p>基于以上hdfs.rollInterval=3600，hdfs.rollSize=134217728，hdfs.rollCount =0几个参数综合作用，效果如下：</p>
<p>​    1）文件在达到128M时会滚动生成新文件</p>
<p>​    2）文件创建超3600秒时会滚动生成新文件</p>
<h3 id="5、flume的内存优化"><a href="#5、flume的内存优化" class="headerlink" title="5、flume的内存优化"></a>5、flume的内存优化</h3><p>修改内存</p>
<p>（1）在hadoop102服务器的/opt/module/flume/conf/flume-env.sh文件中增加如下配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export JAVA_OPTS=&quot;-Xms100m -Xmx2000m -Dcom.sun.management.jmxremote&quot;</span><br></pre></td></tr></table></figure>

<p>（2）同步配置到hadoop103、hadoop104服务器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 conf]$ xsync flume-env.sh</span><br></pre></td></tr></table></figure>

<p>Flume内存参数设置及优化</p>
<p>​    JVM heap一般设置为4G或更高</p>
<p>​    -Xmx与-Xms最好设置一致，减少内存抖动带来的性能影响，如果设置不一致容易导致频繁fullgc。</p>
<p>​    -Xms表示JVM Heap(堆内存)最小尺寸，初始分配；-Xmx 表示JVM Heap(堆内存)最大允许的尺寸，按需分配。如果不设置一致，容易在初始化时，由于内存不够，频繁触发fullgc。</p>
<h2 id="第八章：电商业务"><a href="#第八章：电商业务" class="headerlink" title="第八章：电商业务"></a>第八章：电商业务</h2><h3 id="1、业务分类"><a href="#1、业务分类" class="headerlink" title="1、业务分类"></a>1、业务分类</h3><p><img src="https://s2.loli.net/2022/01/12/9rfENBCmR7qA6oS.png" alt="4"></p>
<h3 id="2、电商常识"><a href="#2、电商常识" class="headerlink" title="2、电商常识"></a>2、电商常识</h3><p>SKU和SPU</p>
<pre><code> SKU=Stock Keeping Unit（库存量基本单位）。现在已经被引申为产品统一编号的简称，每种产品均对应有唯一的SKU号。
</code></pre>
<p>​     SPU（Standard Product Unit）：是商品信息聚合的最小单位，是一组可复用、易检索的标准化信息集合。</p>
<p>平台属性和销售属性 -》 显示在不同地方来搜索区分商品的属性</p>
<h3 id="3、系统表结构"><a href="#3、系统表结构" class="headerlink" title="3、系统表结构"></a>3、系统表结构</h3><p><img src="https://s2.loli.net/2022/01/12/wrGIbXdqVjTf65e.png" alt="2"></p>
<p><img src="https://s2.loli.net/2022/01/12/ZSYRGWOzHMvBj4N.png" alt="3"></p>
<p>例子：</p>
<p>活动信息表</p>
<p>​    一行数据： 表示一个活动</p>
<p>​    内容：展示一个活动的名称类型，开始时间、结束时间和创建时间</p>
<p>​    关联：无</p>
<p>略</p>
<h2 id="第九章：-同步策略"><a href="#第九章：-同步策略" class="headerlink" title="第九章： 同步策略"></a>第九章： 同步策略</h2><p>全量同步： 每天存储一份完整的数据，作为一个分区 -》 适用于表的数据量不大，每天都有新增的数据和修改的数据</p>
<p>增量同步： 每天存储一份增量数据，作为一个分区 -》 适用于每天只有数据插入的场景</p>
<p>新增及变化：每天存储一份今天新增的数据和今天有修改的数据 -》 适用于表格比较大，即会有新增也会有变化</p>
<p>特殊策略： 只需要在最开始同步一次</p>
<p><img src="https://s2.loli.net/2022/01/12/PvaIdxSeXKZ32pl.png" alt="1"></p>
<h2 id="第十章：sqoop-参数介绍"><a href="#第十章：sqoop-参数介绍" class="headerlink" title="第十章：sqoop 参数介绍"></a>第十章：sqoop 参数介绍</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bin/sqoop import \</span><br><span class="line">--connect jdbc:mysql://hadoop102:3306/gmall \ 连接地址</span><br><span class="line">--username root \ 用户名</span><br><span class="line">--password 123456 \ 密码</span><br><span class="line">--table user_info \ 表名</span><br><span class="line">--columns id,login_name \ 列名</span><br><span class="line">--where &quot;id&gt;=10 and id&lt;=30&quot; \ 过滤条件</span><br><span class="line">--target-dir /test \ hdfs的目标目录</span><br><span class="line">--delete-target-dir \ 删除目标目录的原有文件</span><br><span class="line">--fields-terminated-by &#x27;\t&#x27; \ 写入的行切分</span><br><span class="line">--num-mappers 2 \ map个数</span><br><span class="line">--split-by id  \ 切分map的条件</span><br><span class="line">--null-string &#x27;\\N&#x27; \</span><br><span class="line">--null-non-string &#x27;\\N&#x27; \  解决导入的空值问题</span><br><span class="line">--input-null-string &#x27;\\N&#x27; \</span><br><span class="line">--input-null-non-string &#x27;\\N&#x27;  解决导出的空值问题</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>BigData</category>
        <category>数仓</category>
        <category>数仓原理</category>
      </categories>
      <tags>
        <tag>数仓</tag>
      </tags>
  </entry>
  <entry>
    <title>数仓脚本</title>
    <url>/2021/05/08/%E6%95%B0%E4%BB%93%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99/</url>
    <content><![CDATA[<h2 id="一、脚本模拟数据生产脚本"><a href="#一、脚本模拟数据生产脚本" class="headerlink" title="一、脚本模拟数据生产脚本"></a>一、脚本模拟数据生产脚本</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">for i in hadoop102 hadoop103; do</span><br><span class="line">    echo &quot;========== $i ==========&quot;</span><br><span class="line">    ssh $i &quot;cd /opt/module/applog/; java -jar gmall2020-mock-log-2020-11-18.jar &gt;/dev/null 2&gt;&amp;1 &amp;&quot;</span><br><span class="line">done </span><br></pre></td></tr></table></figure>

<p>/dev/null代表linux的空设备文件，所有往这个文件里面写入的内容都会丢失，俗称“黑洞”</p>
<p>数字表示：</p>
<p>标准输入0：从键盘获得输入 /proc/self/fd/0 </p>
<p>标准输出1：输出到屏幕（即控制台） /proc/self/fd/1 </p>
<p>错误输出2：输出到屏幕（即控制台） /proc/self/fd/2</p>
<h2 id="二、查看集群进程脚本"><a href="#二、查看集群进程脚本" class="headerlink" title="二、查看集群进程脚本"></a>二、查看集群进程脚本</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">for i in hadoop102 hadoop103 hadoop104</span><br><span class="line">do</span><br><span class="line">	echo =====================  $i  =====================</span><br><span class="line">	ssh $i &quot;jps | grep -v Jps&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p><code>grep -v</code> 过滤掉包含关键字的行数据</p>
<h2 id="三、hadoop群启脚本"><a href="#三、hadoop群启脚本" class="headerlink" title="三、hadoop群启脚本"></a>三、hadoop群启脚本</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">if [ $# -lt 1 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;No Args Input...&quot;</span><br><span class="line">    exit ;</span><br><span class="line">fi</span><br><span class="line">case $1 in</span><br><span class="line">&quot;start&quot;)</span><br><span class="line">        echo &quot; =================== 启动 hadoop集群 ===================&quot;</span><br><span class="line"></span><br><span class="line">        echo &quot; --------------- 启动 hdfs ---------------&quot;</span><br><span class="line">        ssh hadoop102 &quot;/opt/module/hadoop-3.1.3/sbin/start-dfs.sh&quot;</span><br><span class="line">        echo &quot; --------------- 启动 yarn ---------------&quot;</span><br><span class="line">        ssh hadoop103 &quot;/opt/module/hadoop-3.1.3/sbin/start-yarn.sh&quot;</span><br><span class="line">        echo &quot; --------------- 启动 historyserver ---------------&quot;</span><br><span class="line">        ssh hadoop102 &quot;/opt/module/hadoop-3.1.3/bin/mapred --daemon start historyserver&quot;</span><br><span class="line">;;</span><br><span class="line">&quot;stop&quot;)</span><br><span class="line">        echo &quot; =================== 关闭 hadoop集群 ===================&quot;</span><br><span class="line"></span><br><span class="line">        echo &quot; --------------- 关闭 historyserver ---------------&quot;</span><br><span class="line">        ssh hadoop102 &quot;/opt/module/hadoop-3.1.3/bin/mapred --daemon stop historyserver&quot;</span><br><span class="line">        echo &quot; --------------- 关闭 yarn ---------------&quot;</span><br><span class="line">        ssh hadoop103 &quot;/opt/module/hadoop-3.1.3/sbin/stop-yarn.sh&quot;</span><br><span class="line">        echo &quot; --------------- 关闭 hdfs ---------------&quot;</span><br><span class="line">        ssh hadoop102 &quot;/opt/module/hadoop-3.1.3/sbin/stop-dfs.sh&quot;</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">    echo &quot;Input Args Error...&quot;</span><br><span class="line">;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<h2 id="四、zookeeper群启脚本"><a href="#四、zookeeper群启脚本" class="headerlink" title="四、zookeeper群启脚本"></a>四、zookeeper群启脚本</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">&quot;start&quot;)&#123;</span><br><span class="line">	for i in hadoop102 hadoop103 hadoop104</span><br><span class="line">	do</span><br><span class="line">        echo ---------- zookeeper $i 启动 ------------</span><br><span class="line">		ssh $i &quot;/opt/module/zookeeper-3.5.7/bin/zkServer.sh start&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;;;</span><br><span class="line">&quot;stop&quot;)&#123;</span><br><span class="line">	for i in hadoop102 hadoop103 hadoop104</span><br><span class="line">	do</span><br><span class="line">        echo ---------- zookeeper $i 停止 ------------    </span><br><span class="line">		ssh $i &quot;/opt/module/zookeeper-3.5.7/bin/zkServer.sh stop&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;;;</span><br><span class="line">&quot;status&quot;)&#123;</span><br><span class="line">	for i in hadoop102 hadoop103 hadoop104</span><br><span class="line">	do</span><br><span class="line">        echo ---------- zookeeper $i 状态 ------------    </span><br><span class="line">		ssh $i &quot;/opt/module/zookeeper-3.5.7/bin/zkServer.sh status&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<h2 id="五、群启kafka"><a href="#五、群启kafka" class="headerlink" title="五、群启kafka"></a>五、群启kafka</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">&quot;start&quot;)&#123;</span><br><span class="line">    for i in hadoop102 hadoop103 hadoop104</span><br><span class="line">    do</span><br><span class="line">        echo &quot; --------启动 $i Kafka-------&quot;</span><br><span class="line">        ssh $i &quot;/opt/module/kafka/bin/kafka-server-start.sh -daemon /opt/module/kafka/config/server.properties &quot;</span><br><span class="line">    done</span><br><span class="line">&#125;;;</span><br><span class="line">&quot;stop&quot;)&#123;</span><br><span class="line">    for i in hadoop102 hadoop103 hadoop104</span><br><span class="line">    do</span><br><span class="line">        echo &quot; --------停止 $i Kafka-------&quot;</span><br><span class="line">        ssh $i &quot;/opt/module/kafka/bin/kafka-server-stop.sh stop&quot;</span><br><span class="line">    done</span><br><span class="line">&#125;;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<h2 id="六、采集flume群启脚本"><a href="#六、采集flume群启脚本" class="headerlink" title="六、采集flume群启脚本"></a>六、采集flume群启脚本</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/bash</span></span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">&quot;start&quot;)&#123;</span><br><span class="line">        for i in hadoop102 hadoop103</span><br><span class="line">        do</span><br><span class="line">                echo &quot; --------启动 $i 采集flume-------&quot;</span><br><span class="line">                ssh $i &quot;nohup /opt/module/flume/bin/flume-ng agent --conf-file /opt/module/flume/job/file-flume-kafka.conf --name a1 -Dflume.root.logger=INFO,LOGFILE &gt;/opt/module/flume/log1.txt 2&gt;&amp;1  &amp;&quot;</span><br><span class="line">        done</span><br><span class="line">&#125;;;	</span><br><span class="line">&quot;stop&quot;)&#123;</span><br><span class="line">        for i in hadoop102 hadoop103</span><br><span class="line">        do</span><br><span class="line">                echo &quot; --------停止 $i 采集flume-------&quot;</span><br><span class="line">                ssh $i &quot;ps -ef | grep file-flume-kafka | grep -v grep |awk  &#x27;&#123;print \$2&#125;&#x27; | xargs -n1 kill -9 &quot;</span><br><span class="line">        done</span><br><span class="line"></span><br><span class="line">&#125;;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<p>其中 nohup表示不挂起，当前窗口关闭不会杀掉进程，&amp;表示后台运行，窗口能正常使用</p>
<h2 id="七、消费flume群启脚本"><a href="#七、消费flume群启脚本" class="headerlink" title="七、消费flume群启脚本"></a>七、消费flume群启脚本</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/bash</span></span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">&quot;start&quot;)&#123;</span><br><span class="line">        for i in hadoop104</span><br><span class="line">        do</span><br><span class="line">                echo &quot; --------启动 $i 消费flume-------&quot;</span><br><span class="line">                ssh $i &quot;nohup /opt/module/flume/bin/flume-ng agent --conf-file /opt/module/flume/job/kafka-flume-hdfs.conf --name a1 -Dflume.root.logger=INFO,LOGFILE &gt;/opt/module/flume/log2.txt   2&gt;&amp;1 &amp;&quot;</span><br><span class="line">        done</span><br><span class="line">&#125;;;</span><br><span class="line">&quot;stop&quot;)&#123;</span><br><span class="line">        for i in hadoop104</span><br><span class="line">        do</span><br><span class="line">                echo &quot; --------停止 $i 消费flume-------&quot;</span><br><span class="line">                ssh $i &quot;ps -ef | grep kafka-flume-hdfs | grep -v grep |awk &#x27;&#123;print \$2&#125;&#x27; | xargs -n1 kill&quot;</span><br><span class="line">        done</span><br><span class="line"></span><br><span class="line">&#125;;;</span><br><span class="line">esac</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="八、sqoop脚本编写"><a href="#八、sqoop脚本编写" class="headerlink" title="八、sqoop脚本编写"></a>八、sqoop脚本编写</h2><p>mysql_to_hdfs.sh</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=gmall</span><br><span class="line">sqoop=/opt/module/sqoop/bin/sqoop</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$2&quot; ] ;then</span><br><span class="line">    do_date=$2</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">import_data()&#123;</span><br><span class="line"><span class="meta">$</span><span class="bash">sqoop import \</span></span><br><span class="line"><span class="bash">--connect jdbc:mysql://hadoop102:3306/<span class="variable">$APP</span> \</span></span><br><span class="line"><span class="bash">--username root \</span></span><br><span class="line"><span class="bash">--password 123456 \</span></span><br><span class="line"><span class="bash">--target-dir /origin_data/<span class="variable">$APP</span>/db/<span class="variable">$1</span>/<span class="variable">$do_date</span> \</span></span><br><span class="line"><span class="bash">--delete-target-dir \</span></span><br><span class="line"><span class="bash">--query <span class="string">&quot;<span class="variable">$2</span> and  \$CONDITIONS&quot;</span> \</span></span><br><span class="line"><span class="bash">--num-mappers 1 \</span></span><br><span class="line"><span class="bash">--fields-terminated-by <span class="string">&#x27;\t&#x27;</span> \</span></span><br><span class="line"><span class="bash">--compress \</span></span><br><span class="line"><span class="bash">--compression-codec lzop \</span></span><br><span class="line"><span class="bash">--null-string <span class="string">&#x27;\\N&#x27;</span> \</span></span><br><span class="line"><span class="bash">--null-non-string <span class="string">&#x27;\\N&#x27;</span></span></span><br><span class="line"></span><br><span class="line">hadoop jar /opt/module/hadoop-3.1.3/share/hadoop/common/hadoop-lzo-0.4.20.jar com.hadoop.compression.lzo.DistributedLzoIndexer /origin_data/$APP/db/$1/$do_date</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_order_info()&#123;</span><br><span class="line">  import_data order_info &quot;select</span><br><span class="line">                            id, </span><br><span class="line">                            total_amount, </span><br><span class="line">                            order_status, </span><br><span class="line">                            user_id, </span><br><span class="line">                            payment_way,</span><br><span class="line">                            delivery_address,</span><br><span class="line">                            out_trade_no, </span><br><span class="line">                            create_time, </span><br><span class="line">                            operate_time,</span><br><span class="line">                            expire_time,</span><br><span class="line">                            tracking_no,</span><br><span class="line">                            province_id,</span><br><span class="line">                            activity_reduce_amount,</span><br><span class="line">                            coupon_reduce_amount,                            </span><br><span class="line">                            original_total_amount,</span><br><span class="line">                            feight_fee,</span><br><span class="line">                            feight_fee_reduce      </span><br><span class="line">                        from order_info</span><br><span class="line">                        where (date_format(create_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27; </span><br><span class="line">                        or date_format(operate_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27;)&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_coupon_use()&#123;</span><br><span class="line">  import_data coupon_use &quot;select</span><br><span class="line">                          id,</span><br><span class="line">                          coupon_id,</span><br><span class="line">                          user_id,</span><br><span class="line">                          order_id,</span><br><span class="line">                          coupon_status,</span><br><span class="line">                          get_time,</span><br><span class="line">                          using_time,</span><br><span class="line">                          used_time,</span><br><span class="line">                          expire_time</span><br><span class="line">                        from coupon_use</span><br><span class="line">                        where (date_format(get_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27;</span><br><span class="line">                        or date_format(using_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27;</span><br><span class="line">                        or date_format(used_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27;</span><br><span class="line">                        or date_format(expire_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27;)&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_order_status_log()&#123;</span><br><span class="line">  import_data order_status_log &quot;select</span><br><span class="line">                                  id,</span><br><span class="line">                                  order_id,</span><br><span class="line">                                  order_status,</span><br><span class="line">                                  operate_time</span><br><span class="line">                                from order_status_log</span><br><span class="line">                                where date_format(operate_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_user_info()&#123;</span><br><span class="line">  import_data &quot;user_info&quot; &quot;select </span><br><span class="line">                            id,</span><br><span class="line">                            login_name,</span><br><span class="line">                            nick_name,</span><br><span class="line">                            name,</span><br><span class="line">                            phone_num,</span><br><span class="line">                            email,</span><br><span class="line">                            user_level, </span><br><span class="line">                            birthday,</span><br><span class="line">                            gender,</span><br><span class="line">                            create_time,</span><br><span class="line">                            operate_time</span><br><span class="line">                          from user_info </span><br><span class="line">                          where (DATE_FORMAT(create_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27; </span><br><span class="line">                          or DATE_FORMAT(operate_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27;)&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_order_detail()&#123;</span><br><span class="line">  import_data order_detail &quot;select </span><br><span class="line">                              id,</span><br><span class="line">                              order_id, </span><br><span class="line">                              sku_id,</span><br><span class="line">                              sku_name,</span><br><span class="line">                              order_price,</span><br><span class="line">                              sku_num, </span><br><span class="line">                              create_time,</span><br><span class="line">                              source_type,</span><br><span class="line">                              source_id,</span><br><span class="line">                              split_total_amount,</span><br><span class="line">                              split_activity_amount,</span><br><span class="line">                              split_coupon_amount</span><br><span class="line">                            from order_detail </span><br><span class="line">                            where DATE_FORMAT(create_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_payment_info()&#123;</span><br><span class="line">  import_data &quot;payment_info&quot;  &quot;select </span><br><span class="line">                                id,  </span><br><span class="line">                                out_trade_no, </span><br><span class="line">                                order_id, </span><br><span class="line">                                user_id, </span><br><span class="line">                                payment_type, </span><br><span class="line">                                trade_no, </span><br><span class="line">                                total_amount,  </span><br><span class="line">                                subject, </span><br><span class="line">                                payment_status,</span><br><span class="line">                                create_time,</span><br><span class="line">                                callback_time </span><br><span class="line">                              from payment_info </span><br><span class="line">                              where (DATE_FORMAT(create_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27; </span><br><span class="line">                              or DATE_FORMAT(callback_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27;)&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_comment_info()&#123;</span><br><span class="line">  import_data comment_info &quot;select</span><br><span class="line">                              id,</span><br><span class="line">                              user_id,</span><br><span class="line">                              sku_id,</span><br><span class="line">                              spu_id,</span><br><span class="line">                              order_id,</span><br><span class="line">                              appraise,</span><br><span class="line">                              create_time</span><br><span class="line">                            from comment_info</span><br><span class="line">                            where date_format(create_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_order_refund_info()&#123;</span><br><span class="line">  import_data order_refund_info &quot;select</span><br><span class="line">                                id,</span><br><span class="line">                                user_id,</span><br><span class="line">                                order_id,</span><br><span class="line">                                sku_id,</span><br><span class="line">                                refund_type,</span><br><span class="line">                                refund_num,</span><br><span class="line">                                refund_amount,</span><br><span class="line">                                refund_reason_type,</span><br><span class="line">                                refund_status,</span><br><span class="line">                                create_time</span><br><span class="line">                              from order_refund_info</span><br><span class="line">                              where date_format(create_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_sku_info()&#123;</span><br><span class="line">  import_data sku_info &quot;select </span><br><span class="line">                          id,</span><br><span class="line">                          spu_id,</span><br><span class="line">                          price,</span><br><span class="line">                          sku_name,</span><br><span class="line">                          sku_desc,</span><br><span class="line">                          weight,</span><br><span class="line">                          tm_id,</span><br><span class="line">                          category3_id,</span><br><span class="line">                          is_sale,</span><br><span class="line">                          create_time</span><br><span class="line">                        from sku_info where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_base_category1()&#123;</span><br><span class="line">  import_data &quot;base_category1&quot; &quot;select </span><br><span class="line">                                  id,</span><br><span class="line">                                  name </span><br><span class="line">                                from base_category1 where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_base_category2()&#123;</span><br><span class="line">  import_data &quot;base_category2&quot; &quot;select</span><br><span class="line">                                  id,</span><br><span class="line">                                  name,</span><br><span class="line">                                  category1_id </span><br><span class="line">                                from base_category2 where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_base_category3()&#123;</span><br><span class="line">  import_data &quot;base_category3&quot; &quot;select</span><br><span class="line">                                  id,</span><br><span class="line">                                  name,</span><br><span class="line">                                  category2_id</span><br><span class="line">                                from base_category3 where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_base_province()&#123;</span><br><span class="line">  import_data base_province &quot;select</span><br><span class="line">                              id,</span><br><span class="line">                              name,</span><br><span class="line">                              region_id,</span><br><span class="line">                              area_code,</span><br><span class="line">                              iso_code,</span><br><span class="line">                              iso_3166_2</span><br><span class="line">                            from base_province</span><br><span class="line">                            where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_base_region()&#123;</span><br><span class="line">  import_data base_region &quot;select</span><br><span class="line">                              id,</span><br><span class="line">                              region_name</span><br><span class="line">                            from base_region</span><br><span class="line">                            where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_base_trademark()&#123;</span><br><span class="line">  import_data base_trademark &quot;select</span><br><span class="line">                                id,</span><br><span class="line">                                tm_name</span><br><span class="line">                              from base_trademark</span><br><span class="line">                              where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_spu_info()&#123;</span><br><span class="line">  import_data spu_info &quot;select</span><br><span class="line">                            id,</span><br><span class="line">                            spu_name,</span><br><span class="line">                            category3_id,</span><br><span class="line">                            tm_id</span><br><span class="line">                          from spu_info</span><br><span class="line">                          where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_favor_info()&#123;</span><br><span class="line">  import_data favor_info &quot;select</span><br><span class="line">                          id,</span><br><span class="line">                          user_id,</span><br><span class="line">                          sku_id,</span><br><span class="line">                          spu_id,</span><br><span class="line">                          is_cancel,</span><br><span class="line">                          create_time,</span><br><span class="line">                          cancel_time</span><br><span class="line">                        from favor_info</span><br><span class="line">                        where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_cart_info()&#123;</span><br><span class="line">  import_data cart_info &quot;select</span><br><span class="line">                        id,</span><br><span class="line">                        user_id,</span><br><span class="line">                        sku_id,</span><br><span class="line">                        cart_price,</span><br><span class="line">                        sku_num,</span><br><span class="line">                        sku_name,</span><br><span class="line">                        create_time,</span><br><span class="line">                        operate_time,</span><br><span class="line">                        is_ordered,</span><br><span class="line">                        order_time,</span><br><span class="line">                        source_type,</span><br><span class="line">                        source_id</span><br><span class="line">                      from cart_info</span><br><span class="line">                      where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_coupon_info()&#123;</span><br><span class="line">  import_data coupon_info &quot;select</span><br><span class="line">                          id,</span><br><span class="line">                          coupon_name,</span><br><span class="line">                          coupon_type,</span><br><span class="line">                          condition_amount,</span><br><span class="line">                          condition_num,</span><br><span class="line">                          activity_id,</span><br><span class="line">                          benefit_amount,</span><br><span class="line">                          benefit_discount,</span><br><span class="line">                          create_time,</span><br><span class="line">                          range_type,</span><br><span class="line">                          limit_num,</span><br><span class="line">                          taken_count,</span><br><span class="line">                          start_time,</span><br><span class="line">                          end_time,</span><br><span class="line">                          operate_time,</span><br><span class="line">                          expire_time</span><br><span class="line">                        from coupon_info</span><br><span class="line">                        where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_activity_info()&#123;</span><br><span class="line">  import_data activity_info &quot;select</span><br><span class="line">                              id,</span><br><span class="line">                              activity_name,</span><br><span class="line">                              activity_type,</span><br><span class="line">                              start_time,</span><br><span class="line">                              end_time,</span><br><span class="line">                              create_time</span><br><span class="line">                            from activity_info</span><br><span class="line">                            where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_activity_rule()&#123;</span><br><span class="line">    import_data activity_rule &quot;select</span><br><span class="line">                                    id,</span><br><span class="line">                                    activity_id,</span><br><span class="line">                                    activity_type,</span><br><span class="line">                                    condition_amount,</span><br><span class="line">                                    condition_num,</span><br><span class="line">                                    benefit_amount,</span><br><span class="line">                                    benefit_discount,</span><br><span class="line">                                    benefit_level</span><br><span class="line">                                from activity_rule</span><br><span class="line">                                where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_base_dic()&#123;</span><br><span class="line">    import_data base_dic &quot;select</span><br><span class="line">                            dic_code,</span><br><span class="line">                            dic_name,</span><br><span class="line">                            parent_code,</span><br><span class="line">                            create_time,</span><br><span class="line">                            operate_time</span><br><span class="line">                          from base_dic</span><br><span class="line">                          where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import_order_detail_activity()&#123;</span><br><span class="line">    import_data order_detail_activity &quot;select</span><br><span class="line">                                                                id,</span><br><span class="line">                                                                order_id,</span><br><span class="line">                                                                order_detail_id,</span><br><span class="line">                                                                activity_id,</span><br><span class="line">                                                                activity_rule_id,</span><br><span class="line">                                                                sku_id,</span><br><span class="line">                                                                create_time</span><br><span class="line">                                                            from order_detail_activity</span><br><span class="line">                                                            where date_format(create_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import_order_detail_coupon()&#123;</span><br><span class="line">    import_data order_detail_coupon &quot;select</span><br><span class="line">                                                                id,</span><br><span class="line">                                                                order_detail_id,</span><br><span class="line">                                                                coupon_id,</span><br><span class="line">                                                                coupon_use_id,</span><br><span class="line">                                                                sku_id,</span><br><span class="line">                                                                create_time</span><br><span class="line">                                                            from order_detail_coupon</span><br><span class="line">                                                            where date_format(create_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import_refund_payment()&#123;</span><br><span class="line">    import_data refund_payment &quot;select</span><br><span class="line">                                                        id,</span><br><span class="line">                                                        out_trade_no,</span><br><span class="line">                                                        order_id,</span><br><span class="line">                                                        sku_id,</span><br><span class="line">                                                        payment_type,</span><br><span class="line">                                                        trade_no,</span><br><span class="line">                                                        total_amount,</span><br><span class="line">                                                        subject,</span><br><span class="line">                                                        refund_status,</span><br><span class="line">                                                        create_time,</span><br><span class="line">                                                        callback_time</span><br><span class="line">                                                    from refund_payment</span><br><span class="line">                                                    where (DATE_FORMAT(create_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27; </span><br><span class="line">                                                    or DATE_FORMAT(callback_time,&#x27;%Y-%m-%d&#x27;)=&#x27;$do_date&#x27;)&quot;                                                    </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import_sku_attr_value()&#123;</span><br><span class="line">    import_data sku_attr_value &quot;select</span><br><span class="line">                                                    id,</span><br><span class="line">                                                    attr_id,</span><br><span class="line">                                                    value_id,</span><br><span class="line">                                                    sku_id,</span><br><span class="line">                                                    attr_name,</span><br><span class="line">                                                    value_name</span><br><span class="line">                                                from sku_attr_value</span><br><span class="line">                                                where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import_sku_sale_attr_value()&#123;</span><br><span class="line">    import_data sku_sale_attr_value &quot;select</span><br><span class="line">                                                            id,</span><br><span class="line">                                                            sku_id,</span><br><span class="line">                                                            spu_id,</span><br><span class="line">                                                            sale_attr_value_id,</span><br><span class="line">                                                            sale_attr_id,</span><br><span class="line">                                                            sale_attr_name,</span><br><span class="line">                                                            sale_attr_value_name</span><br><span class="line">                                                        from sku_sale_attr_value</span><br><span class="line">                                                        where 1=1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">  &quot;order_info&quot;)</span><br><span class="line">     import_order_info</span><br><span class="line">;;</span><br><span class="line">  &quot;base_category1&quot;)</span><br><span class="line">     import_base_category1</span><br><span class="line">;;</span><br><span class="line">  &quot;base_category2&quot;)</span><br><span class="line">     import_base_category2</span><br><span class="line">;;</span><br><span class="line">  &quot;base_category3&quot;)</span><br><span class="line">     import_base_category3</span><br><span class="line">;;</span><br><span class="line">  &quot;order_detail&quot;)</span><br><span class="line">     import_order_detail</span><br><span class="line">;;</span><br><span class="line">  &quot;sku_info&quot;)</span><br><span class="line">     import_sku_info</span><br><span class="line">;;</span><br><span class="line">  &quot;user_info&quot;)</span><br><span class="line">     import_user_info</span><br><span class="line">;;</span><br><span class="line">  &quot;payment_info&quot;)</span><br><span class="line">     import_payment_info</span><br><span class="line">;;</span><br><span class="line">  &quot;base_province&quot;)</span><br><span class="line">     import_base_province</span><br><span class="line">;;</span><br><span class="line">  &quot;base_region&quot;)</span><br><span class="line">     import_base_region</span><br><span class="line">;;</span><br><span class="line">  &quot;base_trademark&quot;)</span><br><span class="line">     import_base_trademark</span><br><span class="line">;;</span><br><span class="line">  &quot;activity_info&quot;)</span><br><span class="line">      import_activity_info</span><br><span class="line">;;</span><br><span class="line">  &quot;cart_info&quot;)</span><br><span class="line">      import_cart_info</span><br><span class="line">;;</span><br><span class="line">  &quot;comment_info&quot;)</span><br><span class="line">      import_comment_info</span><br><span class="line">;;</span><br><span class="line">  &quot;coupon_info&quot;)</span><br><span class="line">      import_coupon_info</span><br><span class="line">;;</span><br><span class="line">  &quot;coupon_use&quot;)</span><br><span class="line">      import_coupon_use</span><br><span class="line">;;</span><br><span class="line">  &quot;favor_info&quot;)</span><br><span class="line">      import_favor_info</span><br><span class="line">;;</span><br><span class="line">  &quot;order_refund_info&quot;)</span><br><span class="line">      import_order_refund_info</span><br><span class="line">;;</span><br><span class="line">  &quot;order_status_log&quot;)</span><br><span class="line">      import_order_status_log</span><br><span class="line">;;</span><br><span class="line">  &quot;spu_info&quot;)</span><br><span class="line">      import_spu_info</span><br><span class="line">;;</span><br><span class="line">  &quot;activity_rule&quot;)</span><br><span class="line">      import_activity_rule</span><br><span class="line">;;</span><br><span class="line">  &quot;base_dic&quot;)</span><br><span class="line">      import_base_dic</span><br><span class="line">;;</span><br><span class="line">  &quot;order_detail_activity&quot;)</span><br><span class="line">      import_order_detail_activity</span><br><span class="line">;;</span><br><span class="line">  &quot;order_detail_coupon&quot;)</span><br><span class="line">      import_order_detail_coupon</span><br><span class="line">;;</span><br><span class="line">  &quot;refund_payment&quot;)</span><br><span class="line">      import_refund_payment</span><br><span class="line">;;</span><br><span class="line">  &quot;sku_attr_value&quot;)</span><br><span class="line">      import_sku_attr_value</span><br><span class="line">;;</span><br><span class="line">  &quot;sku_sale_attr_value&quot;)</span><br><span class="line">      import_sku_sale_attr_value</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">&quot;first&quot;)</span><br><span class="line">   import_base_category1</span><br><span class="line">   import_base_category2</span><br><span class="line">   import_base_category3</span><br><span class="line">   import_order_info</span><br><span class="line">   import_order_detail</span><br><span class="line">   import_sku_info</span><br><span class="line">   import_user_info</span><br><span class="line">   import_payment_info</span><br><span class="line">   import_base_province</span><br><span class="line">   import_base_region</span><br><span class="line">   import_base_trademark</span><br><span class="line">   import_activity_info</span><br><span class="line">   import_cart_info</span><br><span class="line">   import_comment_info</span><br><span class="line">   import_coupon_use</span><br><span class="line">   import_coupon_info</span><br><span class="line">   import_favor_info</span><br><span class="line">   import_order_refund_info</span><br><span class="line">   import_order_status_log</span><br><span class="line">   import_spu_info</span><br><span class="line">   import_activity_rule</span><br><span class="line">   import_base_dic</span><br><span class="line">   import_order_detail_activity</span><br><span class="line">   import_order_detail_coupon</span><br><span class="line">   import_refund_payment</span><br><span class="line">   import_sku_attr_value</span><br><span class="line">   import_sku_sale_attr_value</span><br><span class="line">;;</span><br><span class="line">&quot;all&quot;)</span><br><span class="line">   import_base_category1</span><br><span class="line">   import_base_category2</span><br><span class="line">   import_base_category3</span><br><span class="line">   import_order_info</span><br><span class="line">   import_order_detail</span><br><span class="line">   import_sku_info</span><br><span class="line">   import_user_info</span><br><span class="line">   import_payment_info</span><br><span class="line">   import_base_trademark</span><br><span class="line">   import_activity_info</span><br><span class="line">   import_cart_info</span><br><span class="line">   import_comment_info</span><br><span class="line">   import_coupon_use</span><br><span class="line">   import_coupon_info</span><br><span class="line">   import_favor_info</span><br><span class="line">   import_order_refund_info</span><br><span class="line">   import_order_status_log</span><br><span class="line">   import_spu_info</span><br><span class="line">   import_activity_rule</span><br><span class="line">   import_base_dic</span><br><span class="line">   import_order_detail_activity</span><br><span class="line">   import_order_detail_coupon</span><br><span class="line">   import_refund_payment</span><br><span class="line">   import_sku_attr_value</span><br><span class="line">   import_sku_sale_attr_value</span><br><span class="line">;;</span><br><span class="line">esac</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>BigData</category>
        <category>数仓</category>
        <category>数仓脚本</category>
      </categories>
      <tags>
        <tag>数仓</tag>
      </tags>
  </entry>
  <entry>
    <title>数仓采集平台搭建步骤</title>
    <url>/2021/05/08/%E6%95%B0%E4%BB%93%E9%87%87%E9%9B%86%E5%B9%B3%E5%8F%B0/</url>
    <content><![CDATA[<h2 id="一、服务器准备"><a href="#一、服务器准备" class="headerlink" title="一、服务器准备"></a>一、服务器准备</h2><h3 id="1、-修改静态IP"><a href="#1、-修改静态IP" class="headerlink" title="1、 修改静态IP"></a>1、 修改静态IP</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hadoop102 ~]<span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-ens33</span></span><br><span class="line"></span><br><span class="line">DEVICE=ens33</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">ONBOOT=yes</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">NAME=<span class="string">&quot;ens33&quot;</span></span><br><span class="line">PREFIX=24</span><br><span class="line">IPADDR=192.168.1.102</span><br><span class="line">GATEWAY=192.168.1.2</span><br><span class="line">DNS1=192.168.1.2</span><br></pre></td></tr></table></figure>

<h3 id="2、-修改主机名称"><a href="#2、-修改主机名称" class="headerlink" title="2、 修改主机名称"></a>2、 修改主机名称</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hadoop102 ~]<span class="comment"># hostnamectl --static set-hostname hadoop102</span></span><br></pre></td></tr></table></figure>

<h3 id="3、-配置主机名称映射，打开-etc-hosts"><a href="#3、-配置主机名称映射，打开-etc-hosts" class="headerlink" title="3、 配置主机名称映射，打开/etc/hosts"></a>3、 配置主机名称映射，打开/etc/hosts</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hadoop102 ~]<span class="comment"># vim /etc/hosts</span></span><br></pre></td></tr></table></figure>

<p>添加如内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">192.168.1.100 hadoop100</span><br><span class="line">192.168.1.101 hadoop101</span><br><span class="line">192.168.1.102 hadoop102</span><br><span class="line">192.168.1.103 hadoop103</span><br><span class="line">192.168.1.104 hadoop104</span><br><span class="line">192.168.1.105 hadoop105</span><br><span class="line">192.168.1.106 hadoop106</span><br><span class="line">192.168.1.107 hadoop107</span><br><span class="line">192.168.1.108 hadoop108</span><br></pre></td></tr></table></figure>

<h3 id="4、-关闭防火墙"><a href="#4、-关闭防火墙" class="headerlink" title="4、 关闭防火墙"></a>4、 关闭防火墙</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hadoop102 ~]<span class="comment"># systemctl stop firewalld</span></span><br><span class="line">[root@hadoop102 ~]<span class="comment"># systemctl disable firewalld</span></span><br></pre></td></tr></table></figure>

<h3 id="5、-给用户配置root权限"><a href="#5、-给用户配置root权限" class="headerlink" title="5、 给用户配置root权限"></a>5、 给用户配置root权限</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@hadoop102 ~]<span class="comment"># vim /etc/sudoers</span></span><br></pre></td></tr></table></figure>

<p>修改/etc/sudoers文件，找到下面一行（102行），在%wheel下面添加一行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## Allow root to run any commands anywhere</span></span><br><span class="line">root    ALL=(ALL)     ALL</span><br><span class="line">%wheel  ALL=(ALL)       ALL</span><br><span class="line">logan   ALL=(ALL)     NOPASSWD: ALL</span><br></pre></td></tr></table></figure>

<h3 id="6、-SSH免密登录"><a href="#6、-SSH免密登录" class="headerlink" title="6、 SSH免密登录"></a>6、 SSH免密登录</h3><p>生成公钥和私钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 .ssh]$ ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>

<p>将公钥拷贝到要免密登录的目标机器上</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 .ssh]$ ssh-copy-id hadoop102</span><br><span class="line">[logan@hadoop102 .ssh]$ ssh-copy-id hadoop103</span><br><span class="line">[logan@hadoop102 .ssh]$ ssh-copy-id hadoop104</span><br></pre></td></tr></table></figure>

<h2 id="二、安装JDK"><a href="#二、安装JDK" class="headerlink" title="二、安装JDK"></a>二、安装JDK</h2><h3 id="1、-卸载现有JDK"><a href="#1、-卸载现有JDK" class="headerlink" title="1、 卸载现有JDK"></a>1、 卸载现有JDK</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 opt]<span class="comment"># sudo rpm -qa | grep -i java | xargs -n1 sudo rpm -e --nodeps</span></span><br></pre></td></tr></table></figure>

<h3 id="2、-解压JDK到-opt-module目录下"><a href="#2、-解压JDK到-opt-module目录下" class="headerlink" title="2、 解压JDK到/opt/module目录下"></a>2、 解压JDK到/opt/module目录下</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]<span class="comment"># tar -zxvf jdk-8u212-linux-x64.tar.gz -C /opt/module/</span></span><br></pre></td></tr></table></figure>

<h3 id="3、-配置JDK环境变量"><a href="#3、-配置JDK环境变量" class="headerlink" title="3、 配置JDK环境变量"></a>3、 配置JDK环境变量</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 module]<span class="comment"># sudo vim /etc/profile.d/my_env.sh</span></span><br></pre></td></tr></table></figure>

<p>添加如下内容，然后保存（:wq）退出</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#JAVA_HOME</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/module/jdk1.8.0_212</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br></pre></td></tr></table></figure>

<p>让环境变量生效</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ <span class="built_in">source</span> /etc/profile.d/my_env.sh</span><br></pre></td></tr></table></figure>

<p>测试JDK是否安装成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 module]<span class="comment"># java -version</span></span><br></pre></td></tr></table></figure>

<p>分发环境变量配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 module]$ sudo /home/logan/bin/xsync /etc/profile.d/my_env.sh</span><br></pre></td></tr></table></figure>

<p>分别在hadoop103、hadoop104上执行source</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop103 module]$ <span class="built_in">source</span> /etc/profile.d/my_env.sh</span><br><span class="line">[logan@hadoop104 module]$ <span class="built_in">source</span> /etc/profile.d/my_env.sh</span><br></pre></td></tr></table></figure>

<h2 id="三、安装hadoop"><a href="#三、安装hadoop" class="headerlink" title="三、安装hadoop"></a>三、安装hadoop</h2><h3 id="1、-解压安装包"><a href="#1、-解压安装包" class="headerlink" title="1、 解压安装包"></a>1、 解压安装包</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ tar -zxvf hadoop-3.1.3.tar.gz -C /opt/module/</span><br></pre></td></tr></table></figure>

<h3 id="2、-将Hadoop添加到环境变量"><a href="#2、-将Hadoop添加到环境变量" class="headerlink" title="2、 将Hadoop添加到环境变量"></a>2、 将Hadoop添加到环境变量</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 hadoop-3.1.3]$ sudo vim /etc/profile.d/my_env.sh</span><br></pre></td></tr></table></figure>

<p>在profile文件末尾添加JDK路径：（shitf+g）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#HADOOP_HOME</span></span><br><span class="line"><span class="built_in">export</span> HADOOP_HOME=/opt/module/hadoop-3.1.3</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HADOOP_HOME</span>/bin</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HADOOP_HOME</span>/sbin</span><br></pre></td></tr></table></figure>

<h3 id="3、-分发环境变量文件"><a href="#3、-分发环境变量文件" class="headerlink" title="3、 分发环境变量文件"></a>3、 分发环境变量文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 hadoop-3.1.3]$ sudo /home/logan/bin/xsync /etc/profile.d/my_env.sh</span><br></pre></td></tr></table></figure>

<h3 id="4、-source-是之生效（3台节点）"><a href="#4、-source-是之生效（3台节点）" class="headerlink" title="4、 source 是之生效（3台节点）"></a>4、 source 是之生效（3台节点）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 module]$ <span class="built_in">source</span> /etc/profile.d/my_env.sh</span><br><span class="line">[logan@hadoop103 module]$ <span class="built_in">source</span> /etc/profile.d/my_env.sh</span><br><span class="line">[logan@hadoop104 module]$ <span class="built_in">source</span> /etc/profile.d/my_env.sh</span><br></pre></td></tr></table></figure>

<h3 id="5、-配置文件"><a href="#5、-配置文件" class="headerlink" title="5、 配置文件"></a>5、 配置文件</h3><p>core-site.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 指定NameNode的地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://hadoop102:8020<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 指定hadoop数据的存储目录 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/module/hadoop-3.1.3/data<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置HDFS网页登录使用的静态用户为logan --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.http.staticuser.user<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>logan<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置该logansuperUser、允许通过代理访问的主机节点 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.proxyuser.logan.hosts<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>*<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 配置该logansuperUser、允许通过代理用户所属组 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.proxyuser.logan.groups<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>*<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 配置该logansuperUser、允许通过代理的用户--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.proxyuser.logan.users<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>*<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>hdfs-site.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- nn web端访问地址--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.http-address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop102:9870<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">&lt;!-- 2nn web端访问地址--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.secondary.http-address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop104:9868<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 测试环境指定HDFS副本的数量1 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yarn-site.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 指定MR走shuffle --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 指定ResourceManager的地址--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.hostname<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop103<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 环境变量的继承 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.env-whitelist<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>JAVA_HOME,HADOOP_COMMON_HOME,HADOOP_HDFS_HOME,HADOOP_CONF_DIR,CLASSPATH_PREPEND_DISTCACHE,HADOOP_YARN_HOME,HADOOP_MAPRED_HOME<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- yarn容器允许分配的最大最小内存 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.minimum-allocation-mb<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>512<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.maximum-allocation-mb<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>4096<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- yarn容器允许管理的物理内存大小 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.resource.memory-mb<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>4096<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 关闭yarn对物理内存和虚拟内存的限制检查 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.pmem-check-enabled<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.vmem-check-enabled<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 开启日志聚集功能 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.log-aggregation-enable<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 设置日志聚集服务器地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.log.server.url<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>http://hadoop102:19888/jobhistory/logs<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 设置日志保留时间为7天 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.log-aggregation.retain-seconds<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>604800<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>mapred-site.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 指定MapReduce程序运行在Yarn上 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 历史服务器端地址 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.jobhistory.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop102:10020<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 历史服务器web端地址 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.jobhistory.webapp.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop102:19888<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>workers</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hadoop102</span><br><span class="line">hadoop103</span><br><span class="line">hadoop104</span><br></pre></td></tr></table></figure>

<h3 id="6、-分发hadoop"><a href="#6、-分发hadoop" class="headerlink" title="6、 分发hadoop"></a>6、 分发hadoop</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 hadoop]$ xsync /opt/module/hadoop-3.1.3/</span><br></pre></td></tr></table></figure>

<h3 id="7、-初始化namenode"><a href="#7、-初始化namenode" class="headerlink" title="7、 初始化namenode"></a>7、 初始化namenode</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 hadoop-3.1.3]$ bin/hdfs namenode -format</span><br></pre></td></tr></table></figure>

<h3 id="8、-启动hdfs-amp-yarn"><a href="#8、-启动hdfs-amp-yarn" class="headerlink" title="8、 启动hdfs&amp;yarn"></a>8、 启动hdfs&amp;yarn</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 hadoop-3.1.3]$ sbin/start-dfs.sh</span><br><span class="line">[logan@hadoop103 hadoop-3.1.3]$ sbin/start-yarn.sh</span><br></pre></td></tr></table></figure>

<h3 id="补充：集群时间同步"><a href="#补充：集群时间同步" class="headerlink" title="补充：集群时间同步"></a>补充：集群时间同步</h3><h4 id="1）时间服务器配置（必须root用户）"><a href="#1）时间服务器配置（必须root用户）" class="headerlink" title="1）时间服务器配置（必须root用户）"></a>1）时间服务器配置（必须root用户）</h4><p>（0）查看所有节点ntpd服务状态和开机自启动状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 ~]$ sudo systemctl status ntpd</span><br><span class="line">[logan@hadoop102 ~]$ sudo systemctl is-enabled ntpd</span><br></pre></td></tr></table></figure>

<p>（1）在所有节点关闭ntp服务和自启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 ~]$ sudo systemctl stop ntpd</span><br><span class="line">[logan@hadoop102 ~]$ sudo systemctl <span class="built_in">disable</span> ntpd</span><br></pre></td></tr></table></figure>

<p>（2）修改hadoop102的ntp.conf配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 ~]$ sudo vim /etc/ntp.conf</span><br></pre></td></tr></table></figure>

<p>修改内容如下</p>
<p>a）修改1（授权192.168.1.0-192.168.1.255网段上的所有机器可以从这台机器上查询和同步时间）</p>
<p>打开配置</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap</span></span><br><span class="line">为</span><br><span class="line">restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap</span><br></pre></td></tr></table></figure>

<p> b）修改2（集群在局域网中，不使用其他互联网上的时间）</p>
<p>关闭配置</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">server 0.centos.pool.ntp.org iburst</span><br><span class="line">server 1.centos.pool.ntp.org iburst</span><br><span class="line">server 2.centos.pool.ntp.org iburst</span><br><span class="line">server 3.centos.pool.ntp.org iburst</span><br><span class="line">为</span><br><span class="line"><span class="meta">#</span><span class="bash">server 0.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 1.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 2.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 3.centos.pool.ntp.org iburst</span></span><br></pre></td></tr></table></figure>

<p>c）添加3（当该节点丢失网络连接，依然可以采用本地时间作为时间服务器为集群中的其他节点提供时间同步）</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">server 127.127.1.0</span><br><span class="line">fudge 127.127.1.0 stratum 10</span><br></pre></td></tr></table></figure>



<p>（3）修改hadoop102的/etc/sysconfig/ntpd 文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 ~]$ sudo vim /etc/sysconfig/ntpd</span><br></pre></td></tr></table></figure>

<p>增加内容如下（让硬件时间与系统时间一起同步）</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">SYNC_HWCLOCK=yes</span><br></pre></td></tr></table></figure>

<p>（4）重新启动ntpd服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 ~]$ sudo systemctl start ntpd</span><br></pre></td></tr></table></figure>

<p>（5）设置ntpd服务开机启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 ~]$ sudo systemctl <span class="built_in">enable</span> ntpd</span><br></pre></td></tr></table></figure>

<h4 id="2）其他机器配置（必须root用户）"><a href="#2）其他机器配置（必须root用户）" class="headerlink" title="2）其他机器配置（必须root用户）"></a>2）其他机器配置（必须root用户）</h4><p>（1）在其他机器配置10分钟与时间服务器同步一次</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop103 ~]$ sudo crontab -e</span><br></pre></td></tr></table></figure>

<p>编写定时任务如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">*/10 * * * * /usr/sbin/ntpdate hadoop102</span><br></pre></td></tr></table></figure>

<p>（2）修改任意机器时间</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop103 ~]$ sudo date -s <span class="string">&quot;2017-9-11 11:11:11&quot;</span></span><br></pre></td></tr></table></figure>

<p>（3）十分钟后查看机器是否与时间服务器同步</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop103 ~]$ sudo date</span><br></pre></td></tr></table></figure>

<p>说明：测试的时候可以将10分钟调整为1分钟，节省时间。</p>
<h3 id="9、-集群数据均衡"><a href="#9、-集群数据均衡" class="headerlink" title="9、 集群数据均衡"></a>9、 集群数据均衡</h3><p>1、  节点间数据均衡</p>
<p>​    不同电脑直接的数据进行均衡</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">start-balancer.sh -threshold 10</span><br></pre></td></tr></table></figure>

<p>​    默认开启10%</p>
<p>​    停止命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">stop-balancer.sh</span><br></pre></td></tr></table></figure>

<p>2、 磁盘间数据均衡</p>
<p>​    同一台电脑进行均衡</p>
<p>（1）生成均衡计划（我们只有一块磁盘，不会生成计划）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hdfs diskbalancer -plan hadoop103</span><br></pre></td></tr></table></figure>

<p>（2）执行均衡计划</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hdfs diskbalancer -execute hadoop103.plan.json</span><br></pre></td></tr></table></figure>

<p>（3）查看当前均衡任务的执行情况</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hdfs diskbalancer -query hadoop103</span><br></pre></td></tr></table></figure>

<p>（4）取消均衡任务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hdfs diskbalancer -cancel hadoop103.plan.json</span><br></pre></td></tr></table></figure>

<h3 id="10、-LZO压缩"><a href="#10、-LZO压缩" class="headerlink" title="10、 LZO压缩"></a>10、 LZO压缩</h3><p>添加LZO压缩</p>
<p>将编译好后的hadoop-lzo-0.4.20.jar 放入hadoop-3.1.3/share/hadoop/common/</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 common]$ pwd </span><br><span class="line">/opt/module/hadoop-3.1.3/share/hadoop/common</span><br><span class="line">[logan@hadoop102 common]$ ls</span><br><span class="line">hadoop-lzo-0.4.20.jar</span><br></pre></td></tr></table></figure>

<p>同步hadoop-lzo-0.4.20.jar到hadoop103、hadoop104</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 common]$ xsync hadoop-lzo-0.4.20.jar</span><br></pre></td></tr></table></figure>

<p>core-site.xml增加配置支持LZO压缩</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>io.compression.codecs<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">            org.apache.hadoop.io.compress.GzipCodec,</span><br><span class="line">            org.apache.hadoop.io.compress.DefaultCodec,</span><br><span class="line">            org.apache.hadoop.io.compress.BZip2Codec,</span><br><span class="line">            org.apache.hadoop.io.compress.SnappyCodec,</span><br><span class="line">            com.hadoop.compression.lzo.LzoCodec,</span><br><span class="line">            com.hadoop.compression.lzo.LzopCodec</span><br><span class="line">        <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>io.compression.codec.lzo.class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>com.hadoop.compression.lzo.LzoCodec<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>之后分发配置文件并重启集群</p>
<p>给LZO文件添加索引的命令:</p>
<p>jar包名,类名加文件在hdfs上的地址</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 module]$ hadoop jar /opt/module/hadoop-3.1.3/share/hadoop/common/hadoop-lzo-0.4.20.jar  com.hadoop.compression.lzo.DistributedLzoIndexer /input/bigtable.lzo</span><br></pre></td></tr></table></figure>

<h2 id="四、安装zookeeper"><a href="#四、安装zookeeper" class="headerlink" title="四、安装zookeeper"></a>四、安装zookeeper</h2><h3 id="1、解压安装"><a href="#1、解压安装" class="headerlink" title="1、解压安装"></a>1、解压安装</h3><p>解压Zookeeper安装包到/opt/module/目录下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ tar -zxvf zookeeper-3.5.7.tar.gz -C /opt/module/</span><br></pre></td></tr></table></figure>

<p>修改/opt/module/apache-zookeeper-3.5.7-bin名称为zookeeper-3.5.7</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 module]$ mv apache-zookeeper-3.5.7-bin/ zookeeper-3.5.7</span><br></pre></td></tr></table></figure>

<p>同步/opt/module/zookeeper-3.5.7目录内容到hadoop103、hadoop104</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 module]$ xsync zookeeper-3.5.7/</span><br></pre></td></tr></table></figure>

<h3 id="2、配置服务器编号"><a href="#2、配置服务器编号" class="headerlink" title="2、配置服务器编号"></a>2、配置服务器编号</h3><p>在/opt/module/zookeeper-3.5.7/这个目录下创建zkData</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 zookeeper-3.5.7]$ mkdir zkData</span><br></pre></td></tr></table></figure>

<p>在/opt/module/zookeeper-3.5.7/zkData目录下创建一个myid的文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 zkData]$ vi myid</span><br></pre></td></tr></table></figure>

<p>在文件中添加与server对应的编号：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2</span><br></pre></td></tr></table></figure>

<p>拷贝配置好的zookeeper到其他机器上</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 zkData]$ xsync myid</span><br></pre></td></tr></table></figure>

<p>并分别在hadoop103、hadoop104上修改myid文件中内容为3、4</p>
<h3 id="3、配置zoo-cfg文件"><a href="#3、配置zoo-cfg文件" class="headerlink" title="3、配置zoo.cfg文件"></a>3、配置zoo.cfg文件</h3><p>重命名/opt/module/zookeeper-3.5.7/conf这个目录下的zoo_sample.cfg为zoo.cfg</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 conf]$ mv zoo_sample.cfg zoo.cfg</span><br></pre></td></tr></table></figure>

<p>打开zoo.cfg文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 conf]$ vim zoo.cfg</span><br></pre></td></tr></table></figure>

<p>修改数据存储路径配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dataDir=/opt/module/zookeeper-3.5.7/zkData</span><br><span class="line"></span><br><span class="line">#######################cluster##########################</span><br><span class="line">server.2=hadoop102:2888:3888</span><br><span class="line">server.3=hadoop103:2888:3888</span><br><span class="line">server.4=hadoop104:2888:3888</span><br></pre></td></tr></table></figure>

<p>同步zoo.cfg配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 conf]$ xsync zoo.cfg</span><br></pre></td></tr></table></figure>

<h2 id="五、安装kafka"><a href="#五、安装kafka" class="headerlink" title="五、安装kafka"></a>五、安装kafka</h2><h3 id="1、解压安装-1"><a href="#1、解压安装-1" class="headerlink" title="1、解压安装"></a>1、解压安装</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ tar -zxvf kafka_2.11-2.4.1.tgz -C /opt/module/</span><br></pre></td></tr></table></figure>

<p>修改解压后的文件名称</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 module]$ mv kafka_2.11-2.4.1/ kafka</span><br></pre></td></tr></table></figure>

<p>在/opt/module/kafka目录下创建datas文件夹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 kafka]$ mkdir datas</span><br></pre></td></tr></table></figure>

<h3 id="2、修改配置文件"><a href="#2、修改配置文件" class="headerlink" title="2、修改配置文件"></a>2、修改配置文件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 kafka]$ cd config/</span><br><span class="line">[logan@hadoop102 config]$ vim server.properties</span><br><span class="line">修改或者增加以下内容：</span><br><span class="line">#broker的全局唯一编号，不能重复</span><br><span class="line">broker.id=0</span><br><span class="line">#kafka运行日志存放的路径</span><br><span class="line">log.dirs=/opt/module/kafka/datas</span><br><span class="line">#配置连接Zookeeper集群地址</span><br><span class="line">zookeeper.connect=hadoop102:2181,hadoop103:2181,hadoop104:2181/kafka</span><br></pre></td></tr></table></figure>

<h3 id="3、添加环境变量"><a href="#3、添加环境变量" class="headerlink" title="3、添加环境变量"></a>3、添加环境变量</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 module]$ sudo vim /etc/profile.d/my_env.sh</span><br><span class="line"></span><br><span class="line">#KAFKA_HOME</span><br><span class="line">export KAFKA_HOME=/opt/module/kafka</span><br><span class="line">export PATH=$PATH:$KAFKA_HOME/bin</span><br><span class="line"></span><br><span class="line">[logan@hadoop102 module]$ source /etc/profile.d/my_env.sh</span><br></pre></td></tr></table></figure>

<h3 id="4、分发文件修改id"><a href="#4、分发文件修改id" class="headerlink" title="4、分发文件修改id"></a>4、分发文件修改id</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 module]$ xsync kafka/</span><br><span class="line">注意：分发之后记得配置其他机器的环境变量</span><br></pre></td></tr></table></figure>

<p>分别在hadoop103和hadoop104上修改配置文件/opt/module/kafka/config/server.properties中的broker.id=1、broker.id=2</p>
<h3 id="5、启动-amp-关闭kafka"><a href="#5、启动-amp-关闭kafka" class="headerlink" title="5、启动&amp;关闭kafka"></a>5、启动&amp;关闭kafka</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 kafka]$ bin/kafka-server-start.sh -daemon /opt/module/kafka/config/server.properties</span><br><span class="line"></span><br><span class="line">[logan@hadoop102 kafka]$ bin/kafka-server-stop.sh</span><br></pre></td></tr></table></figure>

<h3 id="6、常用命令"><a href="#6、常用命令" class="headerlink" title="6、常用命令"></a>6、常用命令</h3><p>1）查看Kafka Topic列表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 kafka]$ bin/kafka-topics.sh --zookeeper hadoop102:2181/kafka --list</span><br></pre></td></tr></table></figure>

<p>2）创建Kafka Topic</p>
<p>进入到/opt/module/kafka/目录下创建日志主题</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 kafka]$ bin/kafka-topics.sh --zookeeper hadoop102:2181,hadoop103:2181,hadoop104:2181/kafka  --create --replication-factor 1 --partitions 1 --topic topic_log</span><br></pre></td></tr></table></figure>

<p>3）删除Kafka Topic</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 kafka]$ bin/kafka-topics.sh --delete --zookeeper hadoop102:2181,hadoop103:2181,hadoop104:2181/kafka --topic topic_log</span><br></pre></td></tr></table></figure>

<p>4）Kafka生产消息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 kafka]$ bin/kafka-console-producer.sh \</span><br><span class="line">--broker-list hadoop102:9092 --topic topic_log</span><br><span class="line"></span><br><span class="line">&gt;hello world</span><br><span class="line">&gt;logan  logan</span><br></pre></td></tr></table></figure>

<p>5）Kafka消费消息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 kafka]$ bin/kafka-console-consumer.sh \</span><br><span class="line">--bootstrap-server hadoop102:9092 --from-beginning --topic topic_log</span><br></pre></td></tr></table></figure>

<p>–from-beginning：会把主题中以往所有的数据都读取出来。根据业务场景选择是否增加该配置。</p>
<p>6）查看Kafka Topic详情</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 kafka]$ bin/kafka-topics.sh --zookeeper hadoop102:2181/kafka \</span><br><span class="line">--describe --topic topic_log</span><br></pre></td></tr></table></figure>

<h2 id="六、安装flume"><a href="#六、安装flume" class="headerlink" title="六、安装flume"></a>六、安装flume</h2><p>解压apache-flume-1.9.0-bin.tar.gz到/opt/module/目录下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ tar -zxf /opt/software/apache-flume-1.9.0-bin.tar.gz -C /opt/module/</span><br></pre></td></tr></table></figure>

<p>修改apache-flume-1.9.0-bin的名称为flume</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 module]$ mv /opt/module/apache-flume-1.9.0-bin /opt/module/flume</span><br></pre></td></tr></table></figure>

<p>将lib文件夹下的guava-11.0.2.jar删除以兼容Hadoop 3.1.3</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 module]$ rm /opt/module/flume/lib/guava-11.0.2.jar</span><br></pre></td></tr></table></figure>



<h2 id="七、采集flume的使用"><a href="#七、采集flume的使用" class="headerlink" title="七、采集flume的使用"></a>七、采集flume的使用</h2><p>在/opt/module/flume/job目录下创建file-flume-kafka.conf文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 job]$ vim file-flume-kafka.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#为各组件命名</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line">#描述source</span><br><span class="line">a1.sources.r1.type = TAILDIR</span><br><span class="line">a1.sources.r1.filegroups = f1</span><br><span class="line">a1.sources.r1.filegroups.f1 = /opt/module/applog/log/app.*</span><br><span class="line">a1.sources.r1.positionFile = /opt/module/flume/taildir_position.json</span><br><span class="line">a1.sources.r1.interceptors =  i1</span><br><span class="line">a1.sources.r1.interceptors.i1.type = com.logan.flume.interceptor.ETLInterceptor$Builder</span><br><span class="line"></span><br><span class="line">#描述channel</span><br><span class="line">a1.channels.c1.type = org.apache.flume.channel.kafka.KafkaChannel</span><br><span class="line">a1.channels.c1.kafka.bootstrap.servers = hadoop102:9092,hadoop103:9092</span><br><span class="line">a1.channels.c1.kafka.topic = topic_log</span><br><span class="line">a1.channels.c1.parseAsFlumeEvent = false</span><br><span class="line"></span><br><span class="line">#绑定source和channel以及sink和channel的关系</span><br><span class="line">a1.sources.r1.channels = c1</span><br></pre></td></tr></table></figure>

<p>使用的拦截器：<br>依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flume<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flume-ng-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.62<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>JSONUtils</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.logan.flume.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JSONUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isJSONValidate</span><span class="params">(String log)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JSON.parse(log);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (JSONException e)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ETLInterceptor</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.logan.flume.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.Event;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.interceptor.Interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ETLInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Event <span class="title">intercept</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] body = event.getBody();</span><br><span class="line">        String log = <span class="keyword">new</span> String(body, StandardCharsets.UTF_8);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (JSONUtils.isJSONValidate(log)) &#123;</span><br><span class="line">            <span class="keyword">return</span> event;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Event&gt; <span class="title">intercept</span><span class="params">(List&lt;Event&gt; list)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Iterator&lt;Event&gt; iterator = list.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">            Event next = iterator.next();</span><br><span class="line">            <span class="keyword">if</span>(intercept(next)==<span class="keyword">null</span>)&#123;</span><br><span class="line">                iterator.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> <span class="keyword">implements</span> <span class="title">Interceptor</span>.<span class="title">Builder</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Interceptor <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ETLInterceptor();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="八、消费flume的使用"><a href="#八、消费flume的使用" class="headerlink" title="八、消费flume的使用"></a>八、消费flume的使用</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop104 job]$ vim kafka-flume-hdfs.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">## 组件</span><br><span class="line">a1.sources=r1</span><br><span class="line">a1.channels=c1</span><br><span class="line">a1.sinks=k1</span><br><span class="line"></span><br><span class="line">## source1</span><br><span class="line">a1.sources.r1.type = org.apache.flume.source.kafka.KafkaSource</span><br><span class="line">a1.sources.r1.batchSize = 5000</span><br><span class="line">a1.sources.r1.batchDurationMillis = 2000</span><br><span class="line">a1.sources.r1.kafka.bootstrap.servers = hadoop102:9092,hadoop103:9092,hadoop104:9092</span><br><span class="line">a1.sources.r1.kafka.topics=topic_log</span><br><span class="line">a1.sources.r1.interceptors = i1</span><br><span class="line">a1.sources.r1.interceptors.i1.type = com.logan.flume.interceptor.TimeStampInterceptor$Builder</span><br><span class="line"></span><br><span class="line">## channel1</span><br><span class="line">a1.channels.c1.type = file</span><br><span class="line">a1.channels.c1.checkpointDir = /opt/module/flume/checkpoint/behavior1</span><br><span class="line">a1.channels.c1.dataDirs = /opt/module/flume/data/behavior1/</span><br><span class="line">a1.channels.c1.maxFileSize = 2146435071</span><br><span class="line">a1.channels.c1.capacity = 1000000</span><br><span class="line">a1.channels.c1.keep-alive = 6</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## sink1</span><br><span class="line">a1.sinks.k1.type = hdfs</span><br><span class="line">a1.sinks.k1.hdfs.path = /origin_data/gmall/log/topic_log/%Y-%m-%d</span><br><span class="line">a1.sinks.k1.hdfs.filePrefix = log-</span><br><span class="line">a1.sinks.k1.hdfs.round = false</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a1.sinks.k1.hdfs.rollInterval = 10</span><br><span class="line">a1.sinks.k1.hdfs.rollSize = 134217728</span><br><span class="line">a1.sinks.k1.hdfs.rollCount = 0</span><br><span class="line"></span><br><span class="line">## 控制输出文件是原生文件。</span><br><span class="line">a1.sinks.k1.hdfs.fileType = CompressedStream</span><br><span class="line">a1.sinks.k1.hdfs.codeC = lzop</span><br><span class="line"></span><br><span class="line">## 拼装</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sinks.k1.channel= c1</span><br></pre></td></tr></table></figure>

<p>拦截器：TimeStampInterceptor</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.logan.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.Event;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.interceptor.Interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeStampInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Event <span class="title">intercept</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; headers = event.getHeaders();</span><br><span class="line">        String log = <span class="keyword">new</span> String(event.getBody(), StandardCharsets.UTF_8);</span><br><span class="line"></span><br><span class="line">        JSONObject jsonObject = JSONObject.parseObject(log);</span><br><span class="line"></span><br><span class="line">        String ts = jsonObject.getString(<span class="string">&quot;ts&quot;</span>);</span><br><span class="line">        headers.put(<span class="string">&quot;timestamp&quot;</span>, ts);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> event;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Event&gt; <span class="title">intercept</span><span class="params">(List&lt;Event&gt; list)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Event event : list) &#123;</span><br><span class="line">            intercept(event);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> <span class="keyword">implements</span> <span class="title">Interceptor</span>.<span class="title">Builder</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Interceptor <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> TimeStampInterceptor();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="九、安装MySql"><a href="#九、安装MySql" class="headerlink" title="九、安装MySql"></a>九、安装MySql</h2><h3 id="1、安装"><a href="#1、安装" class="headerlink" title="1、安装"></a>1、安装</h3><p>卸载自带的Mysql-libs（如果之前安装过mysql，要全都卸载掉）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ rpm -qa | grep -i -E mysql\|mariadb | xargs -n1 sudo rpm -e --nodeps</span><br></pre></td></tr></table></figure>

<p>安装mysql依赖</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ sudo rpm -ivh 01_mysql-community-common-5.7.16-1.el7.x86_64.rpm</span><br><span class="line">[logan@hadoop102 software]$ sudo rpm -ivh 02_mysql-community-libs-5.7.16-1.el7.x86_64.rpm</span><br><span class="line">[logan@hadoop102 software]$ sudo rpm -ivh 03_mysql-community-libs-compat-5.7.16-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>安装mysql-client</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ sudo rpm -ivh 04_mysql-community-client-5.7.16-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>安装mysql-server</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ sudo rpm -ivh 05_mysql-community-server-5.7.16-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>启动mysql</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ sudo systemctl start mysqld</span><br></pre></td></tr></table></figure>

<p>查看mysql密码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ sudo cat /var/log/mysqld.log | grep password</span><br></pre></td></tr></table></figure>

<h3 id="2、配置"><a href="#2、配置" class="headerlink" title="2、配置"></a>2、配置</h3><p>1）用刚刚查到的密码进入mysql（如果报错，给密码加单引号）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ mysql -uroot -p&#x27;password&#x27;</span><br></pre></td></tr></table></figure>

<p>2）设置复杂密码(由于mysql密码策略，此密码必须足够复杂)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; set password=password(&quot;Qs23=zs32&quot;);</span><br></pre></td></tr></table></figure>

<p>3）更改mysql密码策略</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; set global validate_password_length=4;</span><br><span class="line">mysql&gt; set global validate_password_policy=0;</span><br></pre></td></tr></table></figure>

<p>4）设置简单好记的密码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; set password=password(&quot;123456&quot;);</span><br></pre></td></tr></table></figure>

<p>5）进入msyql库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; use mysql</span><br></pre></td></tr></table></figure>

<p>6）查询user表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; select user, host from user;</span><br></pre></td></tr></table></figure>

<p>7）修改user表，把Host表内容修改为%</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; update user set host=&quot;%&quot; where user=&quot;root&quot;;</span><br></pre></td></tr></table></figure>

<p>8）刷新</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure>

<p>9）退出</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; quit;</span><br></pre></td></tr></table></figure>

<h2 id="十、安装sqoop"><a href="#十、安装sqoop" class="headerlink" title="十、安装sqoop"></a>十、安装sqoop</h2><p>解压sqoop安装包到指定目录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ tar -zxf sqoop-1.4.6.bin__hadoop-2.0.4-alpha.tar.gz -C /opt/module/</span><br></pre></td></tr></table></figure>

<p>修改解压内容的名称</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 module]$ mv sqoop-1.4.6.bin__hadoop-2.0.4-alpha/ sqoop</span><br></pre></td></tr></table></figure>

<p>进入到/opt/module/sqoop/conf目录，重命名配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 conf]$ mv sqoop-env-template.sh sqoop-env.sh</span><br></pre></td></tr></table></figure>

<p>修改配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 conf]$ vim sqoop-env.sh</span><br></pre></td></tr></table></figure>

<p>增加如下内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export HADOOP_COMMON_HOME=/opt/module/hadoop-3.1.3</span><br><span class="line">export HADOOP_MAPRED_HOME=/opt/module/hadoop-3.1.3</span><br><span class="line">export HIVE_HOME=/opt/module/hive</span><br><span class="line">export ZOOKEEPER_HOME=/opt/module/zookeeper-3.5.7</span><br><span class="line">export ZOOCFGDIR=/opt/module/zookeeper-3.5.7/conf</span><br></pre></td></tr></table></figure>

<p>拷贝JDBC驱动</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ cp mysql-connector-java-5.1.27-bin.jar /opt/module/sqoop/lib/</span><br></pre></td></tr></table></figure>

<h2 id="十一、安装hive"><a href="#十一、安装hive" class="headerlink" title="十一、安装hive"></a>十一、安装hive</h2><h3 id="1、安装-1"><a href="#1、安装-1" class="headerlink" title="1、安装"></a>1、安装</h3><p>解压apache-hive-3.1.2-bin.tar.gz到/opt/module/目录下面</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ tar -zxvf /opt/software/apache-hive-3.1.2-bin.tar.gz -C /opt/module/</span><br></pre></td></tr></table></figure>

<p>修改apache-hive-3.1.2-bin.tar.gz的名称为hive</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ mv /opt/module/apache-hive-3.1.2-bin/ /opt/module/hive</span><br></pre></td></tr></table></figure>

<p>修改/etc/profile.d/my_env.sh，添加环境变量</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ sudo vim /etc/profile.d/my_env.sh</span><br></pre></td></tr></table></figure>

<p>添加内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#HIVE_HOME</span><br><span class="line">export HIVE_HOME=/opt/module/hive</span><br><span class="line">export PATH=$PATH:$HIVE_HOME/bin</span><br></pre></td></tr></table></figure>

<p>使环境变量生效</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 software]$ source /etc/profile.d/my_env.sh</span><br></pre></td></tr></table></figure>

<p>解决日志Jar包冲突，进入/opt/module/hive/lib目录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 lib]$ mv log4j-slf4j-impl-2.10.0.jar log4j-slf4j-impl-2.10.0.jar.bak</span><br></pre></td></tr></table></figure>

<h3 id="2、配置-1"><a href="#2、配置-1" class="headerlink" title="2、配置"></a>2、配置</h3><p>在$HIVE_HOME/conf目录下新建hive-site.xml文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 conf]$ vim hive-site.xml`</span><br></pre></td></tr></table></figure>

<p>添加如下内容</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>jdbc:mysql://hadoop102:3306/metastore?useSSL=false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionDriverName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionUserName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionPassword<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.warehouse.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/user/hive/warehouse<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.schema.verification<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.server2.thrift.port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>10000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.server2.thrift.bind.host<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop102<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.event.db.notification.api.auth<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.cli.print.header<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.cli.print.current.db<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3、初始化元数据库"><a href="#3、初始化元数据库" class="headerlink" title="3、初始化元数据库"></a>3、初始化元数据库</h3><p>1）登陆MySQL</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 conf]$ mysql -uroot -p123456</span><br></pre></td></tr></table></figure>

<p>2）新建Hive元数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; create database metastore;</span><br><span class="line">mysql&gt; quit;</span><br></pre></td></tr></table></figure>

<p>3）初始化Hive元数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[logan@hadoop102 conf]$ schematool -initSchema -dbType mysql -verbose</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>BigData</category>
        <category>数仓</category>
        <category>数仓采集平台搭建步骤</category>
      </categories>
      <tags>
        <tag>数仓</tag>
      </tags>
  </entry>
</search>
