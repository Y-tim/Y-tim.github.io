<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>Hive中sql练习 |  Y-tim</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css"
      />
      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
       
 
<script>
var _hmt = _hmt || [];
(function() {
	var hm = document.createElement("script");
	hm.src = "https://hm.baidu.com/hm.js?XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX";
	var s = document.getElementsByTagName("script")[0]; 
	s.parentNode.insertBefore(hm, s);
})();
</script>


      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      
      <canvas width="1777" height="841"
        style="position: fixed; left: 0px; top: 0px; z-index: 99999; pointer-events: none;"></canvas>
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-HIve中sql练习"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Hive中sql练习
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2021/12/22/HIve%E4%B8%ADsql%E7%BB%83%E4%B9%A0/" class="article-date">
  <time datetime="2021-12-22T02:27:51.046Z" itemprop="datePublished">2021-12-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/BigData/">BigData</a> / <a class="article-category-link" href="/categories/BigData/HQL%E7%BB%83%E4%B9%A0/">HQL练习</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">6.7k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">34 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="一、行列转换"><a href="#一、行列转换" class="headerlink" title="一、行列转换"></a>一、行列转换</h2><p>描述：表中记录了各年份各部门的平均绩效考核成绩。</p>
<p>表名：t1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">表结构：</span><br><span class="line">a -- 年份</span><br><span class="line">b -- 部门</span><br><span class="line">c -- 绩效得分</span><br></pre></td></tr></table></figure>



<p>表内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> a  b c</span><br><span class="line">2014 B 9</span><br><span class="line">2015 A 8</span><br><span class="line">2014 A 10</span><br><span class="line">2015 B 7</span><br></pre></td></tr></table></figure>



<h4 id="问题一：多行转多列"><a href="#问题一：多行转多列" class="headerlink" title="问题一：多行转多列"></a>问题一：多行转多列</h4><p>问题描述：将上述表内容转为如下输出结果所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a col_A col_B</span><br><span class="line">2014 10  9</span><br><span class="line">2015 8  7</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">  a,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> <span class="keyword">when</span> b<span class="operator">=</span>&quot;A&quot; <span class="keyword">then</span> c <span class="keyword">end</span>) col_A,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> <span class="keyword">when</span> b<span class="operator">=</span>&quot;B&quot; <span class="keyword">then</span> c <span class="keyword">end</span>) col_B</span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a;</span><br></pre></td></tr></table></figure>



<h4 id="问题二：如何将结果转成源表？（多列转多行）"><a href="#问题二：如何将结果转成源表？（多列转多行）" class="headerlink" title="问题二：如何将结果转成源表？（多列转多行）"></a>问题二：如何将结果转成源表？（多列转多行）</h4><p>问题描述：将问题一的结果转成源表，问题一结果表名为t1_2。</p>
<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">  a,</span><br><span class="line">  b,</span><br><span class="line">  c</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">  <span class="keyword">select</span> a,&quot;A&quot; <span class="keyword">as</span> b,col_a <span class="keyword">as</span> c <span class="keyword">from</span> t1_2 </span><br><span class="line">  <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">  <span class="keyword">select</span> a,&quot;B&quot; <span class="keyword">as</span> b,col_b <span class="keyword">as</span> c <span class="keyword">from</span> t1_2 </span><br><span class="line">)tmp; </span><br></pre></td></tr></table></figure>



<h4 id="问题三：同一部门会有多个绩效，求多行转多列结果"><a href="#问题三：同一部门会有多个绩效，求多行转多列结果" class="headerlink" title="问题三：同一部门会有多个绩效，求多行转多列结果"></a>问题三：同一部门会有多个绩效，求多行转多列结果</h4><p>问题描述：2014年公司组织架构调整，导致部门出现多个绩效，业务及人员不同，无法合并算绩效，源表内容如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2014</span> B <span class="number">9</span></span><br><span class="line"><span class="number">2015</span> A <span class="number">8</span></span><br><span class="line"><span class="number">2014</span> A <span class="number">10</span></span><br><span class="line"><span class="number">2015</span> B <span class="number">7</span></span><br><span class="line"><span class="number">2014</span> B <span class="number">6</span></span><br></pre></td></tr></table></figure>



<p>输出结果如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> a  col_A col_B</span><br><span class="line"><span class="number">2014</span>  <span class="number">10</span>  <span class="number">6</span>,<span class="number">9</span></span><br><span class="line"><span class="number">2015</span>  <span class="number">8</span>   <span class="number">7</span></span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a,</span><br><span class="line">       <span class="built_in">max</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> b<span class="operator">=</span>&quot;A&quot; <span class="keyword">THEN</span> c <span class="keyword">END</span>) col_A,</span><br><span class="line">       <span class="built_in">max</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> b<span class="operator">=</span>&quot;B&quot; <span class="keyword">THEN</span> c <span class="keyword">END</span>) col_B</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">  ( <span class="keyword">SELECT</span> a,</span><br><span class="line">           b,</span><br><span class="line">           concat_ws(&quot;,&quot;,collect_set(<span class="built_in">cast</span>(c <span class="keyword">AS</span> string))) <span class="keyword">AS</span> c</span><br><span class="line">   <span class="keyword">FROM</span> t1</span><br><span class="line">   <span class="keyword">GROUP</span> <span class="keyword">BY</span> a,</span><br><span class="line">            b)tmp</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a;</span><br></pre></td></tr></table></figure>



<h2 id="二、排名中取他值"><a href="#二、排名中取他值" class="headerlink" title="二、排名中取他值"></a>二、排名中取他值</h2><p>表名：t2</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a  b  c</span><br><span class="line">2014 A 3</span><br><span class="line">2014 B  1</span><br><span class="line">2014 C  2</span><br><span class="line">2015 A  4</span><br><span class="line">2015 D  3</span><br></pre></td></tr></table></figure>



<h4 id="问题一：按a分组取b字段最小时对应的c字段"><a href="#问题一：按a分组取b字段最小时对应的c字段" class="headerlink" title="问题一：按a分组取b字段最小时对应的c字段"></a>问题一：按a分组取b字段最小时对应的c字段</h4><p>输出结果如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a  min_c</span><br><span class="line"><span class="number">2014</span> <span class="number">3</span></span><br><span class="line"><span class="number">2015</span> <span class="number">4</span></span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">select a,</span><br><span class="line">		c as min_cfrom(  </span><br><span class="line">            select  a,  </span><br><span class="line">            		b,  </span><br><span class="line">            		c,   </span><br><span class="line">            		row_number() over(partition by a order by b) as rn </span><br><span class="line">            from t2 )a </span><br><span class="line">where rn = 1;</span><br></pre></td></tr></table></figure>



<h4 id="问题二：按a分组取b字段排第二时对应的c字段"><a href="#问题二：按a分组取b字段排第二时对应的c字段" class="headerlink" title="问题二：按a分组取b字段排第二时对应的c字段"></a>问题二：按a分组取b字段排第二时对应的c字段</h4><p>输出结果如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a second_c</span><br><span class="line"><span class="number">2014</span> <span class="number">1</span></span><br><span class="line"><span class="number">2015</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a, c <span class="keyword">AS</span> second_c</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, b, c, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> b) <span class="keyword">AS</span> rn</span><br><span class="line">	<span class="keyword">FROM</span> t2</span><br><span class="line">) a</span><br><span class="line"><span class="keyword">WHERE</span> rn <span class="operator">=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>



<h4 id="问题三：按a分组取b字段最小和最大时对应的c字段"><a href="#问题三：按a分组取b字段最小和最大时对应的c字段" class="headerlink" title="问题三：按a分组取b字段最小和最大时对应的c字段"></a>问题三：按a分组取b字段最小和最大时对应的c字段</h4><p>输出结果如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a  min_c max_c</span><br><span class="line"><span class="number">2014</span> <span class="number">3</span>   <span class="number">2</span></span><br><span class="line"><span class="number">2015</span> <span class="number">4</span>   <span class="number">3</span></span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a ,</span><br><span class="line">       <span class="built_in">min</span>(if(asc_rn <span class="operator">=</span> <span class="number">1</span>, c, <span class="keyword">NULL</span>)) <span class="keyword">AS</span> min_c ,</span><br><span class="line">       <span class="built_in">max</span>(if(desc_rn <span class="operator">=</span> <span class="number">1</span>, c, <span class="keyword">NULL</span>)) <span class="keyword">AS</span> max_c</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    ( <span class="keyword">SELECT</span> a,</span><br><span class="line">             b,</span><br><span class="line">             c,</span><br><span class="line">             <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a</span><br><span class="line">                                <span class="keyword">ORDER</span> <span class="keyword">BY</span> b) <span class="keyword">AS</span> asc_rn ,</span><br><span class="line">             <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a</span><br><span class="line">                                <span class="keyword">ORDER</span> <span class="keyword">BY</span> b <span class="keyword">DESC</span>) <span class="keyword">AS</span> desc_rn</span><br><span class="line">     <span class="keyword">FROM</span> t2) a</span><br><span class="line"><span class="keyword">WHERE</span> asc_rn <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">OR</span> desc_rn <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a;</span><br></pre></td></tr></table></figure>



<h4 id="问题四：按a分组取b字段第二小和第二大时对应的c字段"><a href="#问题四：按a分组取b字段第二小和第二大时对应的c字段" class="headerlink" title="问题四：按a分组取b字段第二小和第二大时对应的c字段"></a>问题四：按a分组取b字段第二小和第二大时对应的c字段</h4><p>输出结果如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a  min_c max_c</span><br><span class="line"><span class="number">2014</span> <span class="number">1</span>   <span class="number">1</span></span><br><span class="line"><span class="number">2015</span> <span class="number">3</span>   <span class="number">4</span></span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ret.a ,</span><br><span class="line">       <span class="built_in">max</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> ret.rn_min <span class="operator">=</span> <span class="number">2</span> <span class="keyword">THEN</span> ret.c <span class="keyword">ELSE</span> <span class="keyword">NULL</span> <span class="keyword">END</span>) <span class="keyword">AS</span> min_c ,</span><br><span class="line">       <span class="built_in">max</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> ret.rn_max <span class="operator">=</span> <span class="number">2</span> <span class="keyword">THEN</span> ret.c <span class="keyword">ELSE</span> <span class="keyword">NULL</span> <span class="keyword">END</span>) <span class="keyword">AS</span> max_c</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span> <span class="operator">*</span>,</span><br><span class="line">            <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> t2.a</span><br><span class="line">                               <span class="keyword">ORDER</span> <span class="keyword">BY</span> t2.b) <span class="keyword">AS</span> rn_min,</span><br><span class="line">            <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> t2.a</span><br><span class="line">                               <span class="keyword">ORDER</span> <span class="keyword">BY</span> t2.b <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn_max</span><br><span class="line">     <span class="keyword">FROM</span> t2) ret</span><br><span class="line"><span class="keyword">WHERE</span> ret.rn_min <span class="operator">=</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">OR</span> ret.rn_max <span class="operator">=</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> ret.a;</span><br></pre></td></tr></table></figure>



<h4 id="问题五：按a分组取b字段前两小和前两大时对应的c字段"><a href="#问题五：按a分组取b字段前两小和前两大时对应的c字段" class="headerlink" title="问题五：按a分组取b字段前两小和前两大时对应的c字段"></a>问题五：按a分组取b字段前两小和前两大时对应的c字段</h4><p>注意：需保持b字段最小、最大排首位</p>
<p>输出结果如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a  min_c max_c</span><br><span class="line"><span class="number">2014</span> <span class="number">3</span>,<span class="number">1</span>   <span class="number">2</span>,<span class="number">1</span></span><br><span class="line"><span class="number">2015</span> <span class="number">4</span>,<span class="number">3</span>   <span class="number">3</span>,<span class="number">4</span></span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> tmp1.a <span class="keyword">AS</span> a,</span><br><span class="line">       min_c,</span><br><span class="line">       max_c</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    ( <span class="keyword">SELECT</span> a,</span><br><span class="line">             concat_ws(<span class="string">&#x27;,&#x27;</span>, collect_list(c)) <span class="keyword">AS</span> min_c</span><br><span class="line">     <span class="keyword">FROM</span></span><br><span class="line">         ( <span class="keyword">SELECT</span> a,</span><br><span class="line">                  b,</span><br><span class="line">                  c,</span><br><span class="line">                  <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a</span><br><span class="line">                                     <span class="keyword">ORDER</span> <span class="keyword">BY</span> b) <span class="keyword">AS</span> asc_rn</span><br><span class="line">          <span class="keyword">FROM</span> t2 ) a</span><br><span class="line">     <span class="keyword">WHERE</span> asc_rn <span class="operator">&lt;=</span> <span class="number">2</span></span><br><span class="line">     <span class="keyword">GROUP</span> <span class="keyword">BY</span> a) tmp1</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">    ( <span class="keyword">SELECT</span> a,</span><br><span class="line">             concat_ws(<span class="string">&#x27;,&#x27;</span>, collect_list(c)) <span class="keyword">AS</span> max_c</span><br><span class="line">     <span class="keyword">FROM</span></span><br><span class="line">         ( <span class="keyword">SELECT</span> a,</span><br><span class="line">                  b,</span><br><span class="line">                  c,</span><br><span class="line">                  <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a</span><br><span class="line">                                     <span class="keyword">ORDER</span> <span class="keyword">BY</span> b <span class="keyword">DESC</span>) <span class="keyword">AS</span> desc_rn</span><br><span class="line">          <span class="keyword">FROM</span> t2 ) a</span><br><span class="line">     <span class="keyword">WHERE</span> desc_rn <span class="operator">&lt;=</span> <span class="number">2</span></span><br><span class="line">     <span class="keyword">GROUP</span> <span class="keyword">BY</span> a ) tmp2 <span class="keyword">ON</span> tmp1.a <span class="operator">=</span> tmp2.a;</span><br></pre></td></tr></table></figure>



<h2 id="三、累计求值"><a href="#三、累计求值" class="headerlink" title="三、累计求值"></a>三、累计求值</h2><p>表名：t3</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a  b  c</span><br><span class="line">2014 A  3</span><br><span class="line">2014 B  1</span><br><span class="line">2014 C  2</span><br><span class="line">2015 A  4</span><br><span class="line">2015 D  3</span><br></pre></td></tr></table></figure>



<h4 id="问题一：按a分组按b字段排序，对c累计求和"><a href="#问题一：按a分组按b字段排序，对c累计求和" class="headerlink" title="问题一：按a分组按b字段排序，对c累计求和"></a>问题一：按a分组按b字段排序，对c累计求和</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a  b  sum_c</span><br><span class="line">2014 A  3</span><br><span class="line">2014 B  4</span><br><span class="line">2014 C  6</span><br><span class="line">2015 A  4</span><br><span class="line">2015 D  7</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT a, b, c</span><br><span class="line">	, sum(c) OVER (PARTITION BY a ORDER BY b) AS sum_c</span><br><span class="line">FROM t3;</span><br></pre></td></tr></table></figure>



<h4 id="问题二：按a分组按b字段排序，对c取累计平均值"><a href="#问题二：按a分组按b字段排序，对c取累计平均值" class="headerlink" title="问题二：按a分组按b字段排序，对c取累计平均值"></a>问题二：按a分组按b字段排序，对c取累计平均值</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a  b  avg_c</span><br><span class="line">2014 A  3</span><br><span class="line">2014 B  2</span><br><span class="line">2014 C  2</span><br><span class="line">2015 A  4</span><br><span class="line">2015 D  3.5</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT a, b, c</span><br><span class="line">	, avg(c) OVER (PARTITION BY a ORDER BY b) AS avg_c</span><br><span class="line">FROM t3;</span><br></pre></td></tr></table></figure>



<h4 id="问题三：按a分组按b字段排序，对b取累计排名比例"><a href="#问题三：按a分组按b字段排序，对b取累计排名比例" class="headerlink" title="问题三：按a分组按b字段排序，对b取累计排名比例"></a>问题三：按a分组按b字段排序，对b取累计排名比例</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a  b  ratio_c</span><br><span class="line">2014 A  0.33</span><br><span class="line">2014 B  0.67</span><br><span class="line">2014 C  1.00</span><br><span class="line">2015 A  0.50</span><br><span class="line">2015 D  1.00</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT a, b, c</span><br><span class="line">	, round(row_number() OVER (PARTITION BY a ORDER BY b) / count(c) OVER (PARTITION BY a ), 2) AS ratio_c</span><br><span class="line">FROM t3</span><br><span class="line">ORDER BY a, b;</span><br></pre></td></tr></table></figure>



<h4 id="问题四：按a分组按b字段排序，对b取累计求和比例"><a href="#问题四：按a分组按b字段排序，对b取累计求和比例" class="headerlink" title="问题四：按a分组按b字段排序，对b取累计求和比例"></a>问题四：按a分组按b字段排序，对b取累计求和比例</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a  b  ratio_c</span><br><span class="line">2014 A  0.50</span><br><span class="line">2014 B  0.67</span><br><span class="line">2014 C  1.00</span><br><span class="line">2015 A  0.57</span><br><span class="line">2015 D  1.00</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT a, b, c</span><br><span class="line">	, round(sum(c) OVER (PARTITION BY a ORDER BY b) / sum(c) OVER (PARTITION BY a ), 2) AS ratio_c</span><br><span class="line">FROM t3</span><br><span class="line">ORDER BY a, b;</span><br></pre></td></tr></table></figure>



<h2 id="四、窗口大小控制"><a href="#四、窗口大小控制" class="headerlink" title="四、窗口大小控制"></a>四、窗口大小控制</h2><p>表名：t4</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a  b  c</span><br><span class="line">2014 A  3</span><br><span class="line">2014 B  1</span><br><span class="line">2014 C  2</span><br><span class="line">2015 A  4</span><br><span class="line">2015 D  3</span><br></pre></td></tr></table></figure>



<h3 id="问题一：按a分组按b字段排序，对c取前后各一行的和"><a href="#问题一：按a分组按b字段排序，对c取前后各一行的和" class="headerlink" title="问题一：按a分组按b字段排序，对c取前后各一行的和"></a>问题一：按a分组按b字段排序，对c取前后各一行的和</h3><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a  b  sum_c</span><br><span class="line">2014 A  1</span><br><span class="line">2014 B  5</span><br><span class="line">2014 C  1</span><br><span class="line">2015 A  3</span><br><span class="line">2015 D  4</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select </span><br><span class="line"> a,</span><br><span class="line"> b,</span><br><span class="line"> lag(c,1,0) over(partition by a order by b)+lead(c,1,0) over(partition by a order by b) as sum_c</span><br><span class="line">from t4;</span><br></pre></td></tr></table></figure>



<h3 id="问题二：按a分组按b字段排序，对c取平均值"><a href="#问题二：按a分组按b字段排序，对c取平均值" class="headerlink" title="问题二：按a分组按b字段排序，对c取平均值"></a>问题二：按a分组按b字段排序，对c取平均值</h3><p>问题描述：前一行与当前行的均值！</p>
<p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a  b  avg_c</span><br><span class="line">2014 A  3</span><br><span class="line">2014 B  2</span><br><span class="line">2014 C  1.5</span><br><span class="line">2015 A  4</span><br><span class="line">2015 D  3.5</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">select</span><br><span class="line"> a,</span><br><span class="line"> b,</span><br><span class="line"> case when lag_c is null then c</span><br><span class="line"> else (c+lag_c)/2 end as avg_c</span><br><span class="line">from</span><br><span class="line"> (</span><br><span class="line"> select</span><br><span class="line">  a,</span><br><span class="line"> b,</span><br><span class="line">  c,</span><br><span class="line">  lag(c,1) over(partition by a order by b) as lag_c</span><br><span class="line"> from t4</span><br><span class="line"> )temp;</span><br></pre></td></tr></table></figure>



<h2 id="五、产生连续数值"><a href="#五、产生连续数值" class="headerlink" title="五、产生连续数值"></a>五、产生连续数值</h2><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">...</span><br><span class="line">100</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<p>不借助其他任何外表，实现产生连续数值</p>
<p>此处给出两种解法，其一：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id_start <span class="operator">+</span> pos <span class="keyword">AS</span> id</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">AS</span> id_start, <span class="number">1000000</span> <span class="keyword">AS</span> id_end</span><br><span class="line">) m</span><br><span class="line">	<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> posexplode(split(space(id_end <span class="operator">-</span> id_start), <span class="string">&#x27;&#x27;</span>)) t <span class="keyword">AS</span> pos, val</span><br></pre></td></tr></table></figure>



<p>其二：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">row_number</span>() <span class="keyword">OVER</span> () <span class="keyword">AS</span> id</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> split(space(<span class="number">99</span>), <span class="string">&#x27; &#x27;</span>) <span class="keyword">AS</span> x</span><br><span class="line">) t</span><br><span class="line">	<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> explode(x) ex;</span><br></pre></td></tr></table></figure>



<p>那如何产生1至1000000连续数值？</p>
<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT row_number() OVER () AS id</span><br><span class="line">FROM (</span><br><span class="line">	SELECT split(space(999999), &#x27; &#x27;) AS x</span><br><span class="line">) t</span><br><span class="line">	LATERAL VIEW explode(x) ex;</span><br></pre></td></tr></table></figure>



<h2 id="六、数据扩充与收缩"><a href="#六、数据扩充与收缩" class="headerlink" title="六、数据扩充与收缩"></a>六、数据扩充与收缩</h2><p>表名：t6</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a </span><br><span class="line">3 </span><br><span class="line">2</span><br><span class="line">4</span><br></pre></td></tr></table></figure>



<h4 id="问题一：数据扩充"><a href="#问题一：数据扩充" class="headerlink" title="问题一：数据扩充"></a>问题一：数据扩充</h4><p>输出结果如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a   b</span><br><span class="line"><span class="number">3</span>  <span class="number">3</span>、<span class="number">2</span>、<span class="number">1</span></span><br><span class="line"><span class="number">2</span>  <span class="number">2</span>、<span class="number">1</span></span><br><span class="line"><span class="number">4</span>  <span class="number">4</span>、<span class="number">3</span>、<span class="number">2</span>、<span class="number">1</span></span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"> t.a,</span><br><span class="line"> concat_ws(<span class="string">&#x27;、&#x27;</span>,collect_set(<span class="built_in">cast</span>(t.rn <span class="keyword">as</span> string))) <span class="keyword">as</span> b</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">( </span><br><span class="line"> <span class="keyword">select</span> </span><br><span class="line">  t6.a,</span><br><span class="line">  b.rn</span><br><span class="line"> <span class="keyword">from</span> t6</span><br><span class="line"> <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line"> (   <span class="keyword">select</span></span><br><span class="line">   <span class="built_in">row_number</span>() <span class="keyword">over</span>() <span class="keyword">as</span> rn</span><br><span class="line">  <span class="keyword">from</span> </span><br><span class="line">  (<span class="keyword">select</span> split(space(<span class="number">5</span>), <span class="string">&#x27; &#x27;</span>) <span class="keyword">as</span> x) t <span class="comment">-- space(5)可根据t6表的最大值灵活调整</span></span><br><span class="line">  <span class="keyword">lateral</span> <span class="keyword">view</span></span><br><span class="line">  explode(x) pe</span><br><span class="line"> ) b</span><br><span class="line"> <span class="keyword">on</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"> <span class="keyword">where</span> t6.a <span class="operator">&gt;=</span> b.rn</span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> t6.a, b.rn <span class="keyword">desc</span> </span><br><span class="line">) t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> t.a;</span><br></pre></td></tr></table></figure>



<h4 id="问题二：数据扩充，排除偶数"><a href="#问题二：数据扩充，排除偶数" class="headerlink" title="问题二：数据扩充，排除偶数"></a>问题二：数据扩充，排除偶数</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a   b</span><br><span class="line">3  3、1</span><br><span class="line">2  1</span><br><span class="line">4  3、1</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">select </span><br><span class="line"> t.a,</span><br><span class="line"> concat_ws(&#x27;、&#x27;,collect_set(cast(t.rn as string))) as b</span><br><span class="line">from</span><br><span class="line">( </span><br><span class="line"> select </span><br><span class="line">  t6.a,</span><br><span class="line">  b.rn</span><br><span class="line"> from t6</span><br><span class="line"> left join</span><br><span class="line"> ( </span><br><span class="line">  select</span><br><span class="line">   row_number() over() as rn</span><br><span class="line">  from </span><br><span class="line">  (select split(space(5), &#x27; &#x27;) as x) t</span><br><span class="line">  lateral view</span><br><span class="line">  explode(x) pe</span><br><span class="line"> ) b</span><br><span class="line"> on 1 = 1</span><br><span class="line"> where t6.a &gt;= b.rn and b.rn % 2 = 1</span><br><span class="line"> order by t6.a, b.rn desc </span><br><span class="line">) t</span><br><span class="line">group by t.a;</span><br></pre></td></tr></table></figure>



<h4 id="问题三：如何处理字符串累计拼接"><a href="#问题三：如何处理字符串累计拼接" class="headerlink" title="问题三：如何处理字符串累计拼接"></a>问题三：如何处理字符串累计拼接</h4><p>问题描述：将小于等于a字段的值聚合拼接起来</p>
<p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a   b</span><br><span class="line">3   2、3</span><br><span class="line">2   2</span><br><span class="line">4   2、3、4</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"> t.a,</span><br><span class="line"> concat_ws(<span class="string">&#x27;、&#x27;</span>,collect_set(<span class="built_in">cast</span>(t.a1 <span class="keyword">as</span> string))) <span class="keyword">as</span> b</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(   <span class="keyword">select</span> </span><br><span class="line"></span><br><span class="line">  t6.a,</span><br><span class="line">  b.a1 <span class="keyword">from</span> t6</span><br><span class="line"> <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line"> (  </span><br><span class="line">  <span class="keyword">select</span> a <span class="keyword">as</span> a1 </span><br><span class="line">  <span class="keyword">from</span> t6</span><br><span class="line"> ) b</span><br><span class="line"> <span class="keyword">on</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"> <span class="keyword">where</span> t6.a <span class="operator">&gt;=</span> b.a1</span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> t6.a, b.a1 </span><br><span class="line">) t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> t.a;</span><br></pre></td></tr></table></figure>



<h4 id="问题四：如果a字段有重复，如何实现字符串累计拼接"><a href="#问题四：如果a字段有重复，如何实现字符串累计拼接" class="headerlink" title="问题四：如果a字段有重复，如何实现字符串累计拼接"></a>问题四：如果a字段有重复，如何实现字符串累计拼接</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a   b</span><br><span class="line">2   2</span><br><span class="line">3   2、3</span><br><span class="line">3   2、3、3</span><br><span class="line">4   2、3、3、4</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"> a,</span><br><span class="line"> b</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line"> <span class="keyword">select</span> </span><br><span class="line">  t.a,</span><br><span class="line">  t.rn,</span><br><span class="line">  concat_ws(<span class="string">&#x27;、&#x27;</span>,collect_list(<span class="built_in">cast</span>(t.a1 <span class="keyword">as</span> string))) <span class="keyword">as</span> b</span><br><span class="line"> <span class="keyword">from</span></span><br><span class="line"> (  </span><br><span class="line">  <span class="keyword">select</span> </span><br><span class="line">   a.a,</span><br><span class="line">   a.rn,</span><br><span class="line">   b.a1</span><br><span class="line">  <span class="keyword">from</span></span><br><span class="line">  (</span><br><span class="line">   <span class="keyword">select</span> </span><br><span class="line">​    a,</span><br><span class="line">​    <span class="built_in">row_number</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> a ) <span class="keyword">as</span> rn </span><br><span class="line">   <span class="keyword">from</span> t6</span><br><span class="line">  ) a</span><br><span class="line">  <span class="keyword">left</span> <span class="keyword">join</span></span><br><span class="line">  (  </span><br><span class="line">   <span class="keyword">select</span> a <span class="keyword">as</span> a1,</span><br><span class="line">   <span class="built_in">row_number</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> a ) <span class="keyword">as</span> rn </span><br><span class="line">   <span class="keyword">from</span> t6</span><br><span class="line">  ) b</span><br><span class="line">  <span class="keyword">on</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">  <span class="keyword">where</span> a.a <span class="operator">&gt;=</span> b.a1 <span class="keyword">and</span> a.rn <span class="operator">&gt;=</span> b.rn </span><br><span class="line">  <span class="keyword">order</span> <span class="keyword">by</span> a.a, b.a1 </span><br><span class="line"> ) t</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> t.a,t.rn</span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> t.a,t.rn</span><br><span class="line">) tt; </span><br></pre></td></tr></table></figure>



<h4 id="问题五：数据展开"><a href="#问题五：数据展开" class="headerlink" title="问题五：数据展开"></a>问题五：数据展开</h4><p>问题描述：如何将字符串”1-5,16,11-13,9”扩展成”1,2,3,4,5,16,11,12,13,9”？注意顺序不变。</p>
<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"> concat_ws(<span class="string">&#x27;,&#x27;</span>,collect_list(<span class="built_in">cast</span>(rn <span class="keyword">as</span> string)))</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line"> <span class="keyword">select</span> </span><br><span class="line">  a.rn,</span><br><span class="line">  b.num,</span><br><span class="line">  b.pos</span><br><span class="line"> <span class="keyword">from</span></span><br><span class="line">  (</span><br><span class="line">  <span class="keyword">select</span></span><br><span class="line">   <span class="built_in">row_number</span>() <span class="keyword">over</span>() <span class="keyword">as</span> rn</span><br><span class="line">  <span class="keyword">from</span> (<span class="keyword">select</span> split(space(<span class="number">20</span>), <span class="string">&#x27; &#x27;</span>) <span class="keyword">as</span> x) t <span class="comment">-- space(20)可灵活调整</span></span><br><span class="line">  <span class="keyword">lateral</span> <span class="keyword">view</span></span><br><span class="line">  explode(x) pe</span><br><span class="line">  ) a <span class="keyword">lateral</span> <span class="keyword">view</span> <span class="keyword">outer</span> </span><br><span class="line">  posexplode(split(<span class="string">&#x27;1-5,16,11-13,9&#x27;</span>, <span class="string">&#x27;,&#x27;</span>)) b <span class="keyword">as</span> pos, num</span><br><span class="line">  <span class="keyword">where</span> a.rn <span class="keyword">between</span> <span class="built_in">cast</span>(split(num, <span class="string">&#x27;-&#x27;</span>)[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">int</span>) <span class="keyword">and</span> <span class="built_in">cast</span>(split(num, <span class="string">&#x27;-&#x27;</span>)[<span class="number">1</span>] <span class="keyword">as</span> <span class="type">int</span>) <span class="keyword">or</span> a.rn <span class="operator">=</span> num</span><br><span class="line">  <span class="keyword">order</span> <span class="keyword">by</span> pos, rn </span><br><span class="line">) t;</span><br></pre></td></tr></table></figure>



<h2 id="七、合并与拆分"><a href="#七、合并与拆分" class="headerlink" title="七、合并与拆分"></a>七、合并与拆分</h2><p>表名：t7</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a  b</span><br><span class="line">2014 A</span><br><span class="line">2014 B</span><br><span class="line">2015 B</span><br><span class="line">2015 D</span><br></pre></td></tr></table></figure>



<h4 id="问题一：合并"><a href="#问题一：合并" class="headerlink" title="问题一：合并"></a>问题一：合并</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2014 A、B</span><br><span class="line"></span><br><span class="line">2015 B、D</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line"> a,</span><br><span class="line"> concat_ws(<span class="string">&#x27;、&#x27;</span>, collect_set(t.b)) b</span><br><span class="line"><span class="keyword">from</span> t7</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a;</span><br></pre></td></tr></table></figure>



<h4 id="问题二：拆分"><a href="#问题二：拆分" class="headerlink" title="问题二：拆分"></a>问题二：拆分</h4><p>问题描述：将分组合并的结果拆分出来</p>
<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line"> t.a,</span><br><span class="line"> d</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line"> <span class="keyword">select</span></span><br><span class="line"> a,</span><br><span class="line"> concat_ws(<span class="string">&#x27;、&#x27;</span>, collect_set(t7.b)) b</span><br><span class="line"> <span class="keyword">from</span> t7</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> a</span><br><span class="line">)t</span><br><span class="line"><span class="keyword">lateral</span> <span class="keyword">view</span> </span><br><span class="line">explode(split(t.b, <span class="string">&#x27;、&#x27;</span>)) table_tmp <span class="keyword">as</span> d;</span><br></pre></td></tr></table></figure>



<h2 id="八、模拟循环操作"><a href="#八、模拟循环操作" class="headerlink" title="八、模拟循环操作"></a>八、模拟循环操作</h2><p>表名：t8</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a</span><br><span class="line">1011</span><br><span class="line">0101</span><br></pre></td></tr></table></figure>



<h5 id="问题一：如何将字符’1’的位置提取出来"><a href="#问题一：如何将字符’1’的位置提取出来" class="headerlink" title="问题一：如何将字符’1’的位置提取出来"></a>问题一：如何将字符’1’的位置提取出来</h5><p>输出结果如下所示:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1,3,4</span><br><span class="line">2,4</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a, concat_ws(<span class="string">&#x27;,&#x27;</span>, collect_list(<span class="built_in">CAST</span>(index <span class="keyword">AS</span> string))) <span class="keyword">AS</span> res</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, index <span class="operator">+</span> <span class="number">1</span> <span class="keyword">AS</span> index, chr</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> a</span><br><span class="line">			, concat_ws(<span class="string">&#x27;,&#x27;</span>, substr(a, <span class="number">1</span>, <span class="number">1</span>), substr(a, <span class="number">2</span>, <span class="number">1</span>), substr(a, <span class="number">3</span>, <span class="number">1</span>), substr(a, <span class="number">-1</span>)) <span class="keyword">AS</span> str</span><br><span class="line">		<span class="keyword">FROM</span> t8</span><br><span class="line">	) tmp1</span><br><span class="line">		<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> posexplode(split(str, <span class="string">&#x27;,&#x27;</span>)) t <span class="keyword">AS</span> index, chr</span><br><span class="line">	<span class="keyword">WHERE</span> chr <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">) tmp2</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a;</span><br></pre></td></tr></table></figure>



<h2 id="九、不使用distinct或group-by去重"><a href="#九、不使用distinct或group-by去重" class="headerlink" title="九、不使用distinct或group by去重"></a>九、不使用distinct或group by去重</h2><p>表名：t9</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a   b   c  d</span><br><span class="line">2014 2016 2014  A</span><br><span class="line">2014 2015 2015  B</span><br></pre></td></tr></table></figure>



<h4 id="问题一：不使用distinct或group-by去重"><a href="#问题一：不使用distinct或group-by去重" class="headerlink" title="问题一：不使用distinct或group by去重"></a>问题一：不使用distinct或group by去重</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2014 A</span><br><span class="line">2016 A</span><br><span class="line">2014 B</span><br><span class="line">2015 B</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> t2.year, t2.num</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> t1.year, t1.num ) <span class="keyword">AS</span> rank_1</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> a <span class="keyword">AS</span> <span class="keyword">year</span>, d <span class="keyword">AS</span> num</span><br><span class="line">		<span class="keyword">FROM</span> t9</span><br><span class="line">		<span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">		<span class="keyword">SELECT</span> b <span class="keyword">AS</span> <span class="keyword">year</span>, d <span class="keyword">AS</span> num</span><br><span class="line">		<span class="keyword">FROM</span> t9</span><br><span class="line">		<span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">		<span class="keyword">SELECT</span> c <span class="keyword">AS</span> <span class="keyword">year</span>, d <span class="keyword">AS</span> num</span><br><span class="line">		<span class="keyword">FROM</span> t9</span><br><span class="line">	) t1</span><br><span class="line">) t2</span><br><span class="line"><span class="keyword">WHERE</span> rank_1 <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> num;</span><br></pre></td></tr></table></figure>



<h2 id="十、容器–反转内容"><a href="#十、容器–反转内容" class="headerlink" title="十、容器–反转内容"></a>十、容器–反转内容</h2><p>表名：t10</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a</span><br><span class="line"></span><br><span class="line">AB,CA,BAD</span><br><span class="line"></span><br><span class="line">BD,EA</span><br></pre></td></tr></table></figure>



<h4 id="问题一：反转逗号分隔的数据：改变顺序，内容不变"><a href="#问题一：反转逗号分隔的数据：改变顺序，内容不变" class="headerlink" title="问题一：反转逗号分隔的数据：改变顺序，内容不变"></a>问题一：反转逗号分隔的数据：改变顺序，内容不变</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BAD,CA,AB</span><br><span class="line"></span><br><span class="line">EA,BD</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a</span><br><span class="line">	, concat_ws(<span class="string">&#x27;,&#x27;</span>, collect_list(reverse(str)))</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, str</span><br><span class="line">	<span class="keyword">FROM</span> t10</span><br><span class="line">		<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> explode(split(reverse(a), <span class="string">&#x27;,&#x27;</span>)) t <span class="keyword">AS</span> str</span><br><span class="line">) tmp1</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a;</span><br></pre></td></tr></table></figure>



<h4 id="问题二：反转逗号分隔的数据：改变内容，顺序不变"><a href="#问题二：反转逗号分隔的数据：改变内容，顺序不变" class="headerlink" title="问题二：反转逗号分隔的数据：改变内容，顺序不变"></a>问题二：反转逗号分隔的数据：改变内容，顺序不变</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BA,AC,DAB</span><br><span class="line"></span><br><span class="line">DB,AE</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a</span><br><span class="line">	, concat_ws(<span class="string">&#x27;,&#x27;</span>, collect_list(reverse(str)))</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, str</span><br><span class="line">	<span class="keyword">FROM</span> t10</span><br><span class="line">		<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> explode(split(a, <span class="string">&#x27;,&#x27;</span>)) t <span class="keyword">AS</span> str</span><br><span class="line">) tmp1</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a;</span><br></pre></td></tr></table></figure>



<h2 id="十一、多容器–成对提取数据"><a href="#十一、多容器–成对提取数据" class="headerlink" title="十一、多容器–成对提取数据"></a>十一、多容器–成对提取数据</h2><p>表名：t11</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a    b</span><br><span class="line"></span><br><span class="line">A/B   1/3</span><br><span class="line"></span><br><span class="line">B/C/D  4/5/2</span><br></pre></td></tr></table></figure>



<h4 id="问题一：成对提取数据，字段一一对应"><a href="#问题一：成对提取数据，字段一一对应" class="headerlink" title="问题一：成对提取数据，字段一一对应"></a>问题一：成对提取数据，字段一一对应</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a    b</span><br><span class="line"></span><br><span class="line">A    1</span><br><span class="line"></span><br><span class="line">B    3</span><br><span class="line"></span><br><span class="line">B    4</span><br><span class="line"></span><br><span class="line">C    5</span><br><span class="line"></span><br><span class="line">D    2</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a_inx, b_inx</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, b, a_id, a_inx, b_id</span><br><span class="line">		, b_inx</span><br><span class="line">	<span class="keyword">FROM</span> t11</span><br><span class="line">		<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> posexplode(split(a, <span class="string">&#x27;/&#x27;</span>)) t <span class="keyword">AS</span> a_id, a_inx</span><br><span class="line">		<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> posexplode(split(b, <span class="string">&#x27;/&#x27;</span>)) t <span class="keyword">AS</span> b_id, b_inx</span><br><span class="line">) tmp</span><br><span class="line"><span class="keyword">WHERE</span> a_id <span class="operator">=</span> b_id;</span><br></pre></td></tr></table></figure>



<h2 id="十二、多容器–转多行"><a href="#十二、多容器–转多行" class="headerlink" title="十二、多容器–转多行"></a>十二、多容器–转多行</h2><p>表名：t12</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a    b   c</span><br><span class="line"></span><br><span class="line">001   A/B   1/3/5</span><br><span class="line"></span><br><span class="line">002   B/C/D  4/5</span><br></pre></td></tr></table></figure>



<h4 id="问题一：转多行"><a href="#问题一：转多行" class="headerlink" title="问题一：转多行"></a>问题一：转多行</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">a    d    e</span><br><span class="line"></span><br><span class="line">001   type_b  A</span><br><span class="line"></span><br><span class="line">001   type_b  B</span><br><span class="line"></span><br><span class="line">001   type_c  1</span><br><span class="line"></span><br><span class="line">001   type_c  3</span><br><span class="line"></span><br><span class="line">001   type_c  5</span><br><span class="line"></span><br><span class="line">002   type_b  B</span><br><span class="line"></span><br><span class="line">002   type_b  C</span><br><span class="line"></span><br><span class="line">002   type_b  D</span><br><span class="line"></span><br><span class="line">002   type_c  4</span><br><span class="line"></span><br><span class="line">002   type_c  5</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a, d, e</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, <span class="string">&#x27;type_b&#x27;</span> <span class="keyword">AS</span> d, str <span class="keyword">AS</span> e</span><br><span class="line">	<span class="keyword">FROM</span> t12</span><br><span class="line">		<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> explode(split(b, <span class="string">&#x27;/&#x27;</span>)) t <span class="keyword">AS</span> str</span><br><span class="line">	<span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">	<span class="keyword">SELECT</span> a, <span class="string">&#x27;type_c&#x27;</span> <span class="keyword">AS</span> d, str <span class="keyword">AS</span> e</span><br><span class="line">	<span class="keyword">FROM</span> t12</span><br><span class="line">		<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> explode(split(c, <span class="string">&#x27;/&#x27;</span>)) t <span class="keyword">AS</span> str</span><br><span class="line">) tmp</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a, d;</span><br></pre></td></tr></table></figure>



<h2 id="十三、抽象分组–断点排序"><a href="#十三、抽象分组–断点排序" class="headerlink" title="十三、抽象分组–断点排序"></a>十三、抽象分组–断点排序</h2><p>表名：t13</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">a  b</span><br><span class="line"></span><br><span class="line">2014 1</span><br><span class="line"></span><br><span class="line">2015 1</span><br><span class="line"></span><br><span class="line">2016 1</span><br><span class="line"></span><br><span class="line">2017 0</span><br><span class="line"></span><br><span class="line">2018 0</span><br><span class="line"></span><br><span class="line">2019 -1</span><br><span class="line"></span><br><span class="line">2020 -1</span><br><span class="line"></span><br><span class="line">2021 -1</span><br><span class="line"></span><br><span class="line">2022 1</span><br><span class="line"></span><br><span class="line">2023 1</span><br></pre></td></tr></table></figure>



<h4 id="问题一：断点排序"><a href="#问题一：断点排序" class="headerlink" title="问题一：断点排序"></a>问题一：断点排序</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">a  b  c </span><br><span class="line"></span><br><span class="line">2014 1  1</span><br><span class="line"></span><br><span class="line">2015 1  2</span><br><span class="line"></span><br><span class="line">2016 1  3</span><br><span class="line"></span><br><span class="line">2017 0  1</span><br><span class="line"></span><br><span class="line">2018 0  2</span><br><span class="line"></span><br><span class="line">2019 -1  1</span><br><span class="line"></span><br><span class="line">2020 -1  2</span><br><span class="line"></span><br><span class="line">2021 -1  3</span><br><span class="line"></span><br><span class="line">2022 1  1</span><br><span class="line"></span><br><span class="line">2023 1  2</span><br></pre></td></tr></table></figure>





<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"> a,</span><br><span class="line"> b,</span><br><span class="line"> <span class="built_in">row_number</span>() <span class="keyword">over</span>( <span class="keyword">partition</span> <span class="keyword">by</span> b,repair_a <span class="keyword">order</span> <span class="keyword">by</span> a <span class="keyword">asc</span>) <span class="keyword">as</span> c <span class="comment">--按照b列和[b的组首]分组，排序</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line"> <span class="keyword">select</span> </span><br><span class="line">  a,</span><br><span class="line">  b,</span><br><span class="line">  a<span class="operator">-</span>b_rn <span class="keyword">as</span> repair_a <span class="comment">-- 根据b列值出现的次序,修复a列值为b首次出现的a列值,称为b的[组首]</span></span><br><span class="line"> <span class="keyword">from</span> </span><br><span class="line"> (</span><br><span class="line">  <span class="keyword">select</span> </span><br><span class="line">   a,</span><br><span class="line">   b,</span><br><span class="line">   <span class="built_in">row_number</span>() <span class="keyword">over</span>( <span class="keyword">partition</span> <span class="keyword">by</span> b <span class="keyword">order</span> <span class="keyword">by</span> a <span class="keyword">asc</span> ) <span class="keyword">as</span> b_rn <span class="comment">-- 按b列分组,按a列排序,得到b列各值出现的次序</span></span><br><span class="line">  <span class="keyword">from</span> t13 </span><br><span class="line">)tmp1</span><br><span class="line">)tmp2 <span class="comment">-- 注意，如果不同的b列值，可能出现同样的组首值，但组首值需要和a列值 一并参与分组，故并不影响排序。</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> a <span class="keyword">asc</span>; </span><br></pre></td></tr></table></figure>



<h2 id="十四、业务逻辑的分类与抽象–时效"><a href="#十四、业务逻辑的分类与抽象–时效" class="headerlink" title="十四、业务逻辑的分类与抽象–时效"></a>十四、业务逻辑的分类与抽象–时效</h2><p>日期表：d_date</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">date_id   is_work</span><br><span class="line"></span><br><span class="line">2017-04-13    1</span><br><span class="line"></span><br><span class="line">2017-04-14    1</span><br><span class="line"></span><br><span class="line">2017-04-15    0</span><br><span class="line"></span><br><span class="line">2017-04-16    0</span><br><span class="line"></span><br><span class="line">2017-04-17    1</span><br></pre></td></tr></table></figure>



<p>工作日：周一至周五09:30-18:30</p>
<p>客户申请表：t14</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a   b    c</span><br><span class="line"></span><br><span class="line">1   申请  2017-04-14 18:03:00</span><br><span class="line"></span><br><span class="line">1   通过  2017-04-17 09:43:00</span><br><span class="line"></span><br><span class="line">2   申请  2017-04-13 17:02:00</span><br><span class="line"></span><br><span class="line">2   通过  2017-04-15 09:42:00</span><br></pre></td></tr></table></figure>



<h4 id="问题一：计算上表中从申请到通过占用的工作时长"><a href="#问题一：计算上表中从申请到通过占用的工作时长" class="headerlink" title="问题一：计算上表中从申请到通过占用的工作时长"></a>问题一：计算上表中从申请到通过占用的工作时长</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a     d</span><br><span class="line"></span><br><span class="line">1    0.67h</span><br><span class="line"></span><br><span class="line">2    10.67h </span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a</span><br><span class="line">	, round(<span class="built_in">sum</span>(diff) <span class="operator">/</span> <span class="number">3600</span>, <span class="number">2</span>) <span class="keyword">AS</span> d</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> a, apply_time, pass_time, dates, rn</span><br><span class="line">		, ct, is_work</span><br><span class="line">		, <span class="keyword">CASE</span> </span><br><span class="line">			<span class="keyword">WHEN</span> is_work <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">				<span class="keyword">AND</span> rn <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">			<span class="keyword">THEN</span> unix_timestamp(concat(dates, <span class="string">&#x27; 18:30:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>) <span class="operator">-</span> unix_timestamp(apply_time, <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)</span><br><span class="line">			<span class="keyword">WHEN</span> is_work <span class="operator">=</span> <span class="number">0</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">			<span class="keyword">WHEN</span> is_work <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">				<span class="keyword">AND</span> rn <span class="operator">=</span> ct</span><br><span class="line">			<span class="keyword">THEN</span> unix_timestamp(pass_time, <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>) <span class="operator">-</span> unix_timestamp(concat(dates, <span class="string">&#x27; 09:30:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)</span><br><span class="line">			<span class="keyword">WHEN</span> is_work <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">				<span class="keyword">AND</span> rn <span class="operator">!=</span> ct</span><br><span class="line">			<span class="keyword">THEN</span> <span class="number">93600</span></span><br><span class="line">		<span class="keyword">END</span> <span class="keyword">AS</span> diff</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> a, apply_time, pass_time, time_diff, day_diff</span><br><span class="line">			, rn, ct</span><br><span class="line">			, date_add(<span class="keyword">start</span>, rn <span class="operator">-</span> <span class="number">1</span>) <span class="keyword">AS</span> dates</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> a, apply_time, pass_time, time_diff, day_diff</span><br><span class="line">				, strs, <span class="keyword">start</span>, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a ) <span class="keyword">AS</span> rn</span><br><span class="line">				, <span class="built_in">count</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a ) <span class="keyword">AS</span> ct</span><br><span class="line">			<span class="keyword">FROM</span> (</span><br><span class="line">				<span class="keyword">SELECT</span> a, apply_time, pass_time, time_diff, day_diff</span><br><span class="line">					, substr(repeat(concat(substr(apply_time, <span class="number">1</span>, <span class="number">10</span>), <span class="string">&#x27;,&#x27;</span>), day_diff <span class="operator">+</span> <span class="number">1</span>), <span class="number">1</span>, <span class="number">11</span> <span class="operator">*</span> (day_diff <span class="operator">+</span> <span class="number">1</span>) <span class="operator">-</span> <span class="number">1</span>) <span class="keyword">AS</span> strs</span><br><span class="line">				<span class="keyword">FROM</span> (</span><br><span class="line">					<span class="keyword">SELECT</span> a, apply_time, pass_time</span><br><span class="line">						, unix_timestamp(pass_time, <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>) <span class="operator">-</span> unix_timestamp(apply_time, <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>) <span class="keyword">AS</span> time_diff</span><br><span class="line">						, datediff(substr(pass_time, <span class="number">1</span>, <span class="number">10</span>), substr(apply_time, <span class="number">1</span>, <span class="number">10</span>)) <span class="keyword">AS</span> day_diff</span><br><span class="line">					<span class="keyword">FROM</span> (</span><br><span class="line">						<span class="keyword">SELECT</span> a</span><br><span class="line">							, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">								<span class="keyword">WHEN</span> b <span class="operator">=</span> <span class="string">&#x27;申请&#x27;</span> <span class="keyword">THEN</span> c</span><br><span class="line">							<span class="keyword">END</span>) <span class="keyword">AS</span> apply_time</span><br><span class="line">							, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">								<span class="keyword">WHEN</span> b <span class="operator">=</span> <span class="string">&#x27;通过&#x27;</span> <span class="keyword">THEN</span> c</span><br><span class="line">							<span class="keyword">END</span>) <span class="keyword">AS</span> pass_time</span><br><span class="line">						<span class="keyword">FROM</span> t14</span><br><span class="line">						<span class="keyword">GROUP</span> <span class="keyword">BY</span> a</span><br><span class="line">					) tmp1</span><br><span class="line">				) tmp2</span><br><span class="line">			) tmp3</span><br><span class="line">				<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> explode(split(strs, <span class="string">&#x27;,&#x27;</span>)) t <span class="keyword">AS</span> <span class="keyword">start</span></span><br><span class="line">		) tmp4</span><br><span class="line">	) tmp5</span><br><span class="line">		<span class="keyword">JOIN</span> d_date <span class="keyword">ON</span> tmp5.dates <span class="operator">=</span> d_date.date_id</span><br><span class="line">) tmp6</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a;</span><br></pre></td></tr></table></figure>



<h2 id="十五、时间序列–进度及剩余"><a href="#十五、时间序列–进度及剩余" class="headerlink" title="十五、时间序列–进度及剩余"></a>十五、时间序列–进度及剩余</h2><p>表名：t15</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">date_id   is_work</span><br><span class="line"></span><br><span class="line">2017-07-30   0</span><br><span class="line"></span><br><span class="line">2017-07-31   1</span><br><span class="line"></span><br><span class="line">2017-08-01   1</span><br><span class="line"></span><br><span class="line">2017-08-02   1</span><br><span class="line"></span><br><span class="line">2017-08-03   1</span><br><span class="line"></span><br><span class="line">2017-08-04   1</span><br><span class="line"></span><br><span class="line">2017-08-05   0</span><br><span class="line"></span><br><span class="line">2017-08-06   0</span><br><span class="line"></span><br><span class="line">2017-08-07   1</span><br></pre></td></tr></table></figure>



<h4 id="问题一：求每天的累计周工作日，剩余周工作日"><a href="#问题一：求每天的累计周工作日，剩余周工作日" class="headerlink" title="问题一：求每天的累计周工作日，剩余周工作日"></a>问题一：求每天的累计周工作日，剩余周工作日</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">date_id   week_to_work week_left_work</span><br><span class="line"></span><br><span class="line">2017-07-31   1       4</span><br><span class="line"></span><br><span class="line">2017-08-01   2       3</span><br><span class="line"></span><br><span class="line">2017-08-02   3       2</span><br><span class="line"></span><br><span class="line">2017-08-03   4       1</span><br><span class="line"></span><br><span class="line">2017-08-04   5       0</span><br><span class="line"></span><br><span class="line">2017-08-05   5       0</span><br><span class="line"></span><br><span class="line">2017-08-06   5       0</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<p>此处给出两种解法，其一：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> date_id</span><br><span class="line">	, <span class="keyword">CASE</span> date_format(date_id, <span class="string">&#x27;u&#x27;</span>)</span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="number">2</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">3</span> <span class="keyword">THEN</span> <span class="number">3</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">4</span> <span class="keyword">THEN</span> <span class="number">4</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">5</span> <span class="keyword">THEN</span> <span class="number">5</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">6</span> <span class="keyword">THEN</span> <span class="number">5</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">7</span> <span class="keyword">THEN</span> <span class="number">5</span></span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">AS</span> week_to_work</span><br><span class="line">	, <span class="keyword">CASE</span> date_format(date_id, <span class="string">&#x27;u&#x27;</span>)</span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="number">4</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="number">3</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">3</span> <span class="keyword">THEN</span> <span class="number">2</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">4</span> <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">5</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">6</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">7</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">AS</span> week_to_work</span><br><span class="line"><span class="keyword">FROM</span> t15</span><br></pre></td></tr></table></figure>



<p>其二：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> date_id, week_to_work, week_sum_work <span class="operator">-</span> week_to_work <span class="keyword">AS</span> week_left_work</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> date_id, <span class="built_in">sum</span>(is_work) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">year</span>, week <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id) <span class="keyword">AS</span> week_to_work</span><br><span class="line">		, <span class="built_in">sum</span>(is_work) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">year</span>, week ) <span class="keyword">AS</span> week_sum_work</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> date_id, is_work, <span class="keyword">year</span>(date_id) <span class="keyword">AS</span> <span class="keyword">year</span></span><br><span class="line">			, weekofyear(date_id) <span class="keyword">AS</span> week</span><br><span class="line">		<span class="keyword">FROM</span> t15</span><br><span class="line">	) ta</span><br><span class="line">) tb</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id;</span><br></pre></td></tr></table></figure>



<h2 id="十六、时间序列–构造日期"><a href="#十六、时间序列–构造日期" class="headerlink" title="十六、时间序列–构造日期"></a>十六、时间序列–构造日期</h2><h4 id="问题一：直接使用SQL实现一张日期维度表，包含以下字段："><a href="#问题一：直接使用SQL实现一张日期维度表，包含以下字段：" class="headerlink" title="问题一：直接使用SQL实现一张日期维度表，包含以下字段："></a>问题一：直接使用SQL实现一张日期维度表，包含以下字段：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">date         string        日期</span><br><span class="line"></span><br><span class="line">d_week        string        年内第几周</span><br><span class="line"></span><br><span class="line">weeks        int         周几</span><br><span class="line"></span><br><span class="line">w_start       string        周开始日</span><br><span class="line"></span><br><span class="line">w_end        string        周结束日</span><br><span class="line"></span><br><span class="line">d_month       int         第几月</span><br><span class="line"></span><br><span class="line">m_start       string        月开始日</span><br><span class="line"></span><br><span class="line">m_end        string        月结束日</span><br><span class="line"></span><br><span class="line">d_quarter      int          第几季</span><br><span class="line"></span><br><span class="line">q_start       string        季开始日</span><br><span class="line"></span><br><span class="line">q_end        string        季结束日</span><br><span class="line"></span><br><span class="line">d_year        int          年份</span><br><span class="line"></span><br><span class="line">y_start       string        年开始日</span><br><span class="line"></span><br><span class="line">y_end        string        年结束日</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dim_date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> dim_date (</span><br><span class="line">	`<span class="type">date</span>` string COMMENT <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">	d_week string COMMENT <span class="string">&#x27;年内第几周&#x27;</span>,</span><br><span class="line">	weeks string COMMENT <span class="string">&#x27;周几&#x27;</span>,</span><br><span class="line">	w_start string COMMENT <span class="string">&#x27;周开始日&#x27;</span>,</span><br><span class="line">	w_end string COMMENT <span class="string">&#x27;周结束日&#x27;</span>,</span><br><span class="line">	d_month string COMMENT <span class="string">&#x27;第几月&#x27;</span>,</span><br><span class="line">	m_start string COMMENT <span class="string">&#x27;月开始日&#x27;</span>,</span><br><span class="line">	m_end string COMMENT <span class="string">&#x27;月结束日&#x27;</span>,</span><br><span class="line">	d_quarter <span class="type">int</span> COMMENT <span class="string">&#x27;第几季&#x27;</span>,</span><br><span class="line">	q_start string COMMENT <span class="string">&#x27;季开始日&#x27;</span>,</span><br><span class="line">	q_end string COMMENT <span class="string">&#x27;季结束日&#x27;</span>,</span><br><span class="line">	d_year <span class="type">int</span> COMMENT <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">	y_start string COMMENT <span class="string">&#x27;年开始日&#x27;</span>,</span><br><span class="line">	y_end string COMMENT <span class="string">&#x27;年结束日&#x27;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<p>–自然月: 指每月的1号到那个月的月底，它是按照阳历来计算的。就是从每月1号到月底，不管这个月有30天，31天，29天或者28天，都算是一个自然月。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dim_date</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> `<span class="type">date</span>`</span><br><span class="line"></span><br><span class="line">   , d_week <span class="comment">--年内第几周</span></span><br><span class="line"></span><br><span class="line">   , <span class="keyword">case</span> weekid</span><br><span class="line"></span><br><span class="line">​      <span class="keyword">when</span> <span class="number">0</span> <span class="keyword">then</span> <span class="string">&#x27;周日&#x27;</span></span><br><span class="line"></span><br><span class="line">​      <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">&#x27;周一&#x27;</span></span><br><span class="line"></span><br><span class="line">​      <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">&#x27;周二&#x27;</span></span><br><span class="line"></span><br><span class="line">​      <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">&#x27;周三&#x27;</span></span><br><span class="line"></span><br><span class="line">​      <span class="keyword">when</span> <span class="number">4</span> <span class="keyword">then</span> <span class="string">&#x27;周四&#x27;</span></span><br><span class="line"></span><br><span class="line">​      <span class="keyword">when</span> <span class="number">5</span> <span class="keyword">then</span> <span class="string">&#x27;周五&#x27;</span></span><br><span class="line"></span><br><span class="line">​      <span class="keyword">when</span> <span class="number">6</span> <span class="keyword">then</span> <span class="string">&#x27;周六&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">as</span> weeks <span class="comment">-- 周</span></span><br><span class="line"></span><br><span class="line">   , date_add(next_day(`<span class="type">date</span>`,<span class="string">&#x27;MO&#x27;</span>),<span class="number">-7</span>) <span class="keyword">as</span> w_start <span class="comment">--周一</span></span><br><span class="line"></span><br><span class="line">   , date_add(next_day(`<span class="type">date</span>`,<span class="string">&#x27;MO&#x27;</span>),<span class="number">-1</span>) <span class="keyword">as</span> w_end  <span class="comment">-- 周日_end</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">-- 月份日期</span></span><br><span class="line"></span><br><span class="line">   , concat(<span class="string">&#x27;第&#x27;</span>, monthid, <span class="string">&#x27;月&#x27;</span>) <span class="keyword">as</span> d_month</span><br><span class="line"></span><br><span class="line">   , m_start</span><br><span class="line"></span><br><span class="line">   , m_end</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">   <span class="comment">-- 季节</span></span><br><span class="line"></span><br><span class="line">   , quarterid <span class="keyword">as</span> d_quart</span><br><span class="line"></span><br><span class="line">   , concat(d_year, <span class="string">&#x27;-&#x27;</span>, substr(concat(<span class="string">&#x27;0&#x27;</span>, (quarterid <span class="operator">-</span> <span class="number">1</span>)  <span class="number">3</span> <span class="operator">+</span> <span class="number">1</span>), <span class="number">-2</span>), <span class="string">&#x27;-01&#x27;</span>) <span class="keyword">as</span> q_start <span class="comment">--季开始日</span></span><br><span class="line"></span><br><span class="line">   , date_sub(concat(d_year, <span class="string">&#x27;-&#x27;</span>, substr(concat(<span class="string">&#x27;0&#x27;</span>, (quarterid)  <span class="number">3</span> <span class="operator">+</span> <span class="number">1</span>), <span class="number">-2</span>), <span class="string">&#x27;-01&#x27;</span>), <span class="number">1</span>) <span class="keyword">as</span> q_end  <span class="comment">--季结束日</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">-- 年</span></span><br><span class="line"></span><br><span class="line">   , d_year</span><br><span class="line"></span><br><span class="line">   , y_start</span><br><span class="line"></span><br><span class="line">   , y_end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line"></span><br><span class="line">​     <span class="keyword">select</span> `<span class="type">date</span>`</span><br><span class="line"></span><br><span class="line">​       , pmod(datediff(`<span class="type">date</span>`, <span class="string">&#x27;2012-01-01&#x27;</span>), <span class="number">7</span>)         <span class="keyword">as</span> weekid  <span class="comment">--获取周几</span></span><br><span class="line"></span><br><span class="line">​       , <span class="built_in">cast</span>(substr(`<span class="type">date</span>`, <span class="number">6</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="type">int</span>)            <span class="keyword">as</span> monthid  <span class="comment">--获取月份</span></span><br><span class="line"></span><br><span class="line">​       , <span class="keyword">case</span></span><br><span class="line"></span><br><span class="line">​          <span class="keyword">when</span> <span class="built_in">cast</span>(substr(`<span class="type">date</span>`, <span class="number">6</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="type">int</span>) <span class="operator">&lt;=</span> <span class="number">3</span> <span class="keyword">then</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">​          <span class="keyword">when</span> <span class="built_in">cast</span>(substr(`<span class="type">date</span>`, <span class="number">6</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="type">int</span>) <span class="operator">&lt;=</span> <span class="number">6</span> <span class="keyword">then</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">​          <span class="keyword">when</span> <span class="built_in">cast</span>(substr(`<span class="type">date</span>`, <span class="number">6</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="type">int</span>) <span class="operator">&lt;=</span> <span class="number">9</span> <span class="keyword">then</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">​          <span class="keyword">when</span> <span class="built_in">cast</span>(substr(`<span class="type">date</span>`, <span class="number">6</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="type">int</span>) <span class="operator">&lt;=</span> <span class="number">12</span> <span class="keyword">then</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line">​       <span class="keyword">end</span>                            <span class="keyword">as</span> quarterid <span class="comment">--获取季节 可以直接使用 quarter(`date`)</span></span><br><span class="line"></span><br><span class="line">​       , substr(`<span class="type">date</span>`, <span class="number">1</span>, <span class="number">4</span>)                   <span class="keyword">as</span> d_year  <span class="comment">-- 获取年份</span></span><br><span class="line"></span><br><span class="line">​       , trunc(`<span class="type">date</span>`, <span class="string">&#x27;YYYY&#x27;</span>)                  <span class="keyword">as</span> y_start  <span class="comment">--年开始日</span></span><br><span class="line"></span><br><span class="line">​       , date_sub(trunc(add_months(`<span class="type">date</span>`, <span class="number">12</span>), <span class="string">&#x27;YYYY&#x27;</span>), <span class="number">1</span>) <span class="keyword">as</span> y_end   <span class="comment">--年结束日</span></span><br><span class="line"></span><br><span class="line">​       , date_sub(`<span class="type">date</span>`, dayofmonth(`<span class="type">date</span>`) <span class="operator">-</span> <span class="number">1</span>)         <span class="keyword">as</span> m_start  <span class="comment">--当月第一天</span></span><br><span class="line"></span><br><span class="line">​       , last_day(date_sub(`<span class="type">date</span>`, dayofmonth(`<span class="type">date</span>`) <span class="operator">-</span> <span class="number">1</span>))     m_end   <span class="comment">--当月最后一天</span></span><br><span class="line"></span><br><span class="line">​       , weekofyear(`<span class="type">date</span>`)                    <span class="keyword">as</span> d_week  <span class="comment">--年内第几周</span></span><br><span class="line"></span><br><span class="line">​     <span class="keyword">from</span> (</span><br><span class="line"></span><br><span class="line">​          <span class="comment">-- &#x27;2021-04-01&#x27;是开始日期, &#x27;2022-03-31&#x27;是截止日期</span></span><br><span class="line"></span><br><span class="line">​         <span class="keyword">select</span> date_add(<span class="string">&#x27;2021-04-01&#x27;</span>, t0.pos) <span class="keyword">as</span> `<span class="type">date</span>`</span><br><span class="line"></span><br><span class="line">​         <span class="keyword">from</span> (</span><br><span class="line"></span><br><span class="line">​              <span class="keyword">select</span> posexplode(</span><br><span class="line"></span><br><span class="line">​                     split(</span><br><span class="line"></span><br><span class="line">​                         repeat(<span class="string">&#x27;o&#x27;</span>, datediff(</span><br><span class="line"></span><br><span class="line">​                             from_unixtime(unix_timestamp(<span class="string">&#x27;2022-03-31&#x27;</span>, <span class="string">&#x27;yyyy-mm-dd&#x27;</span>),</span><br><span class="line"></span><br><span class="line">​                                    <span class="string">&#x27;yyyy-mm-dd&#x27;</span>),</span><br><span class="line"></span><br><span class="line">​                             <span class="string">&#x27;2021-04-01&#x27;</span>)), <span class="string">&#x27;o&#x27;</span></span><br><span class="line"></span><br><span class="line">​                       )</span><br><span class="line"></span><br><span class="line">​                   )</span><br><span class="line"></span><br><span class="line">​            ) t0</span><br><span class="line"></span><br><span class="line">​       ) t1</span><br><span class="line"></span><br><span class="line">   ) t2;</span><br></pre></td></tr></table></figure>



<h2 id="十七、时间序列–构造累积日期"><a href="#十七、时间序列–构造累积日期" class="headerlink" title="十七、时间序列–构造累积日期"></a>十七、时间序列–构造累积日期</h2><p>表名：t17</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">date_id</span><br><span class="line"></span><br><span class="line">2017-08-01</span><br><span class="line"></span><br><span class="line">2017-08-02</span><br><span class="line"></span><br><span class="line">2017-08-03</span><br></pre></td></tr></table></figure>



<h4 id="问题一：每一日期，都扩展成月初至当天"><a href="#问题一：每一日期，都扩展成月初至当天" class="headerlink" title="问题一：每一日期，都扩展成月初至当天"></a>问题一：每一日期，都扩展成月初至当天</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">date_id  date_to_day</span><br><span class="line"></span><br><span class="line">2017-08-01 2017-08-01</span><br><span class="line"></span><br><span class="line">2017-08-02 2017-08-01</span><br><span class="line"></span><br><span class="line">2017-08-02 2017-08-02</span><br><span class="line"></span><br><span class="line">2017-08-03 2017-08-01</span><br><span class="line"></span><br><span class="line">2017-08-03 2017-08-02</span><br><span class="line"></span><br><span class="line">2017-08-03 2017-08-03</span><br></pre></td></tr></table></figure>



<p>这种累积相关的表，常做桥接表。</p>
<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> date_id, date_add(date_start_id, pos) <span class="keyword">AS</span> date_to_day</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> date_id</span><br><span class="line">		, date_sub(date_id, dayofmonth(date_id) <span class="operator">-</span> <span class="number">1</span>) <span class="keyword">AS</span> date_start_id</span><br><span class="line">	<span class="keyword">FROM</span> t17</span><br><span class="line">) m</span><br><span class="line">	<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> posexplode(split(space(datediff(from_unixtime(unix_timestamp(date_id, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>)), from_unixtime(unix_timestamp(date_start_id, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>)))), <span class="string">&#x27;&#x27;</span>)) t <span class="keyword">AS</span> pos, val;</span><br></pre></td></tr></table></figure>



<h2 id="十八、时间序列–构造连续日期"><a href="#十八、时间序列–构造连续日期" class="headerlink" title="十八、时间序列–构造连续日期"></a>十八、时间序列–构造连续日期</h2><p>表名：t18</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">a       b     c</span><br><span class="line"></span><br><span class="line">101    2018-01-01   10</span><br><span class="line"></span><br><span class="line">101    2018-01-03   20</span><br><span class="line"></span><br><span class="line">101    2018-01-06   40</span><br><span class="line"></span><br><span class="line">102    2018-01-02   20</span><br><span class="line"></span><br><span class="line">102    2018-01-04   30</span><br><span class="line"></span><br><span class="line">102    2018-01-07   60</span><br></pre></td></tr></table></figure>



<h4 id="问题一：构造连续日期"><a href="#问题一：构造连续日期" class="headerlink" title="问题一：构造连续日期"></a>问题一：构造连续日期</h4><p>问题描述：将表中数据的b字段扩充至范围[2018-01-01, 2018-01-07]，并累积对c求和。</p>
<p>b字段的值是较稀疏的。</p>
<p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">a       b     c   d</span><br><span class="line"></span><br><span class="line">101    2018-01-01   10   10</span><br><span class="line"></span><br><span class="line">101    2018-01-02   0   10</span><br><span class="line"></span><br><span class="line">101    2018-01-03   20   30</span><br><span class="line"></span><br><span class="line">101    2018-01-04   0   30</span><br><span class="line"></span><br><span class="line">101    2018-01-05   0   30</span><br><span class="line"></span><br><span class="line">101    2018-01-06   40   70</span><br><span class="line"></span><br><span class="line">101    2018-01-07   0   70</span><br><span class="line"></span><br><span class="line">102    2018-01-01   0   0</span><br><span class="line"></span><br><span class="line">102    2018-01-02   20   20</span><br><span class="line"></span><br><span class="line">102    2018-01-03   0   20</span><br><span class="line"></span><br><span class="line">102    2018-01-04   30   50</span><br><span class="line"></span><br><span class="line">102    2018-01-05   0   50</span><br><span class="line"></span><br><span class="line">102    2018-01-06   0   50</span><br><span class="line"></span><br><span class="line">102    2018-01-07   60  110</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a, b, c</span><br><span class="line">	, <span class="built_in">sum</span>(c) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> b) <span class="keyword">AS</span> d</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> t1.a, t1.b</span><br><span class="line">		, <span class="keyword">CASE</span> </span><br><span class="line">			<span class="keyword">WHEN</span> t18.b <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span> t18.c</span><br><span class="line">			<span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line">		<span class="keyword">END</span> <span class="keyword">AS</span> c</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> a, date_add(s, pos) <span class="keyword">AS</span> b</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> a, <span class="string">&#x27;2018-01-01&#x27;</span> <span class="keyword">AS</span> s, <span class="string">&#x27;2018-01-07&#x27;</span> <span class="keyword">AS</span> r</span><br><span class="line">			<span class="keyword">FROM</span> (</span><br><span class="line">				<span class="keyword">SELECT</span> a</span><br><span class="line">				<span class="keyword">FROM</span> t18</span><br><span class="line">				<span class="keyword">GROUP</span> <span class="keyword">BY</span> a</span><br><span class="line">			) ta</span><br><span class="line">		) m</span><br><span class="line">			<span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> posexplode(split(space(datediff(from_unixtime(unix_timestamp(r, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>)), from_unixtime(unix_timestamp(s, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>)))), <span class="string">&#x27;&#x27;</span>)) t <span class="keyword">AS</span> pos, val</span><br><span class="line">	) t1</span><br><span class="line">		<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t18</span><br><span class="line">		<span class="keyword">ON</span> t1.a <span class="operator">=</span> t18.a</span><br><span class="line">			<span class="keyword">AND</span> t1.b <span class="operator">=</span> t18.b</span><br><span class="line">) ts;</span><br></pre></td></tr></table></figure>



<h2 id="十九、时间序列–取多个字段最新的值"><a href="#十九、时间序列–取多个字段最新的值" class="headerlink" title="十九、时间序列–取多个字段最新的值"></a>十九、时间序列–取多个字段最新的值</h2><p>表名：t19</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">date_id  a  b  c</span><br><span class="line"></span><br><span class="line">2014   AB 12  bc</span><br><span class="line"></span><br><span class="line">2015     23  </span><br><span class="line"></span><br><span class="line">2016        d</span><br><span class="line"></span><br><span class="line">2017   BC </span><br></pre></td></tr></table></figure>



<h4 id="问题一：如何一并取出最新日期"><a href="#问题一：如何一并取出最新日期" class="headerlink" title="问题一：如何一并取出最新日期"></a>问题一：如何一并取出最新日期</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">date_a  a  date_b  b  date_c  c</span><br><span class="line"></span><br><span class="line">2017  BC  2015   23  2016  d</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<p>此处给出三种解法，其一：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">		<span class="keyword">WHEN</span> rn_a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> date_id</span><br><span class="line">		<span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line">	<span class="keyword">END</span>) <span class="keyword">AS</span> date_a</span><br><span class="line">	, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">		<span class="keyword">WHEN</span> rn_a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> a</span><br><span class="line">		<span class="keyword">ELSE</span> <span class="keyword">NULL</span></span><br><span class="line">	<span class="keyword">END</span>) <span class="keyword">AS</span> a</span><br><span class="line">	, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">		<span class="keyword">WHEN</span> rn_b <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> date_id</span><br><span class="line">		<span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line">	<span class="keyword">END</span>) <span class="keyword">AS</span> date_b</span><br><span class="line">	, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">		<span class="keyword">WHEN</span> rn_b <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> b</span><br><span class="line">		<span class="keyword">ELSE</span> <span class="keyword">NULL</span></span><br><span class="line">	<span class="keyword">END</span>) <span class="keyword">AS</span> b</span><br><span class="line">	, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">		<span class="keyword">WHEN</span> rn_c <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> date_id</span><br><span class="line">		<span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line">	<span class="keyword">END</span>) <span class="keyword">AS</span> date_c</span><br><span class="line">	, <span class="built_in">max</span>(<span class="keyword">CASE</span> </span><br><span class="line">		<span class="keyword">WHEN</span> rn_c <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> c</span><br><span class="line">		<span class="keyword">ELSE</span> <span class="keyword">NULL</span></span><br><span class="line">	<span class="keyword">END</span>) <span class="keyword">AS</span> c</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> date_id, a, b, c <span class="comment">--对每列上不为null的值 的 日期 进行排序</span></span><br><span class="line">		, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">CASE</span> </span><br><span class="line">			<span class="keyword">WHEN</span> a <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">			<span class="keyword">ELSE</span> date_id</span><br><span class="line">		<span class="keyword">END</span> <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn_a, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">CASE</span> </span><br><span class="line">			<span class="keyword">WHEN</span> b <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">			<span class="keyword">ELSE</span> date_id</span><br><span class="line">		<span class="keyword">END</span> <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn_b</span><br><span class="line">		, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">CASE</span> </span><br><span class="line">			<span class="keyword">WHEN</span> c <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">			<span class="keyword">ELSE</span> date_id</span><br><span class="line">		<span class="keyword">END</span> <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn_c</span><br><span class="line">	<span class="keyword">FROM</span> t19</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> t.rn_a <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">	<span class="keyword">OR</span> t.rn_b <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">	<span class="keyword">OR</span> t.rn_c <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>



<p>其二：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.date_id, a.a, b.date_id, b.b, c.date_id</span><br><span class="line">	, c.c</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> t.date_id, t.a</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> t.date_id, t.a, t.b, t.c</span><br><span class="line">		<span class="keyword">FROM</span> t19 t</span><br><span class="line">			<span class="keyword">INNER</span> <span class="keyword">JOIN</span> t19 t1</span><br><span class="line">			<span class="keyword">ON</span> t.date_id <span class="operator">=</span> t1.date_id</span><br><span class="line">				<span class="keyword">AND</span> t.a <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">	) t</span><br><span class="line">	<span class="keyword">ORDER</span> <span class="keyword">BY</span> t.date_id <span class="keyword">DESC</span></span><br><span class="line">	LIMIT <span class="number">1</span></span><br><span class="line">) a</span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> t.date_id, t.b</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> t.date_id, t.b</span><br><span class="line">			<span class="keyword">FROM</span> t19 t</span><br><span class="line">				<span class="keyword">INNER</span> <span class="keyword">JOIN</span> t19 t1</span><br><span class="line">				<span class="keyword">ON</span> t.date_id <span class="operator">=</span> t1.date_id</span><br><span class="line">					<span class="keyword">AND</span> t.b <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">		) t</span><br><span class="line">		<span class="keyword">ORDER</span> <span class="keyword">BY</span> t.date_id <span class="keyword">DESC</span></span><br><span class="line">		LIMIT <span class="number">1</span></span><br><span class="line">	) b</span><br><span class="line">	<span class="keyword">ON</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> t.date_id, t.c</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> t.date_id, t.c</span><br><span class="line">			<span class="keyword">FROM</span> t19 t</span><br><span class="line">				<span class="keyword">INNER</span> <span class="keyword">JOIN</span> t19 t1</span><br><span class="line">				<span class="keyword">ON</span> t.date_id <span class="operator">=</span> t1.date_id</span><br><span class="line">					<span class="keyword">AND</span> t.c <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">		) t</span><br><span class="line">		<span class="keyword">ORDER</span> <span class="keyword">BY</span> t.date_id <span class="keyword">DESC</span></span><br><span class="line">		LIMIT <span class="number">1</span></span><br><span class="line">	) c</span><br><span class="line">	<span class="keyword">ON</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>



<p>其三：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> t1.date_id <span class="keyword">AS</span> date_a, t1.a</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> t1.date_id, t1.a</span><br><span class="line">		<span class="keyword">FROM</span> t19 t1</span><br><span class="line">		<span class="keyword">WHERE</span> t1.a <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">	) t1</span><br><span class="line">		<span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> <span class="built_in">max</span>(t1.date_id) <span class="keyword">AS</span> date_id</span><br><span class="line">			<span class="keyword">FROM</span> t19 t1</span><br><span class="line">			<span class="keyword">WHERE</span> t1.a <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">		) t2</span><br><span class="line">		<span class="keyword">ON</span> t1.date_id <span class="operator">=</span> t2.date_id</span><br><span class="line">) t1</span><br><span class="line">	<span class="keyword">CROSS</span> <span class="keyword">JOIN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> t1.date_b, t1.b</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> t1.date_id <span class="keyword">AS</span> date_b, t1.b</span><br><span class="line">			<span class="keyword">FROM</span> t19 t1</span><br><span class="line">			<span class="keyword">WHERE</span> t1.b <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">		) t1</span><br><span class="line">			<span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">				<span class="keyword">SELECT</span> <span class="built_in">max</span>(t1.date_id) <span class="keyword">AS</span> date_id</span><br><span class="line">				<span class="keyword">FROM</span> t19 t1</span><br><span class="line">				<span class="keyword">WHERE</span> t1.b <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">			) t2</span><br><span class="line">			<span class="keyword">ON</span> t1.date_b <span class="operator">=</span> t2.date_id</span><br><span class="line">	) t2</span><br><span class="line">	<span class="keyword">CROSS</span> <span class="keyword">JOIN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> t1.date_c, t1.c</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> t1.date_id <span class="keyword">AS</span> date_c, t1.c</span><br><span class="line">			<span class="keyword">FROM</span> t19 t1</span><br><span class="line">			<span class="keyword">WHERE</span> t1.c <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">		) t1</span><br><span class="line">			<span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">				<span class="keyword">SELECT</span> <span class="built_in">max</span>(t1.date_id) <span class="keyword">AS</span> date_id</span><br><span class="line">				<span class="keyword">FROM</span> t19 t1</span><br><span class="line">				<span class="keyword">WHERE</span> t1.c <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">			) t2</span><br><span class="line">			<span class="keyword">ON</span> t1.date_c <span class="operator">=</span> t2.date_id</span><br><span class="line">	) t3;</span><br></pre></td></tr></table></figure>



<h2 id="二十、时间序列–补全数据"><a href="#二十、时间序列–补全数据" class="headerlink" title="二十、时间序列–补全数据"></a>二十、时间序列–补全数据</h2><p>表名：t20</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">date_id  a  b  c</span><br><span class="line"></span><br><span class="line">2014   AB 12  bc</span><br><span class="line"></span><br><span class="line">2015     23  </span><br><span class="line"></span><br><span class="line">2016        d</span><br><span class="line"></span><br><span class="line">2017   BC </span><br></pre></td></tr></table></figure>



<h4 id="问题一：如何使用最新数据补全表格"><a href="#问题一：如何使用最新数据补全表格" class="headerlink" title="问题一：如何使用最新数据补全表格"></a>问题一：如何使用最新数据补全表格</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">date_id  a  b  c</span><br><span class="line"></span><br><span class="line">2014   AB 12  bc</span><br><span class="line"></span><br><span class="line">2015   AB 23  bc</span><br><span class="line"></span><br><span class="line">2016   AB 23  d</span><br><span class="line"></span><br><span class="line">2017   BC 23  d</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> date_id, <span class="built_in">first_value</span>(a) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> aa <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id) <span class="keyword">AS</span> a</span><br><span class="line">	, <span class="built_in">first_value</span>(b) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> bb <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id) <span class="keyword">AS</span> b</span><br><span class="line">	, <span class="built_in">first_value</span>(c) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cc <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id) <span class="keyword">AS</span> c</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> date_id, a, b, c</span><br><span class="line">		, <span class="built_in">count</span>(a) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id) <span class="keyword">AS</span> aa</span><br><span class="line">		, <span class="built_in">count</span>(b) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id) <span class="keyword">AS</span> bb</span><br><span class="line">		, <span class="built_in">count</span>(c) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id) <span class="keyword">AS</span> cc</span><br><span class="line">	<span class="keyword">FROM</span> t20</span><br><span class="line">) tmp1;</span><br></pre></td></tr></table></figure>



<h2 id="二十一、时间序列–取最新完成状态的前一个状态"><a href="#二十一、时间序列–取最新完成状态的前一个状态" class="headerlink" title="二十一、时间序列–取最新完成状态的前一个状态"></a>二十一、时间序列–取最新完成状态的前一个状态</h2><p>表名：t21</p>
<p>表字段及内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">date_id  a  b</span><br><span class="line"></span><br><span class="line">2014   1  A</span><br><span class="line"></span><br><span class="line">2015   1  B</span><br><span class="line"></span><br><span class="line">2016   1  A</span><br><span class="line"></span><br><span class="line">2017   1  B</span><br><span class="line"></span><br><span class="line">2013   2  A</span><br><span class="line"></span><br><span class="line">2014   2  B</span><br><span class="line"></span><br><span class="line">2015   2  A</span><br><span class="line"></span><br><span class="line">2014   3  A</span><br><span class="line"></span><br><span class="line">2015   3  A</span><br><span class="line"></span><br><span class="line">2016   3  B</span><br><span class="line"></span><br><span class="line">2017   3  A</span><br></pre></td></tr></table></figure>



<p>上表中B为完成状态。</p>
<h4 id="问题一：取最新完成状态的前一个状态"><a href="#问题一：取最新完成状态的前一个状态" class="headerlink" title="问题一：取最新完成状态的前一个状态"></a>问题一：取最新完成状态的前一个状态</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">date_id a  b</span><br><span class="line"></span><br><span class="line">2016   1  A</span><br><span class="line"></span><br><span class="line">2013   2  A</span><br><span class="line"></span><br><span class="line">2015   3  A</span><br></pre></td></tr></table></figure>



<p>参考答案:</p>
<p>此处给出两种解法，其一：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> t21.date_id, t21.a, t21.b</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">max</span>(date_id) <span class="keyword">AS</span> date_id, a</span><br><span class="line">	<span class="keyword">FROM</span> t21</span><br><span class="line">	<span class="keyword">WHERE</span> b <span class="operator">=</span> <span class="string">&#x27;B&#x27;</span></span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> a</span><br><span class="line">) t1</span><br><span class="line">	<span class="keyword">INNER</span> <span class="keyword">JOIN</span> t21</span><br><span class="line">	<span class="keyword">ON</span> t1.date_id <span class="operator">-</span> <span class="number">1</span> <span class="operator">=</span> t21.date_id</span><br><span class="line">		<span class="keyword">AND</span> t1.a <span class="operator">=</span> t21.a;</span><br></pre></td></tr></table></figure>



<p>其二：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> next_date_id <span class="keyword">AS</span> date_id, a, next_b <span class="keyword">AS</span> b</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="operator">*</span>, <span class="built_in">min</span>(nk) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a, b ) <span class="keyword">AS</span> minb</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> <span class="operator">*</span>, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id <span class="keyword">DESC</span>) <span class="keyword">AS</span> nk</span><br><span class="line">			, <span class="built_in">lead</span>(date_id) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id <span class="keyword">DESC</span>) <span class="keyword">AS</span> next_date_id</span><br><span class="line">			, <span class="built_in">lead</span>(b) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id <span class="keyword">DESC</span>) <span class="keyword">AS</span> next_b</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">			<span class="keyword">FROM</span> t21</span><br><span class="line">		) t</span><br><span class="line">	) t</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> minb <span class="operator">=</span> nk</span><br><span class="line">	<span class="keyword">AND</span> b <span class="operator">=</span> <span class="string">&#x27;B&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h4 id="问题二：如何将完成状态的过程合并"><a href="#问题二：如何将完成状态的过程合并" class="headerlink" title="问题二：如何将完成状态的过程合并"></a>问题二：如何将完成状态的过程合并</h4><p>输出结果如下所示:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a  b_merge</span><br><span class="line"></span><br><span class="line">1  A、B、A、B</span><br><span class="line"></span><br><span class="line">2  A、B</span><br><span class="line"></span><br><span class="line">3  A、A、B</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a, collect_list(b) <span class="keyword">AS</span> b</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">		, <span class="built_in">min</span>(if(b <span class="operator">=</span> <span class="string">&#x27;B&#x27;</span>, nk, <span class="keyword">NULL</span>)) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a ) <span class="keyword">AS</span> minb</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> <span class="operator">*</span>, <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> date_id <span class="keyword">DESC</span>) <span class="keyword">AS</span> nk</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">			<span class="keyword">FROM</span> t21</span><br><span class="line">		) t</span><br><span class="line">	) t</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> nk <span class="operator">&gt;=</span> minb</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a;</span><br></pre></td></tr></table></figure>



<h2 id="二十二、非等值连接–范围匹配"><a href="#二十二、非等值连接–范围匹配" class="headerlink" title="二十二、非等值连接–范围匹配"></a>二十二、非等值连接–范围匹配</h2><p>表f是事实表，表d是匹配表，在hive中如何将匹配表中的值关联到事实表中？</p>
<p>表d相当于拉链过的变化维，但日期范围可能是不全的。</p>
<p>表f：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">date_id p_id</span><br><span class="line"></span><br><span class="line"> 2017  C</span><br><span class="line"></span><br><span class="line"> 2018  B</span><br><span class="line"></span><br><span class="line"> 2019  A</span><br><span class="line"></span><br><span class="line"> 2013  C</span><br></pre></td></tr></table></figure>



<p>表d：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">d_start  d_end  p_id  p_value</span><br><span class="line"></span><br><span class="line"> 2016   2018   A    1</span><br><span class="line"></span><br><span class="line"> 2016   2018   B    2</span><br><span class="line"></span><br><span class="line"> 2008   2009   C    4</span><br><span class="line"></span><br><span class="line"> 2010   2015   C    3</span><br></pre></td></tr></table></figure>



<h4 id="问题一：范围匹配"><a href="#问题一：范围匹配" class="headerlink" title="问题一：范围匹配"></a>问题一：范围匹配</h4><p>输出结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">date_id p_id  p_value</span><br><span class="line"></span><br><span class="line"> 2017  C   null</span><br><span class="line"></span><br><span class="line"> 2018  B   2</span><br><span class="line"></span><br><span class="line"> 2019  A   null</span><br><span class="line"></span><br><span class="line"> 2013  C   3</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<p>此处给出两种解法，其一：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> f.date_id, f.p_id, A.p_value</span><br><span class="line"><span class="keyword">FROM</span> f</span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> date_id, p_id, p_value</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> f.date_id, f.p_id, d.p_value</span><br><span class="line">			<span class="keyword">FROM</span> f</span><br><span class="line">				<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> d <span class="keyword">ON</span> f.p_id <span class="operator">=</span> d.p_id</span><br><span class="line">			<span class="keyword">WHERE</span> f.date_id <span class="operator">&gt;=</span> d.d_start</span><br><span class="line">				<span class="keyword">AND</span> f.date_id <span class="operator">&lt;=</span> d.d_end</span><br><span class="line">		) A</span><br><span class="line">	) A</span><br><span class="line">	<span class="keyword">ON</span> f.date_id <span class="operator">=</span> A.date_id;</span><br></pre></td></tr></table></figure>



<p>其二：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> date_id, p_id, flag <span class="keyword">AS</span> p_value</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> f.date_id, f.p_id, d.d_start, d.d_end, d.p_value</span><br><span class="line">		, if(f.date_id <span class="keyword">BETWEEN</span> d.d_start <span class="keyword">AND</span> d.d_end, d.p_value, <span class="keyword">NULL</span>) <span class="keyword">AS</span> flag</span><br><span class="line">		, <span class="built_in">max</span>(d.d_end) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> date_id ) <span class="keyword">AS</span> max_end</span><br><span class="line">	<span class="keyword">FROM</span> f</span><br><span class="line">		<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> d <span class="keyword">ON</span> f.p_id <span class="operator">=</span> d.p_id</span><br><span class="line">) tmp</span><br><span class="line"><span class="keyword">WHERE</span> d_end <span class="operator">=</span> max_end;</span><br></pre></td></tr></table></figure>



<h2 id="二十三、非等值连接–最近匹配"><a href="#二十三、非等值连接–最近匹配" class="headerlink" title="二十三、非等值连接–最近匹配"></a>二十三、非等值连接–最近匹配</h2><p>表t23_1和表t23_2通过a和b关联时，有相等的取相等的值匹配，不相等时每一个a的值在b中找差值最小的来匹配。</p>
<p>t23_1和t23_2为两个班的成绩单，t23_1班的每个学生成绩在t23_2班中找出成绩最接近的成绩。</p>
<p>表t23_1：a中无重复值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">a</span><br><span class="line"></span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">2</span><br><span class="line"></span><br><span class="line">4</span><br><span class="line"></span><br><span class="line">5</span><br><span class="line"></span><br><span class="line">8</span><br><span class="line"></span><br><span class="line">10</span><br></pre></td></tr></table></figure>



<p>表t23_2：b中无重复值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">b</span><br><span class="line"></span><br><span class="line">2</span><br><span class="line"></span><br><span class="line">3</span><br><span class="line"></span><br><span class="line">7</span><br><span class="line"></span><br><span class="line">11</span><br><span class="line"></span><br><span class="line">13</span><br></pre></td></tr></table></figure>



<h4 id="问题一：单向最近匹配"><a href="#问题一：单向最近匹配" class="headerlink" title="问题一：单向最近匹配"></a>问题一：单向最近匹配</h4><p>输出结果如下所示：</p>
<p>注意：b的值可能会被丢弃</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">a  b</span><br><span class="line"></span><br><span class="line">1  2</span><br><span class="line"></span><br><span class="line">2  2</span><br><span class="line"></span><br><span class="line">4  3</span><br><span class="line"></span><br><span class="line">5  3</span><br><span class="line"></span><br><span class="line">5  7</span><br><span class="line"></span><br><span class="line">8  7</span><br><span class="line"></span><br><span class="line">10  11</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> ttt1.a, ttt1.b</span><br><span class="line">	<span class="keyword">FROM</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> tt1.a, t23_2.b, <span class="built_in">dense_rank</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> tt1.a <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="built_in">abs</span>(tt1.a <span class="operator">-</span> t23_2.b)) <span class="keyword">AS</span> dr</span><br><span class="line">		<span class="keyword">FROM</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> t23_1.a</span><br><span class="line">			<span class="keyword">FROM</span> t23_1</span><br><span class="line">				<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t23_2 <span class="keyword">ON</span> t23_1.a <span class="operator">=</span> t23_2.b</span><br><span class="line">			<span class="keyword">WHERE</span> t23_2.b <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line">		) tt1</span><br><span class="line">			<span class="keyword">CROSS</span> <span class="keyword">JOIN</span> t23_2</span><br><span class="line">	) ttt1</span><br><span class="line">	<span class="keyword">WHERE</span> ttt1.dr <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">	<span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">	<span class="keyword">SELECT</span> t23_1.a, t23_2.b</span><br><span class="line">	<span class="keyword">FROM</span> t23_1</span><br><span class="line">		<span class="keyword">INNER</span> <span class="keyword">JOIN</span> t23_2 <span class="keyword">ON</span> t23_1.a <span class="operator">=</span> t23_2.b</span><br><span class="line">) result_t</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> result_t.a;</span><br></pre></td></tr></table></figure>



<h2 id="二十四、N指标–累计去重"><a href="#二十四、N指标–累计去重" class="headerlink" title="二十四、N指标–累计去重"></a>二十四、N指标–累计去重</h2><p>假设表A为事件流水表，客户当天有一条记录则视为当天活跃。</p>
<p>表A：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> time_id     user_id</span><br><span class="line"></span><br><span class="line">2018-01-01 10:00:00  001</span><br><span class="line"></span><br><span class="line">2018-01-01 11:03:00  002</span><br><span class="line"></span><br><span class="line">2018-01-01 13:18:00  001</span><br><span class="line"></span><br><span class="line">2018-01-02 08:34:00  004</span><br><span class="line"></span><br><span class="line">2018-01-02 10:08:00  002</span><br><span class="line"></span><br><span class="line">2018-01-02 10:40:00  003</span><br><span class="line"></span><br><span class="line">2018-01-02 14:21:00  002</span><br><span class="line"></span><br><span class="line">2018-01-02 15:39:00  004</span><br><span class="line"></span><br><span class="line">2018-01-03 08:34:00  005</span><br><span class="line"></span><br><span class="line">2018-01-03 10:08:00  003</span><br><span class="line"></span><br><span class="line">2018-01-03 10:40:00  001</span><br><span class="line"></span><br><span class="line">2018-01-03 14:21:00  005</span><br></pre></td></tr></table></figure>



<p>假设客户活跃非常，一天产生的事件记录平均达千条。</p>
<h4 id="问题一：累计去重"><a href="#问题一：累计去重" class="headerlink" title="问题一：累计去重"></a>问题一：累计去重</h4><p>输出结果如下所示：</p>
<p>日期    当日活跃人数   月累计活跃人数_截至当日</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">date_id  user_cnt_act  user_cnt_act_month</span><br><span class="line"></span><br><span class="line">2018-01-01   2        2</span><br><span class="line"></span><br><span class="line">2018-01-02   3        4</span><br><span class="line"></span><br><span class="line">2018-01-03   3        5</span><br></pre></td></tr></table></figure>



<p>参考答案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> tt1.date_id ,</span><br><span class="line">       tt2.user_cnt_act ,</span><br><span class="line">       tt1.user_cnt_act_month</span><br><span class="line"><span class="keyword">FROM</span> (<span class="comment">-- ④ 按照t.date_id分组求出user_cnt_act_month，得到tt1</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">SELECT</span> t.date_id ,</span><br><span class="line">             <span class="built_in">COUNT</span>(user_id) <span class="keyword">AS</span> user_cnt_act_month</span><br><span class="line">      <span class="keyword">FROM</span> (<span class="comment">-- ③ 表a和表b进行笛卡尔积，按照a.date_id,b.user_id分组，保证截止到当日的用户唯一，得出表t。</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">SELECT</span> a.date_id ,</span><br><span class="line">                   b.user_id</span><br><span class="line">            <span class="keyword">FROM</span> (<span class="comment">-- ① 按照日期分组，取出date_id字段当主表的维度字段 得出表a</span></span><br><span class="line"></span><br><span class="line">                  <span class="keyword">SELECT</span> from_unixtime(unix_timestamp(time_id),<span class="string">&#x27;yyyy-MM-dd&#x27;</span>) <span class="keyword">AS</span> date_id</span><br><span class="line">                  <span class="keyword">FROM</span> test.temp_tanhaidi_20211213_1</span><br><span class="line">                  <span class="keyword">GROUP</span> <span class="keyword">BY</span> from_unixtime(unix_timestamp(time_id),<span class="string">&#x27;yyyy-MM-dd&#x27;</span>) ) a</span><br><span class="line">            <span class="keyword">INNER</span> <span class="keyword">JOIN</span> (<span class="comment">-- ② 按照date_id、user_id分组，保证每天每个用户只有一条记录，得出表b</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">SELECT</span> from_unixtime(unix_timestamp(time_id),<span class="string">&#x27;yyyy-MM-dd&#x27;</span>) <span class="keyword">AS</span> date_id ,</span><br><span class="line">                               user_id</span><br><span class="line">                        <span class="keyword">FROM</span> test.temp_tanhaidi_20211213_1</span><br><span class="line">                        <span class="keyword">GROUP</span> <span class="keyword">BY</span> from_unixtime(unix_timestamp(time_id),<span class="string">&#x27;yyyy-MM-dd&#x27;</span>) ,</span><br><span class="line">                                 user_id ) b <span class="keyword">ON</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">            <span class="keyword">WHERE</span> a.date_id <span class="operator">&gt;=</span> b.date_id</span><br><span class="line">            <span class="keyword">GROUP</span> <span class="keyword">BY</span> a.date_id ,</span><br><span class="line">                     b.user_id ) t</span><br><span class="line">      <span class="keyword">GROUP</span> <span class="keyword">BY</span> t.date_id) tt1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (<span class="comment">-- ⑥ 按照date_id分组求出user_cnt_act，得到tt2</span></span><br><span class="line"></span><br><span class="line">           <span class="keyword">SELECT</span> date_id ,</span><br><span class="line">                  <span class="built_in">COUNT</span>(user_id) <span class="keyword">AS</span> user_cnt_act</span><br><span class="line">           <span class="keyword">FROM</span> (<span class="comment">-- ⑤ 按照日期分组，取出date_id字段当主表的维度字段 得出表a</span></span><br><span class="line"></span><br><span class="line">                 <span class="keyword">SELECT</span> from_unixtime(unix_timestamp(time_id),<span class="string">&#x27;yyyy-MM-dd&#x27;</span>) <span class="keyword">AS</span> date_id ,</span><br><span class="line">                        user_id</span><br><span class="line">                 <span class="keyword">FROM</span> test.temp_tanhaidi_20211213_1</span><br><span class="line">                 <span class="keyword">GROUP</span> <span class="keyword">BY</span> from_unixtime(unix_timestamp(time_id),<span class="string">&#x27;yyyy-MM-dd&#x27;</span>) ,</span><br><span class="line">                          user_id ) a</span><br><span class="line">           <span class="keyword">GROUP</span> <span class="keyword">BY</span> date_id) tt2 <span class="keyword">ON</span> tt2.date_id <span class="operator">=</span> tt1.date_id</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://ylxlogan.top/2021/12/22/HIve%E4%B8%ADsql%E7%BB%83%E4%B9%A0/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HQL%E7%BB%83%E4%B9%A0/" rel="tag">HQL练习</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2021/12/23/MySQL%E6%9D%82%E8%AE%B0/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            MySQL杂记
          
        </div>
      </a>
    
    
      <a href="/2021/12/14/Apach%20Pulsar%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">消息模型Pulsar</div>
      </a>
    
  </nav>

   
<!-- valine评论 -->
<div id="vcomments-box">
  <div id="vcomments"></div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script>
<script>
  new Valine({
    el: "#vcomments",
    app_id: "GrJ0j9xyLU5BKd9RsgY4Xsub-gzGzoHsz",
    app_key: "JHTKI05eA7ieHmjdXeBqTVfz",
    path: window.location.pathname,
    avatar: "monsterid",
    placeholder: "给我的文章加点评论吧~",
    recordIP: true,
  });
  const infoEle = document.querySelector("#vcomments .info");
  if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
    infoEle.childNodes.forEach(function (item) {
      item.parentNode.removeChild(item);
    });
  }
</script>
<style>
  #vcomments-box {
    padding: 5px 30px;
  }

  @media screen and (max-width: 800px) {
    #vcomments-box {
      padding: 5px 0px;
    }
  }

  #vcomments-box #vcomments {
    background-color: #fff;
  }

  .v .vlist .vcard .vh {
    padding-right: 20px;
  }

  .v .vlist .vcard {
    padding-left: 10px;
  }
</style>

 
   
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2021-2022
        <i class="ri-heart-fill heart_icon"></i> Y-tim
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/logal.jpg" alt="Y-tim"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->
 
<script src="/js/clickBoom2.js"></script>
 
<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>